<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>平均负载 | wch的个人主页</title>
    <meta name="description" content="用于分享wch的学习笔记和项目~">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.74c45c5d.css" as="style"><link rel="preload" href="/assets/js/app.15a66b26.js" as="script"><link rel="preload" href="/assets/js/2.92cd0f37.js" as="script"><link rel="preload" href="/assets/js/26.16cf6f8a.js" as="script"><link rel="prefetch" href="/assets/js/10.1166f652.js"><link rel="prefetch" href="/assets/js/11.b6ae0b14.js"><link rel="prefetch" href="/assets/js/12.7802c7ba.js"><link rel="prefetch" href="/assets/js/13.63066938.js"><link rel="prefetch" href="/assets/js/14.1f9fa0d5.js"><link rel="prefetch" href="/assets/js/15.6c758eca.js"><link rel="prefetch" href="/assets/js/16.58440a84.js"><link rel="prefetch" href="/assets/js/17.1e1f5c53.js"><link rel="prefetch" href="/assets/js/18.28115609.js"><link rel="prefetch" href="/assets/js/19.7e395424.js"><link rel="prefetch" href="/assets/js/20.2c2ea5f8.js"><link rel="prefetch" href="/assets/js/21.1e8ef167.js"><link rel="prefetch" href="/assets/js/22.47a8f5b7.js"><link rel="prefetch" href="/assets/js/23.f507c548.js"><link rel="prefetch" href="/assets/js/24.b19f43b8.js"><link rel="prefetch" href="/assets/js/25.5b1882b0.js"><link rel="prefetch" href="/assets/js/27.6f3498d0.js"><link rel="prefetch" href="/assets/js/28.f56b7e3c.js"><link rel="prefetch" href="/assets/js/29.de1da78b.js"><link rel="prefetch" href="/assets/js/3.73d3287d.js"><link rel="prefetch" href="/assets/js/30.108b25a0.js"><link rel="prefetch" href="/assets/js/31.68af7d35.js"><link rel="prefetch" href="/assets/js/32.c9f05837.js"><link rel="prefetch" href="/assets/js/33.13bd6f64.js"><link rel="prefetch" href="/assets/js/34.59041fd7.js"><link rel="prefetch" href="/assets/js/35.4382a261.js"><link rel="prefetch" href="/assets/js/36.01d6324a.js"><link rel="prefetch" href="/assets/js/37.22e4179e.js"><link rel="prefetch" href="/assets/js/38.f553994e.js"><link rel="prefetch" href="/assets/js/39.a72bb5df.js"><link rel="prefetch" href="/assets/js/4.9a52aae5.js"><link rel="prefetch" href="/assets/js/40.3751cd34.js"><link rel="prefetch" href="/assets/js/41.d351ec5d.js"><link rel="prefetch" href="/assets/js/42.b87a3eae.js"><link rel="prefetch" href="/assets/js/43.7035de8a.js"><link rel="prefetch" href="/assets/js/44.2c18f0bc.js"><link rel="prefetch" href="/assets/js/45.52905280.js"><link rel="prefetch" href="/assets/js/46.abb047a4.js"><link rel="prefetch" href="/assets/js/47.2ac230d3.js"><link rel="prefetch" href="/assets/js/48.b63bb42b.js"><link rel="prefetch" href="/assets/js/49.35752ae9.js"><link rel="prefetch" href="/assets/js/5.36029518.js"><link rel="prefetch" href="/assets/js/50.b6bd912f.js"><link rel="prefetch" href="/assets/js/51.0e0db65f.js"><link rel="prefetch" href="/assets/js/52.d15fb17a.js"><link rel="prefetch" href="/assets/js/53.844345be.js"><link rel="prefetch" href="/assets/js/54.52685e8c.js"><link rel="prefetch" href="/assets/js/55.83a99fe0.js"><link rel="prefetch" href="/assets/js/56.fe26d3a3.js"><link rel="prefetch" href="/assets/js/57.dae36566.js"><link rel="prefetch" href="/assets/js/58.1bfd28b1.js"><link rel="prefetch" href="/assets/js/59.88f55364.js"><link rel="prefetch" href="/assets/js/6.d3b55a54.js"><link rel="prefetch" href="/assets/js/7.af0443ed.js"><link rel="prefetch" href="/assets/js/8.2c9a7ea2.js"><link rel="prefetch" href="/assets/js/9.c08dcf83.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74c45c5d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">wch的个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java虚拟机</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/jvm/深入理解Java虚拟机（一）：自动内存管理机制.html" class="sidebar-link">深入理解Java虚拟机（一）：自动内存管理机制</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java并发编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis 源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring Security 源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微信小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Elasticsearch</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="平均负载"><a href="#平均负载" class="header-anchor">#</a> 平均负载</h2> <p>平均负载是指单位时间内，系统处于<strong>可运行状态</strong>和<strong>不可中断状态</strong>的平均进程数，也就是<strong>平均活跃进程数</strong>。</p> <h3 id="uptime-命令"><a href="#uptime-命令" class="header-anchor">#</a> uptime 命令</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">uptime</span>
02:34:03 up <span class="token number">2</span> days, <span class="token number">20</span>:14,  <span class="token number">1</span> user,  load average: <span class="token number">0.63</span>, <span class="token number">0.83</span>, <span class="token number">0.88</span>
</code></pre></div><p>使用 <code>uptime</code> 命令可以查看过去1分钟、5分钟、15分钟的平均负载（<code>Load Average</code>）。</p> <h3 id="查看-cpu-个数"><a href="#查看-cpu-个数" class="header-anchor">#</a> 查看 CPU 个数</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">grep</span> <span class="token string">'model name'</span> /proc/cpuinfo <span class="token operator">|</span> <span class="token function">wc</span> -l
</code></pre></div><p>如果平均负载大于 <code>CPU</code> 个数，那么说明系统已经过载。</p> <h3 id="平均负载与-cpu-使用率"><a href="#平均负载与-cpu-使用率" class="header-anchor">#</a> 平均负载与 CPU 使用率</h3> <p>平均负载统计的不仅是正在使用 <code>CPU</code> 的进程，还包括等待 <code>CPU</code> 和等待 <code>I/O</code> 的进程，对于 <code>CPU</code> 密集型进程来说两者是一致的；对于 <code>I/O</code> 密集型进程则不一定。</p> <h3 id="cpu-使用率情况"><a href="#cpu-使用率情况" class="header-anchor">#</a> CPU 使用率情况</h3> <p>通过 <code>mpstat</code> 命令查看  <code>%usr</code> 和 <code>%iowait</code> 列的 <code>CPU</code> 使用率判断当前系统负载高是由 <code>CPU</code> 运算还是 <code>iowait</code> 引起的。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 监控所有 CPU，间隔5秒输出一组数据</span>
mpstat -P ALL <span class="token number">5</span>
</code></pre></div><p>通过 <code>pidstat</code> 命令查看导致 <code>CPU</code> 使用率升高的进程。<code>%wait</code> 显示进程等待 <code>CPU</code> 的时间。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 间隔5秒后输出一组数据，-u表示CPU指标</span>
pidstat -u <span class="token number">5</span> <span class="token number">1</span>
</code></pre></div><h2 id="cpu-上下文"><a href="#cpu-上下文" class="header-anchor">#</a> CPU 上下文</h2> <p><code>CPU</code> 上下文指任务运行前依赖的寄存器和程序计数器。寄存器是 <code>CPU</code> 内置的容量小、速度快的内存；程序计数器则是用来存储 <code>CPU</code> 正在执行的指令位置，或者即将执行的下一条指令位置。</p> <h3 id="cpu-上下文切换"><a href="#cpu-上下文切换" class="header-anchor">#</a> CPU 上下文切换</h3> <p><code>CPU</code> 上下文切换指的是将上一个任务的 <code>CPU</code> 上下文保存起来，然后加载新任务的上下文。</p> <p>过多的上下文切换，会把 <code>CPU</code> 时间消耗在寄存器、内核栈以及虚拟内存等数据的保存和恢复上，从而缩短进程真正运行的时间，导致系统的整体性能大幅下降。</p> <p>根据任务的不同，<code>CPU</code> 的上下文切换就可以分为几个不同的场景，也就是<strong>进程上下文切换</strong>、<strong>线程上下文切换</strong>以及<strong>中断上下文切换</strong>。</p> <h4 id="进程上下文切换"><a href="#进程上下文切换" class="header-anchor">#</a> 进程上下文切换</h4> <p>进程上下文切换会涉及寄存器、内核栈以及虚拟内存等数据的保存和恢复。</p> <ul><li>为了保证所有进程可以得到公平调度，CPU时间被划分为一段段的时间片，这些时间片再被轮流分配给各个进程。这样，当某个进程的时间片耗尽了，就会被系统挂起，切换到其它正在等待 CPU 的进程运行。</li> <li>进程在系统资源不足（比如内存不足）时，要等到资源满足后才可以运行，这个时候进程也会被挂起，并由系统调度其他进程运行。</li> <li>当进程通过睡眠函数 <code>sleep</code> 这样的方法将自己主动挂起时，自然也会重新调度。</li> <li>当有优先级更高的进程运行时，为了保证高优先级进程的运行，当前进程会被挂起，由高优先级进程来运行。</li> <li>发生硬件中断时，CPU上的进程会被中断挂起，转而执行内核中的中断服务程序。</li></ul> <h4 id="线程上下文切换"><a href="#线程上下文切换" class="header-anchor">#</a> 线程上下文切换</h4> <ul><li>当进程拥有多个线程时，这些线程会共享相同的虚拟内存和全局变量等资源，这些资源在上下文切换时是不需要修改的。</li> <li>前后两个线程属于不同进程时，因为资源不共享，所以切换过程跟进程上下文切换是一样。</li> <li>前后两个线程属于同一个进程时，因为虚拟内存是共享的，所以在切换时，虚拟内存这些资源就保持不动，只需要切换线程的私有数据、寄存器等不共享的数据。</li></ul> <h4 id="中断上下文切换"><a href="#中断上下文切换" class="header-anchor">#</a> 中断上下文切换</h4> <p>为了快速响应硬件事件，中断处理会打断进程的正常调度和执行，转而调用中断处理程序，响应设备事件。对于同一个 <code>CPU</code> 来说，中断处理比进程拥有更高的优先级，所以中断上下文切换并不会与进程上下文切换同时发生。</p> <h3 id="查看-cpu-上下文切换情况"><a href="#查看-cpu-上下文切换情况" class="header-anchor">#</a> 查看 CPU 上下文切换情况</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 查看CPU上下文切换情况，间隔1秒输出1组数据</span>
<span class="token function">vmstat</span> <span class="token number">1</span>
</code></pre></div><p><code>cs(context switch)</code> 列显示每秒上下文切换次数、<code>in(interupt)</code> 列显示每秒中断次数、<code>r(Running or Runnable)</code> 是就绪队列的长度，即正在运行和等待 <code>CPU</code> 的进程数、<code>b(blocked)</code> 则是处于不可中断睡眠状态的进程数。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 查看进程上下文切换情况，间隔5秒输出1组数据</span>
pidstat -w <span class="token number">5</span>
</code></pre></div><p><code>cswch</code> 列表示自愿上下文切换，即进程无法获取所需资源（<code>I/O</code>、内存等），导致的上下文切换。</p> <p><code>nvcswch</code> 列表示非资源上下文切换，即时间片已到等原因被系统强制调度，进而发生上下文切换。</p> <h2 id="定位-cpu-使用率过高"><a href="#定位-cpu-使用率过高" class="header-anchor">#</a> 定位 CPU 使用率过高</h2> <p>使用 <code>top</code> 命令查看当前各进程 <code>CPU</code>、内存等使用情况：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">top</span> - 04:15:22 up <span class="token number">13</span>:51,  <span class="token number">2</span> users,  load average: <span class="token number">0.01</span>, <span class="token number">0.04</span>, <span class="token number">0.05</span>
Tasks: <span class="token number">124</span> total,   <span class="token number">1</span> running, <span class="token number">123</span> sleeping,   <span class="token number">0</span> stopped,   <span class="token number">0</span> zombie
%Cpu<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:  <span class="token number">0.2</span> us,  <span class="token number">0.3</span> sy,  <span class="token number">0.0</span> ni, <span class="token number">99.5</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">0.0</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st
KiB Mem <span class="token builtin class-name">:</span>  <span class="token number">7990124</span> total,  <span class="token number">3514012</span> free,  <span class="token number">3146764</span> used,  <span class="token number">1329348</span> buff/cache
KiB Swap:  <span class="token number">5242876</span> total,  <span class="token number">5242876</span> free,        <span class="token number">0</span> used.  <span class="token number">4554532</span> avail Mem

   PID <span class="token environment constant">USER</span>      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
 <span class="token number">11920</span> <span class="token number">1000</span>      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">4734688</span> <span class="token number">997</span>.3m  <span class="token number">16744</span> S   <span class="token number">0.7</span> <span class="token number">12.8</span>   <span class="token number">4</span>:28.48 java
</code></pre></div><p>功能键：</p> <ul><li><code>1</code>：切换查看每个 <code>CPU</code> 的指标。</li> <li><code>M</code>：按内存使用大小排序。</li> <li><code>P</code>：按 <code>CPU</code> 使用率排序。</li> <li><code>H</code>：查询线程指标。</li></ul> <p>定位到 <code>CPU</code> 使用率高的线程后通过 <code>top -Hp pid</code> 查看指定进程下的所有线程指标，找到使用率最高的线程，获取线程 <code>tid</code>。退出 <code>top</code>，使用 <code>printf %x\n% tid</code> 获取十六进制线程号并查看此线程的执行栈：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>jstack pid <span class="token operator">|</span> <span class="token function">grep</span> hex -A <span class="token number">20</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.15a66b26.js" defer></script><script src="/assets/js/2.92cd0f37.js" defer></script><script src="/assets/js/26.16cf6f8a.js" defer></script>
  </body>
</html>

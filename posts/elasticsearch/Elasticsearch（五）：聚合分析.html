<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Elasticsearch（五）：聚合分析 | wch的个人主页</title>
    <meta name="description" content="用于分享wch的学习笔记和项目~">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.74c45c5d.css" as="style"><link rel="preload" href="/assets/js/app.15a66b26.js" as="script"><link rel="preload" href="/assets/js/2.92cd0f37.js" as="script"><link rel="preload" href="/assets/js/15.6c758eca.js" as="script"><link rel="prefetch" href="/assets/js/10.1166f652.js"><link rel="prefetch" href="/assets/js/11.b6ae0b14.js"><link rel="prefetch" href="/assets/js/12.7802c7ba.js"><link rel="prefetch" href="/assets/js/13.63066938.js"><link rel="prefetch" href="/assets/js/14.1f9fa0d5.js"><link rel="prefetch" href="/assets/js/16.58440a84.js"><link rel="prefetch" href="/assets/js/17.1e1f5c53.js"><link rel="prefetch" href="/assets/js/18.28115609.js"><link rel="prefetch" href="/assets/js/19.7e395424.js"><link rel="prefetch" href="/assets/js/20.2c2ea5f8.js"><link rel="prefetch" href="/assets/js/21.1e8ef167.js"><link rel="prefetch" href="/assets/js/22.47a8f5b7.js"><link rel="prefetch" href="/assets/js/23.f507c548.js"><link rel="prefetch" href="/assets/js/24.b19f43b8.js"><link rel="prefetch" href="/assets/js/25.5b1882b0.js"><link rel="prefetch" href="/assets/js/26.16cf6f8a.js"><link rel="prefetch" href="/assets/js/27.6f3498d0.js"><link rel="prefetch" href="/assets/js/28.f56b7e3c.js"><link rel="prefetch" href="/assets/js/29.de1da78b.js"><link rel="prefetch" href="/assets/js/3.73d3287d.js"><link rel="prefetch" href="/assets/js/30.108b25a0.js"><link rel="prefetch" href="/assets/js/31.68af7d35.js"><link rel="prefetch" href="/assets/js/32.c9f05837.js"><link rel="prefetch" href="/assets/js/33.13bd6f64.js"><link rel="prefetch" href="/assets/js/34.59041fd7.js"><link rel="prefetch" href="/assets/js/35.4382a261.js"><link rel="prefetch" href="/assets/js/36.01d6324a.js"><link rel="prefetch" href="/assets/js/37.22e4179e.js"><link rel="prefetch" href="/assets/js/38.f553994e.js"><link rel="prefetch" href="/assets/js/39.a72bb5df.js"><link rel="prefetch" href="/assets/js/4.9a52aae5.js"><link rel="prefetch" href="/assets/js/40.3751cd34.js"><link rel="prefetch" href="/assets/js/41.d351ec5d.js"><link rel="prefetch" href="/assets/js/42.b87a3eae.js"><link rel="prefetch" href="/assets/js/43.7035de8a.js"><link rel="prefetch" href="/assets/js/44.2c18f0bc.js"><link rel="prefetch" href="/assets/js/45.52905280.js"><link rel="prefetch" href="/assets/js/46.abb047a4.js"><link rel="prefetch" href="/assets/js/47.2ac230d3.js"><link rel="prefetch" href="/assets/js/48.b63bb42b.js"><link rel="prefetch" href="/assets/js/49.35752ae9.js"><link rel="prefetch" href="/assets/js/5.36029518.js"><link rel="prefetch" href="/assets/js/50.b6bd912f.js"><link rel="prefetch" href="/assets/js/51.0e0db65f.js"><link rel="prefetch" href="/assets/js/52.d15fb17a.js"><link rel="prefetch" href="/assets/js/53.844345be.js"><link rel="prefetch" href="/assets/js/54.52685e8c.js"><link rel="prefetch" href="/assets/js/55.83a99fe0.js"><link rel="prefetch" href="/assets/js/56.fe26d3a3.js"><link rel="prefetch" href="/assets/js/57.dae36566.js"><link rel="prefetch" href="/assets/js/58.1bfd28b1.js"><link rel="prefetch" href="/assets/js/59.88f55364.js"><link rel="prefetch" href="/assets/js/6.d3b55a54.js"><link rel="prefetch" href="/assets/js/7.af0443ed.js"><link rel="prefetch" href="/assets/js/8.2c9a7ea2.js"><link rel="prefetch" href="/assets/js/9.c08dcf83.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74c45c5d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">wch的个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java虚拟机</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java并发编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis 源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring Security 源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微信小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Elasticsearch</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/elasticsearch/Elasticsearch（一）：概念与基本API.html" class="sidebar-link">Elasticsearch（一）：概念与基本API</a></li><li><a href="/posts/elasticsearch/Elasticsearch（二）：SearchAPI.html" class="sidebar-link">Elasticsearch（二）：SearchAPI</a></li><li><a href="/posts/elasticsearch/Elasticsearch（三）：集群特性.html" class="sidebar-link">Elasticsearch（三）：集群特性</a></li><li><a href="/posts/elasticsearch/Elasticsearch（四）：Search运行机制.html" class="sidebar-link">Elasticsearch（四）：Search运行机制</a></li><li><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html" class="active sidebar-link">Elasticsearch（五）：聚合分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#metric" class="sidebar-link">metric</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#min-max-sum-avg" class="sidebar-link">min / max / sum / avg</a></li><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#cardinality" class="sidebar-link">cardinality</a></li><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#stats" class="sidebar-link">stats</a></li><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#extended-stats" class="sidebar-link">extended_stats</a></li><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#percentiles" class="sidebar-link">percentiles</a></li><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#percentile-ranks" class="sidebar-link">percentile_ranks</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#bucket" class="sidebar-link">bucket</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#term" class="sidebar-link">term</a></li><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#range" class="sidebar-link">range</a></li><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#historgram" class="sidebar-link">historgram</a></li><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#date-histogram" class="sidebar-link">date_histogram</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#pipeline" class="sidebar-link">pipeline</a></li><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#作用范围" class="sidebar-link">作用范围</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#为某个聚合分析设定过滤条件" class="sidebar-link">为某个聚合分析设定过滤条件</a></li><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#聚合分析后过滤" class="sidebar-link">聚合分析后过滤</a></li><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#忽略-query" class="sidebar-link">忽略 query</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#排序" class="sidebar-link">排序</a></li><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#聚合精准度问题" class="sidebar-link">聚合精准度问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/elasticsearch/Elasticsearch（五）：聚合分析.html#shard-size" class="sidebar-link">shard_size</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="elasticsearch（五）：聚合分析"><a href="#elasticsearch（五）：聚合分析" class="header-anchor">#</a> Elasticsearch（五）：聚合分析</h1> <p><code>es</code> 中的聚合分析主要分为：</p> <ul><li><code>metric</code>：指标分析类型，如最值、平均值等等。</li> <li><code>bucket</code>：分桶类型，类似 <code>group by</code>。</li> <li><code>pipeline</code>：管道分析，基于上一级聚合分析结果进行再分析。</li></ul> <h2 id="metric"><a href="#metric" class="header-anchor">#</a> metric</h2> <h3 id="min-max-sum-avg"><a href="#min-max-sum-avg" class="header-anchor">#</a> min / max / sum / avg</h3> <p><code>min / max / sum / avg</code> 分别用于统计最小值、最大值、求和、平均值：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;min_age&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;min&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;max_age&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;max&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;sum_age&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;sum&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;avg_age&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;avg&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="cardinality"><a href="#cardinality" class="header-anchor">#</a> cardinality</h3> <p><code>cardinality</code> 用于获取字段不同数值的个数，即 <code>distinct count</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;cardinality_age&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;cardinality&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="stats"><a href="#stats" class="header-anchor">#</a> stats</h3> <p><code>stats</code> 用于统计一系列指标，包括 <code>min / max / sum / avg / count</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;stats_age&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;stats&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="extended-stats"><a href="#extended-stats" class="header-anchor">#</a> extended_stats</h3> <p><code>extended_stats</code> 相对于 <code>stats</code> 提供更多指标，如方差、标准差等：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;stats_age&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;extended_stats&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="percentiles"><a href="#percentiles" class="header-anchor">#</a> percentiles</h3> <p><code>percentiles</code> 用于百分位统计，默认统计 <code>1,5,25,50,75,95,99</code> 分位点，通过 <code>percents</code> 参数可以指定要计算的分位点：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;percentiles_age&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;percentiles&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;percents&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token number">50</span><span class="token punctuation">,</span>
          <span class="token number">75</span><span class="token punctuation">,</span>
          <span class="token number">95</span><span class="token punctuation">,</span>
          <span class="token number">99</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="percentile-ranks"><a href="#percentile-ranks" class="header-anchor">#</a> percentile_ranks</h3> <p><code>percentile_ranks</code> 用于获取指定数值对应的分位点，通过 <code>values</code> 参数指定：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;percentiles_ranks_age&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;percentile_ranks&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;values&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token number">19</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="bucket"><a href="#bucket" class="header-anchor">#</a> bucket</h2> <h3 id="term"><a href="#term" class="header-anchor">#</a> term</h3> <p><code>term</code> 指按词分桶，结果中的 <code>buckets</code> 会给出统计出的不同词及对应的文档个数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;job&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;terms&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;job.keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ...</span>
  <span class="token string">&quot;aggregations&quot;</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;job&quot;</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;doc_count_error_upper_bound&quot;</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string">&quot;sum_other_doc_count&quot;</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string">&quot;buckets&quot;</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">&quot;key&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;c++&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;doc_count&quot;</span> <span class="token punctuation">:</span> <span class="token number">2</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token string">&quot;key&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;Java junior engineer&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;doc_count&quot;</span> <span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token string">&quot;key&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;doc_count&quot;</span> <span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token string">&quot;key&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;js&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;doc_count&quot;</span> <span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token comment">// ..</span>
</code></pre></div><p>通过使用 <code>top_hits</code> 能够额外获取每个桶中对应的文档内容，支持排序：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;job&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;terms&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;job.keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;top&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;top_hits&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
            <span class="token string">&quot;sort&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
              <span class="token string">&quot;birth&quot;</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="range"><a href="#range" class="header-anchor">#</a> range</h3> <p><code>range</code> 指定数值范围来设定分桶规则，支持使用 <code>key</code> 参数指定聚合结果名称：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;age_range&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;range&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;ranges&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token string">&quot;key&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;lt 20&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;to&quot;</span><span class="token punctuation">:</span> <span class="token number">20</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token string">&quot;from&quot;</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
            <span class="token string">&quot;to&quot;</span><span class="token punctuation">:</span> <span class="token number">30</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token string">&quot;key&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;gt 30&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;from&quot;</span><span class="token punctuation">:</span> <span class="token number">30</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>range</code> 同样支持日期类的范围统计，通过 <code>format</code> 参数指定返回的日期格式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;birth_range&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;range&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;birth&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;format&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;yyyy&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;ranges&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token string">&quot;to&quot;</span><span class="token punctuation">:</span> <span class="token number">1990</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token string">&quot;from&quot;</span><span class="token punctuation">:</span> <span class="token number">1990</span><span class="token punctuation">,</span>
            <span class="token string">&quot;to&quot;</span><span class="token punctuation">:</span> <span class="token number">2000</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token string">&quot;from&quot;</span><span class="token punctuation">:</span> <span class="token number">2000</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="historgram"><a href="#historgram" class="header-anchor">#</a> historgram</h3> <p><code>historgram</code> 用以指定间隔分隔数据，<code>interval</code> 参数指定间隔大小，<code>extended_bounds</code> 参数指定间隔分隔的范围：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;age_histogram&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;histogram&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;interval&quot;</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        <span class="token string">&quot;extended_bounds&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;min&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
          <span class="token string">&quot;max&quot;</span><span class="token punctuation">:</span> <span class="token number">100</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="date-histogram"><a href="#date-histogram" class="header-anchor">#</a> date_histogram</h3> <p><code>date_histogram</code> 是针对日期间隔的统计：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;birth_date_histogram&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;date_histogram&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;birth&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;calendar_interval&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;year&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;format&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;yyyy&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="pipeline"><a href="#pipeline" class="header-anchor">#</a> pipeline</h2> <p><code>pipeline</code> 针对聚合统计结果进行再分析，通过 <code>buckets_path</code> 参数指定需要再分析的指标：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;job&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;terms&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;job.keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;avg_age&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;avg&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;age&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;max_avg_age_by_job&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;max_bucket&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;buckets_path&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;job&gt;avg_age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="作用范围"><a href="#作用范围" class="header-anchor">#</a> 作用范围</h2> <p>聚合分析默认作用范围是 <code>query</code> 查询语句的结果集，<code>es</code> 提供一系列方式改变聚合分析的作用范围。</p> <h3 id="为某个聚合分析设定过滤条件"><a href="#为某个聚合分析设定过滤条件" class="header-anchor">#</a> 为某个聚合分析设定过滤条件</h3> <p>先使用 <code>filter</code> 指定当前聚合分析的过滤条件，在子查询中输入真正的聚合语句：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;age_over20_job&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;filter&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;range&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;age&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;gte&quot;</span><span class="token punctuation">:</span> <span class="token number">20</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;job&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;terms&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;job.keyword&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="聚合分析后过滤"><a href="#聚合分析后过滤" class="header-anchor">#</a> 聚合分析后过滤</h3> <p>如果需要在聚合分析出全部结果后控制返回的文档结果，可以使用 <code>post_filter</code> 来做过滤。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;job&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;terms&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;job.keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;post_filter&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;age&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;18&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="忽略-query"><a href="#忽略-query" class="header-anchor">#</a> 忽略 query</h3> <p>如果需要忽略 <code>query</code> 对聚合分析的影响，通过 <code>global</code> 参数指定无视 <code>query</code> 过滤条件，基于全部文档进行分析，并在子查询中输入真正的聚合语句。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;job.keyword&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;js&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> 
  <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;all&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;global&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;job&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;terms&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;job.keyword&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="排序"><a href="#排序" class="header-anchor">#</a> 排序</h2> <p>聚合分析中的排序默认是按各统计结果的数量倒序排序的，同时可以指定子查询结果作为排序依据：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;job&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;terms&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;job.keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;size&quot;</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token string">&quot;order&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;avg_age&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;asc&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;aggs&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;avg_age&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;avg&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;age&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="聚合精准度问题"><a href="#聚合精准度问题" class="header-anchor">#</a> 聚合精准度问题</h2> <p>对于 <code>terms</code> 类型的聚合，每个分片会按数量倒序排序后返回前 <code>size</code> 个结果，在整合时可能会导致不准确。聚合分析结果有两个指标说明潜在的遗漏问题：</p> <ul><li><code>doc_count_error_upper_bound</code>：各分片被遗漏的 <code>term</code> 的最大值的总和。</li> <li><code>sum_other_doc_count</code>：各分片返回的未被最终结果使用的其它聚合统计总数。</li></ul> <h3 id="shard-size"><a href="#shard-size" class="header-anchor">#</a> shard_size</h3> <p><code>shard_size</code> 参数用于指定分片实际返回的统计指标数量，默认为 <code>size * 1.5 + 10</code>。通过调整 <code>shard_size</code> 可以尽量减小聚合统计的误差。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/posts/elasticsearch/Elasticsearch（四）：Search运行机制.html" class="prev">Elasticsearch（四）：Search运行机制</a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.15a66b26.js" defer></script><script src="/assets/js/2.92cd0f37.js" defer></script><script src="/assets/js/15.6c758eca.js" defer></script>
  </body>
</html>

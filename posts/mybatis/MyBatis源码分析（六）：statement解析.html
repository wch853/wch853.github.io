<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MyBatis 源码分析（六）：statement 解析 | wch的个人主页</title>
    <meta name="description" content="用于分享wch的学习笔记和项目~">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.74c45c5d.css" as="style"><link rel="preload" href="/assets/js/app.15a66b26.js" as="script"><link rel="preload" href="/assets/js/2.92cd0f37.js" as="script"><link rel="preload" href="/assets/js/37.22e4179e.js" as="script"><link rel="prefetch" href="/assets/js/10.1166f652.js"><link rel="prefetch" href="/assets/js/11.b6ae0b14.js"><link rel="prefetch" href="/assets/js/12.7802c7ba.js"><link rel="prefetch" href="/assets/js/13.63066938.js"><link rel="prefetch" href="/assets/js/14.1f9fa0d5.js"><link rel="prefetch" href="/assets/js/15.6c758eca.js"><link rel="prefetch" href="/assets/js/16.58440a84.js"><link rel="prefetch" href="/assets/js/17.1e1f5c53.js"><link rel="prefetch" href="/assets/js/18.28115609.js"><link rel="prefetch" href="/assets/js/19.7e395424.js"><link rel="prefetch" href="/assets/js/20.2c2ea5f8.js"><link rel="prefetch" href="/assets/js/21.1e8ef167.js"><link rel="prefetch" href="/assets/js/22.47a8f5b7.js"><link rel="prefetch" href="/assets/js/23.f507c548.js"><link rel="prefetch" href="/assets/js/24.b19f43b8.js"><link rel="prefetch" href="/assets/js/25.5b1882b0.js"><link rel="prefetch" href="/assets/js/26.16cf6f8a.js"><link rel="prefetch" href="/assets/js/27.6f3498d0.js"><link rel="prefetch" href="/assets/js/28.f56b7e3c.js"><link rel="prefetch" href="/assets/js/29.de1da78b.js"><link rel="prefetch" href="/assets/js/3.73d3287d.js"><link rel="prefetch" href="/assets/js/30.108b25a0.js"><link rel="prefetch" href="/assets/js/31.68af7d35.js"><link rel="prefetch" href="/assets/js/32.c9f05837.js"><link rel="prefetch" href="/assets/js/33.13bd6f64.js"><link rel="prefetch" href="/assets/js/34.59041fd7.js"><link rel="prefetch" href="/assets/js/35.4382a261.js"><link rel="prefetch" href="/assets/js/36.01d6324a.js"><link rel="prefetch" href="/assets/js/38.f553994e.js"><link rel="prefetch" href="/assets/js/39.a72bb5df.js"><link rel="prefetch" href="/assets/js/4.9a52aae5.js"><link rel="prefetch" href="/assets/js/40.3751cd34.js"><link rel="prefetch" href="/assets/js/41.d351ec5d.js"><link rel="prefetch" href="/assets/js/42.b87a3eae.js"><link rel="prefetch" href="/assets/js/43.7035de8a.js"><link rel="prefetch" href="/assets/js/44.2c18f0bc.js"><link rel="prefetch" href="/assets/js/45.52905280.js"><link rel="prefetch" href="/assets/js/46.abb047a4.js"><link rel="prefetch" href="/assets/js/47.2ac230d3.js"><link rel="prefetch" href="/assets/js/48.b63bb42b.js"><link rel="prefetch" href="/assets/js/49.35752ae9.js"><link rel="prefetch" href="/assets/js/5.36029518.js"><link rel="prefetch" href="/assets/js/50.b6bd912f.js"><link rel="prefetch" href="/assets/js/51.0e0db65f.js"><link rel="prefetch" href="/assets/js/52.d15fb17a.js"><link rel="prefetch" href="/assets/js/53.844345be.js"><link rel="prefetch" href="/assets/js/54.52685e8c.js"><link rel="prefetch" href="/assets/js/55.83a99fe0.js"><link rel="prefetch" href="/assets/js/56.fe26d3a3.js"><link rel="prefetch" href="/assets/js/57.dae36566.js"><link rel="prefetch" href="/assets/js/58.1bfd28b1.js"><link rel="prefetch" href="/assets/js/59.88f55364.js"><link rel="prefetch" href="/assets/js/6.d3b55a54.js"><link rel="prefetch" href="/assets/js/7.af0443ed.js"><link rel="prefetch" href="/assets/js/8.2c9a7ea2.js"><link rel="prefetch" href="/assets/js/9.c08dcf83.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74c45c5d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">wch的个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java虚拟机</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java并发编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MyBatis 源码分析</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/mybatis/MyBatis源码分析（一）：MyBatis简介和整体架构.html" class="sidebar-link">MyBatis 源码分析（一）：MyBatis 简介和整体架构</a></li><li><a href="/posts/mybatis/MyBatis源码分析（二）：反射模块.html" class="sidebar-link">MyBatis 源码分析（二）：反射模块</a></li><li><a href="/posts/mybatis/MyBatis源码分析（三）：基础支持模块.html" class="sidebar-link">MyBatis 源码分析（三）：基础支持模块</a></li><li><a href="/posts/mybatis/MyBatis源码分析（四）：运行时配置解析.html" class="sidebar-link">MyBatis 源码分析（四）：运行时配置解析</a></li><li><a href="/posts/mybatis/MyBatis源码分析（五）：Mapper通用配置解析.html" class="sidebar-link">MyBatis 源码分析（五）：Mapper 通用配置解析</a></li><li><a href="/posts/mybatis/MyBatis源码分析（六）：statement解析.html" class="active sidebar-link">MyBatis 源码分析（六）：statement 解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/mybatis/MyBatis源码分析（六）：statement解析.html#解析工具" class="sidebar-link">解析工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/mybatis/MyBatis源码分析（六）：statement解析.html#token-解析" class="sidebar-link">Token 解析</a></li><li class="sidebar-sub-header"><a href="/posts/mybatis/MyBatis源码分析（六）：statement解析.html#特殊容器" class="sidebar-link">特殊容器</a></li><li class="sidebar-sub-header"><a href="/posts/mybatis/MyBatis源码分析（六）：statement解析.html#ognl-工具" class="sidebar-link">OGNL 工具</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/mybatis/MyBatis源码分析（六）：statement解析.html#解析逻辑" class="sidebar-link">解析逻辑</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/mybatis/MyBatis源码分析（六）：statement解析.html#语法驱动" class="sidebar-link">语法驱动</a></li><li class="sidebar-sub-header"><a href="/posts/mybatis/MyBatis源码分析（六）：statement解析.html#递归解析-include" class="sidebar-link">递归解析 include</a></li><li class="sidebar-sub-header"><a href="/posts/mybatis/MyBatis源码分析（六）：statement解析.html#解析-selectkey" class="sidebar-link">解析 selectKey</a></li><li class="sidebar-sub-header"><a href="/posts/mybatis/MyBatis源码分析（六）：statement解析.html#创建-sql-生成对象" class="sidebar-link">创建 sql 生成对象</a></li><li class="sidebar-sub-header"><a href="/posts/mybatis/MyBatis源码分析（六）：statement解析.html#创建解析对象与生成可执行-sql" class="sidebar-link">创建解析对象与生成可执行 sql</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/mybatis/MyBatis源码分析（六）：statement解析.html#接口解析" class="sidebar-link">接口解析</a></li><li class="sidebar-sub-header"><a href="/posts/mybatis/MyBatis源码分析（六）：statement解析.html#小结" class="sidebar-link">小结</a></li><li class="sidebar-sub-header"><a href="/posts/mybatis/MyBatis源码分析（六）：statement解析.html#注释源码" class="sidebar-link">注释源码</a></li></ul></li><li><a href="/posts/mybatis/MyBatis源码分析（七）：接口层.html" class="sidebar-link">MyBatis 源码分析（七）：接口层</a></li><li><a href="/posts/mybatis/MyBatis源码分析（八）：执行器.html" class="sidebar-link">MyBatis 源码分析（八）：执行器</a></li><li><a href="/posts/mybatis/MyBatis源码分析（九）：集成Spring.html" class="sidebar-link">MyBatis 源码分析（九）：集成 Spring</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring Security 源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微信小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Elasticsearch</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mybatis-源码分析（六）：statement-解析"><a href="#mybatis-源码分析（六）：statement-解析" class="header-anchor">#</a> MyBatis 源码分析（六）：statement 解析</h1> <p><code>Mapper</code> 映射文件解析的最后一步是解析所有 <code>statement</code> 元素，即 <code>select</code>、<code>insert</code>、<code>update</code>、<code>delete</code> 元素，这些元素中可能会包含动态 <code>SQL</code>，即使用 <code>${}</code> 占位符或 <code>if</code>、<code>choose</code>、<code>where</code> 等元素动态组成的 <code>SQL</code>。动态 <code>SQL</code> 功能正是 <code>MyBatis</code> 强大的所在，其解析过程也是十分复杂的。</p> <h2 id="解析工具"><a href="#解析工具" class="header-anchor">#</a> 解析工具</h2> <p>为了方便 <code>statement</code> 的解析，<code>MyBatis</code> 提供了一些解析工具。</p> <h3 id="token-解析"><a href="#token-解析" class="header-anchor">#</a> Token 解析</h3> <p><code>MyBatis</code> 支持使用 <code>${}</code> 或 <code>#{}</code> 类型的 <code>token</code> 作为动态参数，不仅文本中可以使用 <code>token</code>，<code>xml</code> 元素中的属性等也可以使用。</p> <h4 id="generictokenparser"><a href="#generictokenparser" class="header-anchor">#</a> GenericTokenParser</h4> <p><code>GenericTokenParser</code> 是 <code>MyBatis</code> 提供的通用 <code>token</code> 解析器，其解析逻辑是根据指定的 <code>token</code> 前缀和后缀搜索 <code>token</code>，并使用传入的 <code>TokenHandler</code> 对文本进行处理。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>text <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> text<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// search open token 搜索 token 前缀</span>
    <span class="token keyword">int</span> start <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>openToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 没有 token 前缀，返回原文本</span>
      <span class="token keyword">return</span> text<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> src <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 当前解析偏移量</span>
    <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 已解析文本</span>
    <span class="token keyword">final</span> <span class="token class-name">StringBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 当前占位符内的表达式</span>
    <span class="token class-name">StringBuilder</span> expression <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>start <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> src<span class="token punctuation">[</span>start <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果待解析属性前缀被转义，则去掉转义字符，加入已解析文本</span>
        <span class="token comment">// this open token is escaped. remove the backslash and continue.</span>
        builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> start <span class="token operator">-</span> offset <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>openToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 更新解析偏移量</span>
        offset <span class="token operator">=</span> start <span class="token operator">+</span> openToken<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// found open token. let's search close token.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expression <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          expression <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          expression<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 前缀前面的部分加入已解析文本</span>
        builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> start <span class="token operator">-</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 更新解析偏移量</span>
        offset <span class="token operator">=</span> start <span class="token operator">+</span> openToken<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取对应的后缀索引</span>
        <span class="token keyword">int</span> end <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>closeToken<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>end <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">&gt;</span> offset <span class="token operator">&amp;&amp;</span> src<span class="token punctuation">[</span>end <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 后缀被转义，加入已解析文本</span>
            <span class="token comment">// this close token is escaped. remove the backslash and continue.</span>
            expression<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> end <span class="token operator">-</span> offset <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>closeToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            offset <span class="token operator">=</span> end <span class="token operator">+</span> closeToken<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 寻找下一个后缀</span>
            end <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>closeToken<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 找到后缀，获取占位符内的表达式</span>
            expression<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> end <span class="token operator">-</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            offset <span class="token operator">=</span> end <span class="token operator">+</span> closeToken<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 找不到后缀，前缀之后的部分全部加入已解析文本</span>
          <span class="token comment">// close token was not found.</span>
          builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> start<span class="token punctuation">,</span> src<span class="token punctuation">.</span>length <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
          offset <span class="token operator">=</span> src<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 能够找到后缀，追加 token 处理器处理后的文本</span>
          builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span><span class="token function">handleToken</span><span class="token punctuation">(</span>expression<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 更新解析偏移量</span>
          offset <span class="token operator">=</span> end <span class="token operator">+</span> closeToken<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 寻找下一个前缀，重复解析表达式</span>
      start <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>openToken<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> src<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将最后的部分加入已解析文本</span>
      builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> src<span class="token punctuation">.</span>length <span class="token operator">-</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 返回解析后的文本</span>
    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>由于 <code>GenericTokenParser</code> 的 <code>token</code> 前后缀和具体解析逻辑都是可指定的，因此基于 <code>GenericTokenParser</code> 可以实现对不同 <code>token</code> 的定制化解析。</p> <h4 id="tokenhandler"><a href="#tokenhandler" class="header-anchor">#</a> TokenHandler</h4> <p><code>TokenHandler</code> 是 <code>token</code> 处理器抽象接口。实现此接口可以定义 <code>token</code> 以何种方式被解析。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TokenHandler</span> <span class="token punctuation">{</span>

  <span class="token comment">/**
   * 对 token 进行解析
   *
   * @param content 待解析 token
   * @return
   */</span>
  <span class="token class-name">String</span> <span class="token function">handleToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="propertyparser"><a href="#propertyparser" class="header-anchor">#</a> PropertyParser</h4> <p><code>PropertyParser</code> 是 <code>token</code> 解析的一种具体实现，其指定对 <code>${}</code> 类型 <code>token</code> 进行解析，具体解析逻辑由其内部类 <code>VariableTokenHandler</code> 实现：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">/**
   * 对 ${} 类型 token 进行解析
   *
   * @param string
   * @param variables
   * @return
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">String</span> string<span class="token punctuation">,</span> <span class="token class-name">Properties</span> variables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">VariableTokenHandler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VariableTokenHandler</span><span class="token punctuation">(</span>variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">GenericTokenParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericTokenParser</span><span class="token punctuation">(</span><span class="token string">&quot;${&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;}&quot;</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 根据配置属性对 ${} token 进行解析
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">VariableTokenHandler</span> <span class="token keyword">implements</span> <span class="token class-name">TokenHandler</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 预先设置的属性
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Properties</span> variables<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 是否运行使用默认值，默认为 false
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> enableDefaultValue<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 默认值分隔符号，即如待解析属性 ${key:default}，key 的默认值为 default
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> defaultValueSeparator<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">VariableTokenHandler</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> variables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>variables <span class="token operator">=</span> variables<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>enableDefaultValue <span class="token operator">=</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span><span class="token function">getPropertyValue</span><span class="token punctuation">(</span>KEY_ENABLE_DEFAULT_VALUE<span class="token punctuation">,</span> ENABLE_DEFAULT_VALUE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>defaultValueSeparator <span class="token operator">=</span> <span class="token function">getPropertyValue</span><span class="token punctuation">(</span>KEY_DEFAULT_VALUE_SEPARATOR<span class="token punctuation">,</span> DEFAULT_VALUE_SEPARATOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getPropertyValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> defaultValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>variables <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> defaultValue <span class="token operator">:</span> variables<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handleToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>variables <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> content<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>enableDefaultValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如待解析属性 ${key:default}，key 的默认值为 default</span>
          <span class="token keyword">final</span> <span class="token keyword">int</span> separatorIndex <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>defaultValueSeparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name">String</span> defaultValue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>separatorIndex <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            key <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> separatorIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            defaultValue <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>separatorIndex <span class="token operator">+</span> defaultValueSeparator<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultValue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 使用默认值</span>
            <span class="token keyword">return</span> variables<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>variables<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 不使用默认值</span>
          <span class="token keyword">return</span> variables<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 返回原文本</span>
      <span class="token keyword">return</span> <span class="token string">&quot;${&quot;</span> <span class="token operator">+</span> content <span class="token operator">+</span> <span class="token string">&quot;}&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>VariableTokenHandler</code> 实现了 <code>TokenHandler</code> 接口，其构造方法允许传入一组 <code>Properties</code> 用于获取 <code>token</code> 表达式的值。如果开启了使用默认值，则表达式 <code>${key:default}</code> 会在 <code>key</code> 没有映射值的时候使用 <code>default</code> 作为默认值。</p> <h3 id="特殊容器"><a href="#特殊容器" class="header-anchor">#</a> 特殊容器</h3> <h4 id="strictmap"><a href="#strictmap" class="header-anchor">#</a> StrictMap</h4> <p><code>Configuration</code> 中的 <code>StrictMap</code> 继承了 <code>HashMap</code>，相对于 <code>HashMap</code>，其存取键值的要求更为严格。<code>put</code> 方法不允许添加相同的 <code>key</code>，并获取最后一个 <code>.</code> 后的部分作为 <code>shortKey</code>，如果 <code>shortKey</code> 也重复了，其会向容器中添加一个 <code>Ambiguity</code> 对象，当使用 <code>get</code> 方法获取这个 <code>shortKey</code> 对应的值时，就会抛出异常。<code>get</code> 方法对于不存在的 <code>key</code> 也会抛出异常。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 重复 key 异常</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">&quot; already contains value for &quot;</span> <span class="token operator">+</span> key
          <span class="token operator">+</span> <span class="token punctuation">(</span>conflictMessageProducer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> conflictMessageProducer<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取最后一个 . 后的部分作为 shortKey</span>
      <span class="token keyword">final</span> <span class="token class-name">String</span> shortKey <span class="token operator">=</span> <span class="token function">getShortName</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// shortKey 不允许重复，否则在获取时异常</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>shortKey<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>shortKey<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>shortKey<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">V</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">Ambiguity</span><span class="token punctuation">(</span>shortKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">V</span> value <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// key 不存在抛异常</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">&quot; does not contain value for &quot;</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 重复的 key 抛异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Ambiguity</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Ambiguity</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; is ambiguous in &quot;</span> <span class="token operator">+</span> name
                                         <span class="token operator">+</span> <span class="token string">&quot; (try using the full name including the namespace, or rename one of the entries)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="contextmap"><a href="#contextmap" class="header-anchor">#</a> ContextMap</h4> <p><code>ContextMap</code> 是 <code>DynamicContext</code> 的静态内部类，用于保存 <code>sql</code> 上下文中的绑定参数。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ContextMap</span> <span class="token keyword">extends</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">2977601501966151582L</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 参数对象
   */</span>
  <span class="token keyword">private</span> <span class="token class-name">MetaObject</span> parameterMetaObject<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">ContextMap</span><span class="token punctuation">(</span><span class="token class-name">MetaObject</span> parameterMetaObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parameterMetaObject <span class="token operator">=</span> parameterMetaObject<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先根据 key 查找原始容器</span>
    <span class="token class-name">String</span> strKey <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> key<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>strKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>strKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 再进入参数对象查找</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parameterMetaObject <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// issue #61 do not modify the context when reading</span>
      <span class="token keyword">return</span> parameterMetaObject<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>strKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="ognl-工具"><a href="#ognl-工具" class="header-anchor">#</a> OGNL 工具</h3> <h4 id="ognlcache"><a href="#ognlcache" class="header-anchor">#</a> OgnlCache</h4> <p><code>OGNL</code> 工具支持通过字符串表达式调用 <code>Java</code> 方法，但是其实现需要对 <code>OGNL</code> 表达式进行编译，为了提高性能，<code>MyBatis</code> 提供 <code>OgnlCache</code> 工具类用于对 <code>OGNL</code> 表达式编译结果进行缓存。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">/**
   * 根据 ognl 表达式和参数计算值
   *
   * @param expression
   * @param root
   * @return
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> expression<span class="token punctuation">,</span> <span class="token class-name">Object</span> root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">Map</span> context <span class="token operator">=</span> <span class="token class-name">Ognl</span><span class="token punctuation">.</span><span class="token function">createDefaultContext</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> MEMBER_ACCESS<span class="token punctuation">,</span> CLASS_RESOLVER<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token class-name">Ognl</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OgnlException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">&quot;Error evaluating expression '&quot;</span> <span class="token operator">+</span> expression <span class="token operator">+</span> <span class="token string">&quot;'. Cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 编译 ognl 表达式并放入缓存
   *
   * @param expression
   * @return
   * @throws OgnlException
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">parseExpression</span><span class="token punctuation">(</span><span class="token class-name">String</span> expression<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">OgnlException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> node <span class="token operator">=</span> expressionCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 编译 ognl 表达式</span>
      node <span class="token operator">=</span> <span class="token class-name">Ognl</span><span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 放入缓存</span>
      expressionCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>expression<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> node<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="expressionevaluator"><a href="#expressionevaluator" class="header-anchor">#</a> ExpressionEvaluator</h4> <p><code>ExpressionEvaluator</code> 是 <code>OGNL</code> 表达式计算工具，<code>evaluateBoolean</code> 和 <code>evaluateIterable</code> 方法分别根据传入的表达式和参数计算出一个 <code>boolean</code> 值或一个可迭代对象。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">/**
   * 计算 ognl 表达式 true / false
   *
   * @param expression
   * @param parameterObject
   * @return
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">evaluateBoolean</span><span class="token punctuation">(</span><span class="token class-name">String</span> expression<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameterObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据 ognl 表达式和参数计算值</span>
    <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token class-name">OgnlCache</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>expression<span class="token punctuation">,</span> parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// true / false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 不为 0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span>ZERO<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 不为 null</span>
    <span class="token keyword">return</span> value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 计算获得一个可迭代的对象
   *
   * @param expression
   * @param parameterObject
   * @return
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">evaluateIterable</span><span class="token punctuation">(</span><span class="token class-name">String</span> expression<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameterObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token class-name">OgnlCache</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>expression<span class="token punctuation">,</span> parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">&quot;The expression '&quot;</span> <span class="token operator">+</span> expression <span class="token operator">+</span> <span class="token string">&quot;' evaluated to a null value.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Iterable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 已实现 Iterable 接口</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 数组转集合</span>
      <span class="token comment">// the array may be primitive, so Arrays.asList() may throw</span>
      <span class="token comment">// a ClassCastException (issue 209).  Do the work manually</span>
      <span class="token comment">// Curse primitives! :) (JGB)</span>
      <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> answer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> o <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        answer<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> answer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Map 获取 entry</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">&quot;Error evaluating expression '&quot;</span> <span class="token operator">+</span> expression <span class="token operator">+</span> <span class="token string">&quot;'.  Return value (&quot;</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">&quot;) was not iterable.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="解析逻辑"><a href="#解析逻辑" class="header-anchor">#</a> 解析逻辑</h2> <p><code>MyBastis</code> 中调用 <code>XMLStatementBuilder#parseStatementNode</code> 方法解析单个 <code>statement</code> 元素。此方法中除了逐个获取元素属性，还对 <code>include</code> 元素、<code>selectKey</code> 元素进行解析，创建了 <code>sql</code> 生成对象 <code>SqlSource</code>，并将 <code>statement</code> 的全部信息聚合到 <code>MappedStatement</code> 对象中。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parseStatementNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取 id</span>
    <span class="token class-name">String</span> id <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 自定义数据库厂商信息</span>
    <span class="token class-name">String</span> databaseId <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;databaseId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">databaseIdMatchesCurrent</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> databaseId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requiredDatabaseId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 不符合当前数据源对应的数据厂商信息的语句不加载</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取元素名</span>
    <span class="token class-name">String</span> nodeName <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 元素名转为对应的 SqlCommandType 枚举</span>
    <span class="token class-name">SqlCommandType</span> sqlCommandType <span class="token operator">=</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>nodeName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>ENGLISH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 是否为查询</span>
    <span class="token keyword">boolean</span> isSelect <span class="token operator">=</span> sqlCommandType <span class="token operator">==</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span>SELECT<span class="token punctuation">;</span>
    <span class="token comment">// 获取 flushCache 属性，查询默认为 false，其它默认为 true</span>
    <span class="token keyword">boolean</span> flushCache <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBooleanAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;flushCache&quot;</span><span class="token punctuation">,</span> <span class="token operator">!</span>isSelect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取 useCache 属性，查询默认为 true，其它默认为 false</span>
    <span class="token keyword">boolean</span> useCache <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBooleanAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;useCache&quot;</span><span class="token punctuation">,</span> isSelect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取 resultOrdered 属性，默认为 false</span>
    <span class="token keyword">boolean</span> resultOrdered <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBooleanAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;resultOrdered&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Include Fragments before parsing</span>
    <span class="token class-name">XMLIncludeTransformer</span> includeParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLIncludeTransformer</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> builderAssistant<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 解析 include 属性</span>
    includeParser<span class="token punctuation">.</span><span class="token function">applyIncludes</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 参数类型</span>
    <span class="token class-name">String</span> parameterType <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;parameterType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> parameterTypeClass <span class="token operator">=</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>parameterType<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取 Mapper 语法类型</span>
    <span class="token class-name">String</span> lang <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;lang&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 默认使用 XMLLanguageDriver</span>
    <span class="token class-name">LanguageDriver</span> langDriver <span class="token operator">=</span> <span class="token function">getLanguageDriver</span><span class="token punctuation">(</span>lang<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Parse selectKey after includes and remove them.</span>
    <span class="token comment">// 解析 selectKey 元素</span>
    <span class="token function">processSelectKeyNodes</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> parameterTypeClass<span class="token punctuation">,</span> langDriver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取 KeyGenerator</span>
    <span class="token comment">// Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)</span>
    <span class="token class-name">KeyGenerator</span> keyGenerator<span class="token punctuation">;</span>
    <span class="token class-name">String</span> keyStatementId <span class="token operator">=</span> id <span class="token operator">+</span> <span class="token class-name">SelectKeyGenerator</span><span class="token punctuation">.</span>SELECT_KEY_SUFFIX<span class="token punctuation">;</span>
    keyStatementId <span class="token operator">=</span> builderAssistant<span class="token punctuation">.</span><span class="token function">applyCurrentNamespace</span><span class="token punctuation">(</span>keyStatementId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">hasKeyGenerator</span><span class="token punctuation">(</span>keyStatementId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取解析完成的 KeyGenerator 对象</span>
      keyGenerator <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getKeyGenerator</span><span class="token punctuation">(</span>keyStatementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果开启了 useGeneratedKeys 属性，并且为插入类型的 sql 语句、配置了 keyProperty 属性，则可以批量自动设置属性</span>
      keyGenerator <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBooleanAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;useGeneratedKeys&quot;</span><span class="token punctuation">,</span>
          configuration<span class="token punctuation">.</span><span class="token function">isUseGeneratedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span>INSERT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>sqlCommandType<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token operator">?</span> <span class="token class-name">Jdbc3KeyGenerator</span><span class="token punctuation">.</span>INSTANCE <span class="token operator">:</span> <span class="token class-name">NoKeyGenerator</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 生成有效 sql 语句和参数绑定对象</span>
    <span class="token class-name">SqlSource</span> sqlSource <span class="token operator">=</span> langDriver<span class="token punctuation">.</span><span class="token function">createSqlSource</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> context<span class="token punctuation">,</span> parameterTypeClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// sql 类型</span>
    <span class="token class-name">StatementType</span> statementType <span class="token operator">=</span> <span class="token class-name">StatementType</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;statementType&quot;</span><span class="token punctuation">,</span> <span class="token class-name">StatementType</span><span class="token punctuation">.</span>PREPARED<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 分批获取数据的数量</span>
    <span class="token class-name">Integer</span> fetchSize <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getIntAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;fetchSize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行超时时间</span>
    <span class="token class-name">Integer</span> timeout <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getIntAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;timeout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 参数映射</span>
    <span class="token class-name">String</span> parameterMap <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;parameterMap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 返回值类型</span>
    <span class="token class-name">String</span> resultType <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;resultType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> resultTypeClass <span class="token operator">=</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>resultType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 返回值映射 map</span>
    <span class="token class-name">String</span> resultMap <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;resultMap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 结果集类型</span>
    <span class="token class-name">String</span> resultSetType <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;resultSetType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ResultSetType</span> resultSetTypeEnum <span class="token operator">=</span> <span class="token function">resolveResultSetType</span><span class="token punctuation">(</span>resultSetType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 插入、更新生成键值的字段</span>
    <span class="token class-name">String</span> keyProperty <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;keyProperty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 插入、更新生成键值的列</span>
    <span class="token class-name">String</span> keyColumn <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;keyColumn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 指定多结果集名称</span>
    <span class="token class-name">String</span> resultSets <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;resultSets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 新增 MappedStatement</span>
    builderAssistant<span class="token punctuation">.</span><span class="token function">addMappedStatement</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> sqlSource<span class="token punctuation">,</span> statementType<span class="token punctuation">,</span> sqlCommandType<span class="token punctuation">,</span>
        fetchSize<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> parameterMap<span class="token punctuation">,</span> parameterTypeClass<span class="token punctuation">,</span> resultMap<span class="token punctuation">,</span> resultTypeClass<span class="token punctuation">,</span>
        resultSetTypeEnum<span class="token punctuation">,</span> flushCache<span class="token punctuation">,</span> useCache<span class="token punctuation">,</span> resultOrdered<span class="token punctuation">,</span>
        keyGenerator<span class="token punctuation">,</span> keyProperty<span class="token punctuation">,</span> keyColumn<span class="token punctuation">,</span> databaseId<span class="token punctuation">,</span> langDriver<span class="token punctuation">,</span> resultSets<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="语法驱动"><a href="#语法驱动" class="header-anchor">#</a> 语法驱动</h3> <p><code>LanguageDriver</code> 是 <code>statement</code> 创建语法驱动，默认实现为 <code>XMLLanguageDriver</code>，其提供 <code>createSqlSource</code> 方法用于使用 <code>XMLScriptBuilder</code> 创建 <code>sql</code> 生成对象。</p> <h3 id="递归解析-include"><a href="#递归解析-include" class="header-anchor">#</a> 递归解析 include</h3> <p><code>include</code> 元素是 <code>statement</code> 元素的子元素，通过 <code>refid</code> 属性可以指向在别处定义的 <code>sql fragments</code>。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">applyIncludes</span><span class="token punctuation">(</span><span class="token class-name">Node</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Properties</span> variablesContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Properties</span> configurationVariables <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 拷贝全局配置中设置的额外配置属性</span>
    <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>configurationVariables<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>variablesContext<span class="token operator">:</span><span class="token operator">:</span><span class="token function">putAll</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">applyIncludes</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> variablesContext<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 递归解析 statement 元素中的 include 元素
   *
   * Recursively apply includes through all SQL fragments.
   * @param source Include node in DOM tree
   * @param variablesContext Current context for static variables with values
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">applyIncludes</span><span class="token punctuation">(</span><span class="token class-name">Node</span> source<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Properties</span> variablesContext<span class="token punctuation">,</span> <span class="token keyword">boolean</span> included<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;include&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// include 元素，从全局配置中找对应的 sql 节点并 clone</span>
      <span class="token class-name">Node</span> toInclude <span class="token operator">=</span> <span class="token function">findSqlFragment</span><span class="token punctuation">(</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token string">&quot;refid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> variablesContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 读取 include 子元素中的 property 元素，获取全部属性</span>
      <span class="token class-name">Properties</span> toIncludeContext <span class="token operator">=</span> <span class="token function">getVariablesContext</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> variablesContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">applyIncludes</span><span class="token punctuation">(</span>toInclude<span class="token punctuation">,</span> toIncludeContext<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>toInclude<span class="token punctuation">.</span><span class="token function">getOwnerDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> source<span class="token punctuation">.</span><span class="token function">getOwnerDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        toInclude <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">getOwnerDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">importNode</span><span class="token punctuation">(</span>toInclude<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      source<span class="token punctuation">.</span><span class="token function">getParentNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>toInclude<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>toInclude<span class="token punctuation">.</span><span class="token function">hasChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        toInclude<span class="token punctuation">.</span><span class="token function">getParentNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>toInclude<span class="token punctuation">.</span><span class="token function">getFirstChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> toInclude<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      toInclude<span class="token punctuation">.</span><span class="token function">getParentNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>toInclude<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">getNodeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>ELEMENT_NODE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>included <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>variablesContext<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// replace variables in attribute values</span>
        <span class="token comment">// include 指向的 sql clone 节点，逐个对属性进行解析</span>
        <span class="token class-name">NamedNodeMap</span> attributes <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> attributes<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">Node</span> attr <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
          attr<span class="token punctuation">.</span><span class="token function">setNodeValue</span><span class="token punctuation">(</span><span class="token class-name">PropertyParser</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>attr<span class="token punctuation">.</span><span class="token function">getNodeValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> variablesContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// statement 元素中可能包含 include 子元素</span>
      <span class="token class-name">NodeList</span> children <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">getChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">applyIncludes</span><span class="token punctuation">(</span>children<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> variablesContext<span class="token punctuation">,</span> included<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>included <span class="token operator">&amp;&amp;</span> source<span class="token punctuation">.</span><span class="token function">getNodeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>TEXT_NODE
        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>variablesContext<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// replace variables in text node</span>
      <span class="token comment">// 替换元素值，如果使用了 ${} 占位符，会对 token 进行解析</span>
      source<span class="token punctuation">.</span><span class="token function">setNodeValue</span><span class="token punctuation">(</span><span class="token class-name">PropertyParser</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">getNodeValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> variablesContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 从全局配置中找对应的 sql fragment
   *
   * @param refid
   * @param variables
   * @return
   */</span>
  <span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">findSqlFragment</span><span class="token punctuation">(</span><span class="token class-name">String</span> refid<span class="token punctuation">,</span> <span class="token class-name">Properties</span> variables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 解析 refid</span>
    refid <span class="token operator">=</span> <span class="token class-name">PropertyParser</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>refid<span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// namespace.refid</span>
    refid <span class="token operator">=</span> builderAssistant<span class="token punctuation">.</span><span class="token function">applyCurrentNamespace</span><span class="token punctuation">(</span>refid<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 从全局配置中找对应的 sql fragment</span>
      <span class="token class-name">XNode</span> nodeToInclude <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getSqlFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>refid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> nodeToInclude<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// sql fragments 定义在全局配置中的 StrictMap 中，获取不到会抛出异常</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IncompleteElementException</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find SQL statement to include with refid '&quot;</span> <span class="token operator">+</span> refid <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNamedItem</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNodeValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Read placeholders and their values from include node definition.
   *
   * 读取 include 子元素中的 property 元素
   * @param node Include node instance
   * @param inheritedVariablesContext Current context used for replace variables in new variables values
   * @return variables context from include instance (no inherited values)
   */</span>
  <span class="token keyword">private</span> <span class="token class-name">Properties</span> <span class="token function">getVariablesContext</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token class-name">Properties</span> inheritedVariablesContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> declaredProperties <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 解析 include 元素中的 property 子元素</span>
    <span class="token class-name">NodeList</span> children <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Node</span> n <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token punctuation">.</span><span class="token function">getNodeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>ELEMENT_NODE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// include 运行包含 property 元素</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token function">getStringAttribute</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Replace variables inside</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token class-name">PropertyParser</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inheritedVariablesContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>declaredProperties <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          declaredProperties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>declaredProperties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 不允许添加同名属性</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">&quot;Variable &quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot; defined twice in the same include definition&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>declaredProperties <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> inheritedVariablesContext<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 聚合属性配置</span>
      <span class="token class-name">Properties</span> newProperties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      newProperties<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>inheritedVariablesContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      newProperties<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>declaredProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> newProperties<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>在开始解析前，从全局配置中获取全部的属性配置，如果 <code>include</code> 元素中有 <code>property</code> 元素，解析并获取键值，放入 <code>variablesContext</code> 中，在后续处理中针对可能出现的 <code>${}</code> 类型 <code>token</code> 使用 <code>PropertyParser</code> 进行解析。</p> <p>因为解析 <code>statement</code> 元素前已经加载过 <code>sql</code> 元素，因此会根据 <code>include</code> 元素的 <code>refid</code> 属性查找对应的 <code>sql fragments</code>，如果全局配置中无法找到就会抛出异常；如果能够找到则克隆 <code>sql</code> 元素并插入到当前 <code>xml</code> 文档中。</p> <h3 id="解析-selectkey"><a href="#解析-selectkey" class="header-anchor">#</a> 解析 selectKey</h3> <p><code>selectKey</code> 用于指定 <code>sql</code> 在 <code>insert</code> 或 <code>update</code> 语句执行前或执行后生成或获取列值，在 <code>MyBatis</code> 中 <code>selectKey</code> 也被当做 <code>statement</code> 语句进行解析并设置到全局配置中。单个 <code>selectKey</code> 元素会以<code>SelectKeyGenerator</code> 对象的形式进行保存用于后续调用。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseSelectKeyNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">,</span> <span class="token class-name">XNode</span> nodeToHandle<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> parameterTypeClass<span class="token punctuation">,</span> <span class="token class-name">LanguageDriver</span> langDriver<span class="token punctuation">,</span> <span class="token class-name">String</span> databaseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回值类型</span>
    <span class="token class-name">String</span> resultType <span class="token operator">=</span> nodeToHandle<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;resultType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> resultTypeClass <span class="token operator">=</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>resultType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">StatementType</span> statementType <span class="token operator">=</span> <span class="token class-name">StatementType</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>nodeToHandle<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;statementType&quot;</span><span class="token punctuation">,</span> <span class="token class-name">StatementType</span><span class="token punctuation">.</span>PREPARED<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对应字段名</span>
    <span class="token class-name">String</span> keyProperty <span class="token operator">=</span> nodeToHandle<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;keyProperty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对应列名</span>
    <span class="token class-name">String</span> keyColumn <span class="token operator">=</span> nodeToHandle<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;keyColumn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 是否在父sql执行前执行</span>
    <span class="token keyword">boolean</span> executeBefore <span class="token operator">=</span> <span class="token string">&quot;BEFORE&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>nodeToHandle<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;AFTER&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//defaults</span>
    <span class="token keyword">boolean</span> useCache <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> resultOrdered <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token class-name">KeyGenerator</span> keyGenerator <span class="token operator">=</span> <span class="token class-name">NoKeyGenerator</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>
    <span class="token class-name">Integer</span> fetchSize <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">Integer</span> timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> flushCache <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> parameterMap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> resultMap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">ResultSetType</span> resultSetTypeEnum <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建 sql 生成对象</span>
    <span class="token class-name">SqlSource</span> sqlSource <span class="token operator">=</span> langDriver<span class="token punctuation">.</span><span class="token function">createSqlSource</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> nodeToHandle<span class="token punctuation">,</span> parameterTypeClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SqlCommandType</span> sqlCommandType <span class="token operator">=</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span>SELECT<span class="token punctuation">;</span>

    <span class="token comment">// 将 KeyGenerator 生成 sql 作为 MappedStatement 加入全局对象</span>
    builderAssistant<span class="token punctuation">.</span><span class="token function">addMappedStatement</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> sqlSource<span class="token punctuation">,</span> statementType<span class="token punctuation">,</span> sqlCommandType<span class="token punctuation">,</span>
        fetchSize<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> parameterMap<span class="token punctuation">,</span> parameterTypeClass<span class="token punctuation">,</span> resultMap<span class="token punctuation">,</span> resultTypeClass<span class="token punctuation">,</span>
        resultSetTypeEnum<span class="token punctuation">,</span> flushCache<span class="token punctuation">,</span> useCache<span class="token punctuation">,</span> resultOrdered<span class="token punctuation">,</span>
        keyGenerator<span class="token punctuation">,</span> keyProperty<span class="token punctuation">,</span> keyColumn<span class="token punctuation">,</span> databaseId<span class="token punctuation">,</span> langDriver<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    id <span class="token operator">=</span> builderAssistant<span class="token punctuation">.</span><span class="token function">applyCurrentNamespace</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">MappedStatement</span> keyStatement <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getMappedStatement</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 包装为 SelectKeyGenerator 对象</span>
    configuration<span class="token punctuation">.</span><span class="token function">addKeyGenerator</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SelectKeyGenerator</span><span class="token punctuation">(</span>keyStatement<span class="token punctuation">,</span> executeBefore<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>在 <code>selectKey</code> 解析完成后，按指定的 <code>namespace</code> 规则从全局配置中获取 <code>SelectKeyGenerator</code> 对象，等待创建 <code>MappedStatement</code> 对象。如果未指定 <code>selectKey</code> 元素，但是全局配置中开启了 <code>useGeneratedKeys</code>，并且指定 <code>insert</code> 元素的 <code>useGeneratedKeys</code> 属性为 <code>true</code>，则 <code>MyBatis</code> 会指定 <code>Jdbc3KeyGenerator</code> 作为 <code>useGeneratedKeys</code> 的默认实现。</p> <h3 id="创建-sql-生成对象"><a href="#创建-sql-生成对象" class="header-anchor">#</a> 创建 sql 生成对象</h3> <h4 id="sqlsource"><a href="#sqlsource" class="header-anchor">#</a> SqlSource</h4> <p><code>SqlSource</code> 是 <code>sql</code> 生成抽象接口，其提供 <code>getBoundSql</code> 方法用于根据参数生成有效 <code>sql</code> 语句和参数绑定对象 <code>BoundSql</code>。在生成 <code>statement</code> 元素的解析结果 <code>MappedStatement</code> 对象前，需要先创建 <code>sql</code> 生成对象，即 <code>SqlSource</code> 对象。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SqlSource</span> <span class="token punctuation">{</span>

  <span class="token comment">/**
   * 根据参数生成有效 sql 语句和参数绑定对象
   *
   * @param parameterObject
   * @return
   */</span>
  <span class="token class-name">BoundSql</span> <span class="token function">getBoundSql</span><span class="token punctuation">(</span><span class="token class-name">Object</span> parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="sqlnode"><a href="#sqlnode" class="header-anchor">#</a> SqlNode</h4> <p><code>SqlNode</code> 是 <code>sql</code> 节点抽象接口。<code>sql</code> 节点指的是 <code>statement</code> 中的组成部分，如果简单文本、<code>if</code> 元素、<code>where</code> 元素等。<code>SqlNode</code> 提供 <code>apply</code> 方法用于判断当前 <code>sql</code> 节点是否可以加入到生效的 <code>sql</code> 语句中。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SqlNode</span> <span class="token punctuation">{</span>

  <span class="token comment">/**
   * 根据条件判断当前 sql 节点是否可以加入到生效的 sql 语句中
   *
   * @param context
   * @return
   */</span>
  <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">DynamicContext</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/img/mybatis/SqlNode%E4%BD%93%E7%B3%BB.png" alt="SqlNode 体系"></p> <h4 id="dynamiccontext"><a href="#dynamiccontext" class="header-anchor">#</a> DynamicContext</h4> <p><code>DynamicContext</code> 是动态 <code>sql</code> 上下文，用于保存绑定参数和生效 <code>sql</code> 节点。<code>DynamicContext</code> 使用 <code>ContextMap</code> 作为参数绑定容器。由于动态 <code>sql</code> 是根据参数条件组合生成 <code>sql</code>，<code>DynamicContext</code> 还提供了对 <code>sqlBuilder</code> 修改和访问方法，用于添加有效 <code>sql</code> 节点和生成 <code>sql</code> 文本。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">/**
   * 生效的 sql 部分，以空格相连
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StringJoiner</span> sqlBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringJoiner</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">appendSql</span><span class="token punctuation">(</span><span class="token class-name">String</span> sql<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sqlBuilder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> sqlBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="节点解析"><a href="#节点解析" class="header-anchor">#</a> 节点解析</h4> <p>将 <code>statement</code> 元素转为 <code>sql</code> 生成对象依赖于 <code>LanguageDriver</code> 的 <code>createSqlSource</code> 方法，此方法中创建 <code>XMLScriptBuilder</code> 对象，并调用 <code>parseScriptNode</code> 方法对 <code>sql</code> 组成节点逐个解析并进行组合。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token class-name">SqlSource</span> <span class="token function">parseScriptNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 递归解析各 sql 节点</span>
    <span class="token class-name">MixedSqlNode</span> rootSqlNode <span class="token operator">=</span> <span class="token function">parseDynamicTags</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SqlSource</span> sqlSource<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isDynamic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 动态 sql</span>
      sqlSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicSqlSource</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> rootSqlNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 原始文本 sql</span>
      sqlSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RawSqlSource</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> rootSqlNode<span class="token punctuation">,</span> parameterType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sqlSource<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 处理 statement 各 SQL 组成部分，并进行组合
   */</span>
  <span class="token keyword">protected</span> <span class="token class-name">MixedSqlNode</span> <span class="token function">parseDynamicTags</span><span class="token punctuation">(</span><span class="token class-name">XNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// SQL 各组成部分</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SqlNode</span><span class="token punctuation">&gt;</span></span> contents <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历子元素</span>
    <span class="token class-name">NodeList</span> children <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">XNode</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">newXNode</span><span class="token punctuation">(</span>children<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNodeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>CDATA_SECTION_NODE <span class="token operator">||</span> child<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNodeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>TEXT_NODE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 解析 sql 文本</span>
        <span class="token class-name">String</span> data <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringBody</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TextSqlNode</span> textSqlNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextSqlNode</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>textSqlNode<span class="token punctuation">.</span><span class="token function">isDynamic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 判断是否为动态 sql，包含 ${} 占位符即为动态 sql</span>
          contents<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>textSqlNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
          isDynamic <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 静态 sql 元素</span>
          contents<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StaticTextSqlNode</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNodeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>ELEMENT_NODE<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// issue #628</span>
        <span class="token comment">// 如果是子元素</span>
        <span class="token class-name">String</span> nodeName <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取支持的子元素语法处理器</span>
        <span class="token class-name">NodeHandler</span> handler <span class="token operator">=</span> nodeHandlerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>nodeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown element &lt;&quot;</span> <span class="token operator">+</span> nodeName <span class="token operator">+</span> <span class="token string">&quot;&gt; in SQL statement.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 根据子元素标签类型使用对应的处理器处理子元素</span>
        handler<span class="token punctuation">.</span><span class="token function">handleNode</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 包含标签元素，认定为动态 SQL</span>
        isDynamic <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MixedSqlNode</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>parseDynamicTags</code> 方法会对 <code>sql</code> 各组成部分进行分解，如果 <code>statement</code> 元素包含 <code>${}</code> 类型 <code>token</code> 或含有标签子元素，则认为当前 <code>statement</code> 是动态 <code>sql</code>，随后 <code>isDynamic</code> 属性会被设置为 <code>true</code>。对于文本节点，如 <code>sql</code> 纯文本和仅含 <code>${}</code> 类型 <code>token</code> 的文本，会被包装为 <code>StaticTextSqlNode</code> 或 <code>TextSqlNode</code> 加入到 <code>sql</code> 节点容器中，而其它元素类型的 <code>sql</code> 节点会经过 <code>NodeHandler</code> 的 <code>handleNode</code> 方法处理过之后才能加入到节点容器中。<code>nodeHandlerMap</code> 定义了不同动态 <code>sql</code> 元素节点与 <code>NodeHandler</code> 的关系：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initNodeHandlerMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nodeHandlerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;trim&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TrimHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nodeHandlerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;where&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WhereHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nodeHandlerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;set&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SetHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nodeHandlerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;foreach&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ForEachHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nodeHandlerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;if&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IfHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nodeHandlerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;choose&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ChooseHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nodeHandlerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;when&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IfHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nodeHandlerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;otherwise&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OtherwiseHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nodeHandlerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;bind&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BindHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="mixedsqlnode"><a href="#mixedsqlnode" class="header-anchor">#</a> MixedSqlNode</h5> <p><code>MixedSqlNode</code> 中定义了一个 <code>SqlNode</code> 集合，用于保存 <code>statement</code> 中包含的全部 <code>sql</code> 节点。其生成有效 <code>sql</code> 的逻辑为逐个判断节点是否有效。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">/**
   * 组合 SQL 各组成部分
   *
   * @author Clinton Begin
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MixedSqlNode</span> <span class="token keyword">implements</span> <span class="token class-name">SqlNode</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * SQL 各组装成部分
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SqlNode</span><span class="token punctuation">&gt;</span></span> contents<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MixedSqlNode</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SqlNode</span><span class="token punctuation">&gt;</span></span> contents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>contents <span class="token operator">=</span> contents<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">DynamicContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 逐个判断各个 sql 节点是否能生效</span>
      contents<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>node <span class="token operator">-&gt;</span> node<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="statictextsqlnode"><a href="#statictextsqlnode" class="header-anchor">#</a> StaticTextSqlNode</h5> <p><code>StaticTextSqlNode</code> 中仅包含静态 <code>sql</code> 文本，在组装时会直接追加到 <code>sql</code> 上下文的有效 <code>sql</code> 中：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">DynamicContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span><span class="token function">appendSql</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="textsqlnode"><a href="#textsqlnode" class="header-anchor">#</a> TextSqlNode</h5> <p><code>TextSqlNode</code> 中的 <code>sql</code> 文本包含 <code>${}</code> 类型 <code>token</code>，使用 <code>GenericTokenParser</code> 搜索到 <code>token</code> 后会使用 <code>BindingTokenParser</code> 对 <code>token</code> 进行解析，解析后的文本会被追加到生效 <code>sql</code> 中。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">DynamicContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 搜索 ${} 类型 token 节点</span>
    <span class="token class-name">GenericTokenParser</span> parser <span class="token operator">=</span> <span class="token function">createParser</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BindingTokenParser</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> injectionFilter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 解析 token 并追加解析后的文本到生效 sql 中</span>
    context<span class="token punctuation">.</span><span class="token function">appendSql</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token class-name">GenericTokenParser</span> <span class="token function">createParser</span><span class="token punctuation">(</span><span class="token class-name">TokenHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GenericTokenParser</span><span class="token punctuation">(</span><span class="token string">&quot;${&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;}&quot;</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BindingTokenParser</span> <span class="token keyword">implements</span> <span class="token class-name">TokenHandler</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">DynamicContext</span> context<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Pattern</span> injectionFilter<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">BindingTokenParser</span><span class="token punctuation">(</span><span class="token class-name">DynamicContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Pattern</span> injectionFilter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>injectionFilter <span class="token operator">=</span> injectionFilter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handleToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取绑定参数</span>
      <span class="token class-name">Object</span> parameter <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;_parameter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parameter <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SimpleTypeRegistry</span><span class="token punctuation">.</span><span class="token function">isSimpleType</span><span class="token punctuation">(</span>parameter<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 计算 ognl 表达式的值</span>
      <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token class-name">OgnlCache</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> srtValue <span class="token operator">=</span> value <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// issue #274 return &quot;&quot; instead of &quot;null&quot;</span>
      <span class="token function">checkInjection</span><span class="token punctuation">(</span>srtValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> srtValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="ifsqlnode"><a href="#ifsqlnode" class="header-anchor">#</a> IfSqlNode</h5> <p><code>if</code> 标签用于在 <code>test</code> 条件生效时才追加标签内的文本。</p> <div class="language-xml extra-class"><pre class="language-xml"><code>  ...
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>userId &gt; 0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    AND user_id = #｛userId｝
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>IfSqlNode</code> 保存了 <code>if</code> 元素下的节点内容和 <code>test</code> 表达式，在生成有效 <code>sql</code> 时会根据 <code>OGNL</code> 工具计算 <code>test</code> 表达式是否生效。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">DynamicContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据 test 表达式判断当前节点是否生效</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>evaluator<span class="token punctuation">.</span><span class="token function">evaluateBoolean</span><span class="token punctuation">(</span>test<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      contents<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="trimsqlnode"><a href="#trimsqlnode" class="header-anchor">#</a> TrimSqlNode</h5> <p><code>trim</code> 标签用于解决动态 <code>sql</code> 中由于条件不同不能拼接正确语法的问题。</p> <div class="language-xml extra-class"><pre class="language-xml"><code>  SELECT * FROM test
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trim</span> <span class="token attr-name">prefix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>WHERE<span class="token punctuation">&quot;</span></span> <span class="token attr-name">prefixOverrides</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>AND|OR<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>a &gt; 0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      a = #{a}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>b &gt; 0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      OR b = #{b}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>c &gt; 0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      AND c = #{c}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trim</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>如果没有 <code>trim</code> 标签，这个 <code>statement</code> 的有效 <code>sql</code> 最终可能会是这样的：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test <span class="token operator">OR</span> b <span class="token operator">=</span> <span class="token comment">#{b}</span>
</code></pre></div><p>但是加上 <code>trim</code> 标签，生成的 <code>sql</code> 语法是正确的：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test <span class="token keyword">WHERE</span> b <span class="token operator">=</span> <span class="token comment">#{b}</span>
</code></pre></div><p><code>prefix</code> 属性用于指定 <code>trim</code> 节点生成的 <code>sql</code> 语句的前缀，<code>prefixOverrides</code> 则会指定生成的 <code>sql</code> 语句的前缀需要去除的部分，多个需要去除的前缀可以使用 <code>|</code> 隔开。<code>suffix</code> 与 <code>suffixOverrides</code> 的功能类似，但是作用于后缀。</p> <p><code>TrimSqlNode</code> 首先调用 <code>parseOverrides</code> 对 <code>prefixOverrides</code> 和 <code>suffixOverrides</code> 进行解析，通过 <code>|</code> 分隔，分别加入字符串集合。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">parseOverrides</span><span class="token punctuation">(</span><span class="token class-name">String</span> overrides<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>overrides <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 解析 token，按 | 分隔</span>
      <span class="token keyword">final</span> <span class="token class-name">StringTokenizer</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringTokenizer</span><span class="token punctuation">(</span>overrides<span class="token punctuation">,</span> <span class="token string">&quot;|&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">countTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">hasMoreTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 保存为字符串集合</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>ENGLISH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>在调用包含的 <code>SqlNode</code> 的 <code>apply</code> 方法后还会调用 <code>FilteredDynamicContext</code> 的 <code>applyAll</code> 方法处理前缀和后缀。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">DynamicContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">FilteredDynamicContext</span> filteredDynamicContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilteredDynamicContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> result <span class="token operator">=</span> contents<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>filteredDynamicContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 加上前缀和和后缀，并去除多余字段</span>
    filteredDynamicContext<span class="token punctuation">.</span><span class="token function">applyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>对于已经生成的 <code>sql</code> 文本，分别根据规则加上和去除指定前缀和后缀。</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">applyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sqlBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>sqlBuffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> trimmedUppercaseSql <span class="token operator">=</span> sqlBuffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>ENGLISH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>trimmedUppercaseSql<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 加上前缀和和后缀，并去除多余字段</span>
      <span class="token function">applyPrefix</span><span class="token punctuation">(</span>sqlBuffer<span class="token punctuation">,</span> trimmedUppercaseSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">applySuffix</span><span class="token punctuation">(</span>sqlBuffer<span class="token punctuation">,</span> trimmedUppercaseSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    delegate<span class="token punctuation">.</span><span class="token function">appendSql</span><span class="token punctuation">(</span>sqlBuffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">applyPrefix</span><span class="token punctuation">(</span><span class="token class-name">StringBuilder</span> sql<span class="token punctuation">,</span> <span class="token class-name">String</span> trimmedUppercaseSql<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prefixApplied<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      prefixApplied <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>prefixesToOverride <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 文本最前去除多余字段</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> toRemove <span class="token operator">:</span> prefixesToOverride<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>trimmedUppercaseSql<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>toRemove<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sql<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> toRemove<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 在文本最前插入前缀和空格</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>prefix <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sql<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sql<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">applySuffix</span><span class="token punctuation">(</span><span class="token class-name">StringBuilder</span> sql<span class="token punctuation">,</span> <span class="token class-name">String</span> trimmedUppercaseSql<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>suffixApplied<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      suffixApplied <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>suffixesToOverride <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 文本最后去除多余字段</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> toRemove <span class="token operator">:</span> suffixesToOverride<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>trimmedUppercaseSql<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span>toRemove<span class="token punctuation">)</span> <span class="token operator">||</span> trimmedUppercaseSql<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span>toRemove<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> start <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> toRemove<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> end <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sql<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 文本最后插入空格和后缀</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>suffix <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sql<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sql<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>suffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="wheresqlnode"><a href="#wheresqlnode" class="header-anchor">#</a> WhereSqlNode</h5> <p><code>where</code> 元素与 <code>trim</code> 元素的功能类似，区别在于 <code>where</code> 元素不提供属性配置可以处理的前缀和后缀。</p> <div class="language-xml extra-class"><pre class="language-xml"><code>  ...
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>where</span><span class="token punctuation">&gt;</span></span>
    ...
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>where</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>WhereSqlNode</code> 继承了 <code>TrimSqlNode</code>，并指定了需要添加和删除的前缀。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WhereSqlNode</span> <span class="token keyword">extends</span> <span class="token class-name">TrimSqlNode</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> prefixList <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;AND &quot;</span><span class="token punctuation">,</span><span class="token string">&quot;OR &quot;</span><span class="token punctuation">,</span><span class="token string">&quot;AND\n&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;OR\n&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;AND\r&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;OR\r&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;AND\t&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;OR\t&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">WhereSqlNode</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> configuration<span class="token punctuation">,</span> <span class="token class-name">SqlNode</span> contents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认添加 WHERE 前缀，去除 AND、OR 等前缀</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> contents<span class="token punctuation">,</span> <span class="token string">&quot;WHERE&quot;</span><span class="token punctuation">,</span> prefixList<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>因此，生成的 <code>sql</code> 语句会自动在最前加上 <code>WHERE</code>，并去除前缀中包含的 <code>AND</code>、<code>OR</code> 等字符串。</p> <h5 id="setsqlnode"><a href="#setsqlnode" class="header-anchor">#</a> SetSqlNode</h5> <p><code>set</code> 标签用于 <code>update</code> 语句中。</p> <div class="language-xml extra-class"><pre class="language-xml"><code>	UPDATE test
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>set</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>a &gt; 0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      a = #{a},
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>b &gt; 0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      b = #{b}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>set</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>SetSqlNode</code> 同样继承自 <code>TrimSqlNode</code>，并指定默认添加 <code>SET</code> 前缀，去除 <code>,</code> 前缀和后缀。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SetSqlNode</span> <span class="token keyword">extends</span> <span class="token class-name">TrimSqlNode</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> COMMA <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">SetSqlNode</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> configuration<span class="token punctuation">,</span><span class="token class-name">SqlNode</span> contents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认添加 SET 前缀，去除 , 前缀和后缀</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> contents<span class="token punctuation">,</span> <span class="token string">&quot;SET&quot;</span><span class="token punctuation">,</span> COMMA<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> COMMA<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h5 id="foreachsqlnode"><a href="#foreachsqlnode" class="header-anchor">#</a> ForEachSqlNode</h5> <p><code>foreach</code> 元素用于指定对集合循环添加 <code>sql</code> 语句。</p> <div class="language-xml extra-class"><pre class="language-xml"><code>...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreach</span> <span class="token attr-name">collection</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>list<span class="token punctuation">&quot;</span></span> <span class="token attr-name">item</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>index<span class="token punctuation">&quot;</span></span> <span class="token attr-name">open</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>(<span class="token punctuation">&quot;</span></span> <span class="token attr-name">close</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>)<span class="token punctuation">&quot;</span></span> <span class="token attr-name">separator</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>,<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  AND itm = #{item} AND idx #{index}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foreach</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>ForEachSqlNode</code> 解析生成有效 <code>sql</code> 的逻辑如下，除了计算 <code>collection</code> 表达式的值、添加前缀、后缀外，还将参数与索引进行了绑定。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">DynamicContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取绑定参数</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> bindings <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算 ognl 表达式获取可迭代对象</span>
    <span class="token keyword">final</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> iterable <span class="token operator">=</span> evaluator<span class="token punctuation">.</span><span class="token function">evaluateIterable</span><span class="token punctuation">(</span>collectionExpression<span class="token punctuation">,</span> bindings<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>iterable<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">boolean</span> first <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// 添加动态语句前缀</span>
    <span class="token function">applyOpen</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 迭代索引</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> o <span class="token operator">:</span> iterable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">DynamicContext</span> oldContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
      <span class="token comment">// 首个元素</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">||</span> separator <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrefixedContext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrefixedContext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> separator<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">int</span> uniqueNumber <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getUniqueNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Issue #709</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// entry 集合项索引为 key，集合项为 value</span>
        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
        <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> mapEntry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> o<span class="token punctuation">;</span>
        <span class="token function">applyIndex</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mapEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uniqueNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">applyItem</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mapEntry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uniqueNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 绑定集合项索引关系</span>
        <span class="token function">applyIndex</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> i<span class="token punctuation">,</span> uniqueNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 绑定集合项关系</span>
        <span class="token function">applyItem</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> o<span class="token punctuation">,</span> uniqueNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 对解析的表达式进行替换，如 idx = #{index} AND itm = #{item} 替换为 idx = #{__frch_index_1} AND itm = #{__frch_item_1}</span>
      contents<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FilteredDynamicContext</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> context<span class="token punctuation">,</span> index<span class="token punctuation">,</span> item<span class="token punctuation">,</span> uniqueNumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>first<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        first <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrefixedContext</span><span class="token punctuation">)</span> context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPrefixApplied</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      context <span class="token operator">=</span> oldContext<span class="token punctuation">;</span>
      i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 添加动态语句后缀</span>
    <span class="token function">applyClose</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 移除原始的表达式</span>
    context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 绑定集合项索引关系
   *
   * @param context
   * @param o
   * @param i
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">applyIndex</span><span class="token punctuation">(</span><span class="token class-name">DynamicContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      context<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>
      context<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">itemizeItem</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 绑定集合项关系
   *
   * @param context
   * @param o
   * @param i
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">applyItem</span><span class="token punctuation">(</span><span class="token class-name">DynamicContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      context<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>
      context<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">itemizeItem</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>对于循环中的 <code>#{}</code> 类型 <code>token</code>，<code>ForEachSqlNode</code> 在内部类 <code>FilteredDynamicContext</code> 中定义了解析规则：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">appendSql</span><span class="token punctuation">(</span><span class="token class-name">String</span> sql<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">GenericTokenParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericTokenParser</span><span class="token punctuation">(</span><span class="token string">&quot;#{&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;}&quot;</span><span class="token punctuation">,</span> content <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 对解析的表达式进行替换，如 idx = #{index} AND itm = #{item} 替换为 idx = #{__frch_index_1} AND itm = #{__frch_item_1}</span>
      <span class="token class-name">String</span> newContent <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replaceFirst</span><span class="token punctuation">(</span><span class="token string">&quot;^\\s*&quot;</span> <span class="token operator">+</span> item <span class="token operator">+</span> <span class="token string">&quot;(?![^.,:\\s])&quot;</span><span class="token punctuation">,</span> <span class="token function">itemizeItem</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>itemIndex <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> newContent<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newContent <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replaceFirst</span><span class="token punctuation">(</span><span class="token string">&quot;^\\s*&quot;</span> <span class="token operator">+</span> itemIndex <span class="token operator">+</span> <span class="token string">&quot;(?![^.,:\\s])&quot;</span><span class="token punctuation">,</span> <span class="token function">itemizeItem</span><span class="token punctuation">(</span>itemIndex<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token string">&quot;#{&quot;</span> <span class="token operator">+</span> newContent <span class="token operator">+</span> <span class="token string">&quot;}&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    delegate<span class="token punctuation">.</span><span class="token function">appendSql</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>类似 <code>idx = #{index} AND itm = #{item}</code> 会被替换为 <code>idx = #{__frch_index_1} AND itm = #{__frch_item_1}</code>，而 <code>ForEachSqlNode</code> 也做了参数与索引的绑定，因此在替换时可以快速绑定参数。</p> <h5 id="choosesqlnode"><a href="#choosesqlnode" class="header-anchor">#</a> ChooseSqlNode</h5> <p><code>choose</code> 元素用于生成带默认 <code>sql</code> 文本的语句，当 <code>when</code> 元素中的条件都不生效，就可以使用 <code>otherwise</code> 元素的默认文本。</p> <div class="language-xml extra-class"><pre class="language-xml"><code>  ...
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>choose</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>when</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>a &gt; 0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    	AND a = #{a}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>when</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>otherwise</span><span class="token punctuation">&gt;</span></span>
    	AND b = #{b}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>otherwise</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>choose</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>ChooseSqlNode</code> 是由 <code>choose</code> 节点和 <code>otherwise</code> 节点组合而成的，在生成有效 <code>sql</code> 于语句时会逐个计算 <code>when</code> 节点的 <code>test</code> 表达式，如果返回 <code>true</code> 则生效当前 <code>when</code> 语句中的 <code>sql</code>。如果均不生效则使用 <code>otherwise</code> 语句对应的默认 <code>sql</code> 文本。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">DynamicContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// when 节点根据 test 表达式判断是否生效</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SqlNode</span> sqlNode <span class="token operator">:</span> ifSqlNodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlNode<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// when 节点如果都未生效，且存在 otherwise 节点，则使用 otherwise 节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultSqlNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    defaultSqlNode<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="vardeclsqlnode"><a href="#vardeclsqlnode" class="header-anchor">#</a> VarDeclSqlNode</h5> <p><code>bind</code> 元素用于绑定一个 <code>OGNL</code> 表达式到一个动态 <code>sql</code> 变量中。</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bind</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>pattern<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">'</span>%' + _parameter.getTitle() + '%'<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p><code>VarDeclSqlNode</code> 会计算表达式的值并将参数名和值绑定到参数容器中。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">DynamicContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 解析 ognl 表达式</span>
  <span class="token keyword">final</span> <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token class-name">OgnlCache</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>expression<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 绑定参数</span>
  context<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="创建解析对象与生成可执行-sql"><a href="#创建解析对象与生成可执行-sql" class="header-anchor">#</a> 创建解析对象与生成可执行 sql</h3> <p><code>statemen</code> 解析完毕后会创建 <code>MappedStatement</code> 对象，<code>statement</code> 的相关属性以及生成的 <code>sql</code> 创建对象都会被保存到该对象中。<code>MappedStatement</code> 还提供了 <code>getBoundSql</code> 方法用于获取可执行 sql 和参数绑定对象，即 <code>BoundSql</code> 对象。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">BoundSql</span> <span class="token function">getBoundSql</span><span class="token punctuation">(</span><span class="token class-name">Object</span> parameterObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 生成可执行 sql 和参数绑定对象</span>
  <span class="token class-name">BoundSql</span> boundSql <span class="token operator">=</span> sqlSource<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取参数映射</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ParameterMapping</span><span class="token punctuation">&gt;</span></span> parameterMappings <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getParameterMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parameterMappings <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> parameterMappings<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    boundSql <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BoundSql</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> boundSql<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parameterMap<span class="token punctuation">.</span><span class="token function">getParameterMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// check for nested result maps in parameter mappings (issue #30)</span>
  <span class="token comment">// 检查是否有嵌套的 resultMap</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ParameterMapping</span> pm <span class="token operator">:</span> boundSql<span class="token punctuation">.</span><span class="token function">getParameterMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> rmId <span class="token operator">=</span> pm<span class="token punctuation">.</span><span class="token function">getResultMapId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rmId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">ResultMap</span> rm <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getResultMap</span><span class="token punctuation">(</span>rmId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hasNestedResultMaps <span class="token operator">|=</span> rm<span class="token punctuation">.</span><span class="token function">hasNestedResultMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> boundSql<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>BoundSql</code> 对象由 <code>DynamicSqlSource</code> 的 <code>getBoundSql</code> 方法生成，在验证各个 <code>sql</code> 节点，生成了有效 <code>sql</code> 后会继续调用 <code>SqlSourceBuilder</code> 将 <code>sql</code> 解析为 <code>StaticSqlSource</code>，即可执行 <code>sql</code>。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">BoundSql</span> <span class="token function">getBoundSql</span><span class="token punctuation">(</span><span class="token class-name">Object</span> parameterObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DynamicContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicContext</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 验证各 sql 节点，生成有效 sql</span>
    rootSqlNode<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SqlSourceBuilder</span> sqlSourceParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSourceBuilder</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> parameterType <span class="token operator">=</span> parameterObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">:</span> parameterObject<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将生成的 sql 文本解析为 StaticSqlSource</span>
    <span class="token class-name">SqlSource</span> sqlSource <span class="token operator">=</span> sqlSourceParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parameterType<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BoundSql</span> boundSql <span class="token operator">=</span> sqlSource<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>boundSql<span class="token operator">:</span><span class="token operator">:</span><span class="token function">setAdditionalParameter</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> boundSql<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>此时的 <code>sql</code> 文本中仍包含 <code>#{}</code> 类型 <code>token</code>，需要通过 <code>ParameterMappingTokenHandler</code> 进行解析。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token class-name">SqlSource</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">String</span> originalSql<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> parameterType<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> additionalParameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ParameterMappingTokenHandler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParameterMappingTokenHandler</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> parameterType<span class="token punctuation">,</span> additionalParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建 #{} 类型 token 搜索对象</span>
    <span class="token class-name">GenericTokenParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericTokenParser</span><span class="token punctuation">(</span><span class="token string">&quot;#{&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;}&quot;</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 解析 token</span>
    <span class="token class-name">String</span> sql <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>originalSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建静态 sql 生成对象，并绑定参数</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StaticSqlSource</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> sql<span class="token punctuation">,</span> handler<span class="token punctuation">.</span><span class="token function">getParameterMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>token</code> 的具体解析逻辑为根据表达式的参数名生成对应的参数映射对象，并将表达式转为预编译 <code>sql</code> 的占位符 <code>?</code>。</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handleToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建参数映射对象</span>
    parameterMappings<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">buildParameterMapping</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将表达式转为预编译 sql 占位符</span>
    <span class="token keyword">return</span> <span class="token string">&quot;?&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>最终解析完成的 <code>sql</code> 与参数映射关系集合包装为 <code>StaticSqlSource</code> 对象，该对象在随后的逻辑中通过构造方法创建了 <code>BoundSql</code> 对象。</p> <h2 id="接口解析"><a href="#接口解析" class="header-anchor">#</a> 接口解析</h2> <p>除了使用 <code>xml</code> 方式配置 <code>statement</code>，<code>MyBatis</code> 同样支持使用 <code>Java</code> 注解配置。但是相对于 <code>xml</code> 的映射方式，将动态 <code>sql</code> 写在 <code>Java</code> 代码中是不合适的。如果在配置文件中指定了需要注册 <code>Mapper</code> 接口的类或包，<code>MyBatis</code> 会扫描相关类进行注册；在 <code>Mapper</code> 文件解析完成后也会尝试加载 <code>namespace</code> 的同名类，如果存在，则注册为 <code>Mapper</code> 接口。</p> <p>无论是绑定还是直接注册 <code>Mapper</code> 接口，都是调用 <code>MapperAnnotationBuilder#parse</code> 方法来解析的。此方法中的解析方式与上述 <code>xml</code> 解析方式大致相同，区别只在于相关配置参数是从注解中获取而不是从 <code>xml</code> 元素属性中获取。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">addMapper</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasMapper</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 不允许相同接口重复注册</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">&quot;Type &quot;</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">&quot; is already known to the MapperRegistry.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">boolean</span> loadCompleted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        knownMappers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MapperProxyFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// It's important that the type is added before the parser is run</span>
        <span class="token comment">// otherwise the binding may automatically be attempted by the</span>
        <span class="token comment">// mapper parser. If the type is already known, it won't try.</span>
        <span class="token class-name">MapperAnnotationBuilder</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapperAnnotationBuilder</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        loadCompleted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loadCompleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          knownMappers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p><code>statement</code> 解析的最终目的是为每个 <code>statement</code> 创建一个 <code>MappedStatement</code> 对象保存相关定义，在 <code>sql</code> 执行时根据传入参数动态获取可执行 <code>sql</code> 和参数绑定对象。</p> <ul><li><code>org.apache.ibatis.builder.xml.XMLStatementBuilder</code>：解析 <code>Mapper</code> 文件中的 <code>select|insert|update|delete</code> 元素。</li> <li><code>org.apache.ibatis.parsing.GenericTokenParser.GenericTokenParser</code>：搜索指定格式 <code>token</code> 并进行解析。</li> <li><code>org.apache.ibatis.parsing.TokenHandler</code>：<code>token</code> 处理器抽象接口。定义 <code>token</code> 以何种方式被解析。</li> <li><code>org.apache.ibatis.parsing.PropertyParser</code>：<code>${}</code> 类型 <code>token</code> 解析器。</li> <li><code>org.apache.ibatis.session.Configuration.StrictMap</code>：封装 <code>HashMap</code>，对键值存取有严格要求。</li> <li><code>org.apache.ibatis.builder.xml.XMLIncludeTransformer</code>：<code>include</code> 元素解析器。</li> <li><code>org.apache.ibatis.mapping.SqlSource</code>：<code>sql</code> 生成抽象接口。根据传入参数生成有效 <code>sql</code> 语句和参数绑定对象。</li> <li><code>org.apache.ibatis.scripting.xmltags.XMLScriptBuilder</code>：解析 <code>statement</code> 各个 <code>sql</code> 节点并进行组合。</li> <li><code>org.apache.ibatis.scripting.xmltags.SqlNode</code>：<code>sql</code> 节点抽象接口。用于判断当前 <code>sql</code> 节点是否可以加入到生效的 sql 语句中。</li> <li><code>org.apache.ibatis.scripting.xmltags.DynamicContext</code>：动态 <code>sql</code> 上下文。用于保存绑定参数和生效 <code>sql</code> 节点。</li> <li><code>org.apache.ibatis.scripting.xmltags.OgnlCache</code>：<code>ognl</code> 缓存工具，缓存表达式编译结果。</li> <li><code>org.apache.ibatis.scripting.xmltags.ExpressionEvaluator</code>：<code>ognl</code> 表达式计算工具。</li> <li><code>org.apache.ibatis.scripting.xmltags.MixedSqlNode</code>：<code>sql</code> 节点组合对象。</li> <li><code>org.apache.ibatis.scripting.xmltags.StaticTextSqlNode</code>：静态 <code>sql</code> 节点对象。</li> <li><code>org.apache.ibatis.scripting.xmltags.TextSqlNode</code>：<code>${}</code> 类型 <code>sql</code> 节点对象。</li> <li><code>org.apache.ibatis.scripting.xmltags.IfSqlNode</code>：<code>if</code> 元素 <code>sql</code> 节点对象。</li> <li><code>org.apache.ibatis.scripting.xmltags.TrimSqlNode</code>：<code>trim</code> 元素 <code>sql</code> 节点对象。</li> <li><code>org.apache.ibatis.scripting.xmltags.WhereSqlNode</code>：<code>where</code> 元素 <code>sql</code> 节点对象。</li> <li><code>org.apache.ibatis.scripting.xmltags.SetSqlNode</code>：<code>set</code> 元素 <code>sql</code> 节点对象。</li> <li><code>org.apache.ibatis.scripting.xmltags.ForEachSqlNode</code>：<code>foreach</code> 元素 <code>sql</code> 节点对象。</li> <li><code>org.apache.ibatis.scripting.xmltags.ChooseSqlNode</code>：<code>choose</code> 元素 <code>sql</code> 节点对象。</li> <li><code>org.apache.ibatis.scripting.xmltags.VarDeclSqlNode</code>：<code>bind</code> 元素 <code>sql</code> 节点对象。</li> <li><code>org.apache.ibatis.mapping.MappedStatement</code>：<code>statement</code> 解析对象。</li> <li><code>org.apache.ibatis.mapping.BoundSql</code>：可执行 <code>sql</code> 和参数绑定对象。</li> <li><code>org.apache.ibatis.scripting.xmltags.DynamicSqlSource</code>：根据参数动态生成有效 <code>sql</code> 和绑定参数。</li> <li><code>org.apache.ibatis.builder.SqlSourceBuilder</code>：解析 <code>#{}</code> 类型 <code>token</code> 并绑定参数对象。</li></ul> <h2 id="注释源码"><a href="#注释源码" class="header-anchor">#</a> 注释源码</h2> <p><a href="https://github.com/wch853/mybatis-3" target="_blank" rel="noopener noreferrer">注释源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/posts/mybatis/MyBatis源码分析（五）：Mapper通用配置解析.html" class="prev">MyBatis 源码分析（五）：Mapper 通用配置解析</a></span> <span class="next"><a href="/posts/mybatis/MyBatis源码分析（七）：接口层.html">MyBatis 源码分析（七）：接口层</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.15a66b26.js" defer></script><script src="/assets/js/2.92cd0f37.js" defer></script><script src="/assets/js/37.22e4179e.js" defer></script>
  </body>
</html>

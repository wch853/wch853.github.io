<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用云开发构建多媒体小程序 | wch的个人主页</title>
    <meta name="description" content="用于分享wch的学习笔记和项目~">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.74c45c5d.css" as="style"><link rel="preload" href="/assets/js/app.15a66b26.js" as="script"><link rel="preload" href="/assets/js/2.92cd0f37.js" as="script"><link rel="preload" href="/assets/js/29.de1da78b.js" as="script"><link rel="prefetch" href="/assets/js/10.1166f652.js"><link rel="prefetch" href="/assets/js/11.b6ae0b14.js"><link rel="prefetch" href="/assets/js/12.7802c7ba.js"><link rel="prefetch" href="/assets/js/13.63066938.js"><link rel="prefetch" href="/assets/js/14.1f9fa0d5.js"><link rel="prefetch" href="/assets/js/15.6c758eca.js"><link rel="prefetch" href="/assets/js/16.58440a84.js"><link rel="prefetch" href="/assets/js/17.1e1f5c53.js"><link rel="prefetch" href="/assets/js/18.28115609.js"><link rel="prefetch" href="/assets/js/19.7e395424.js"><link rel="prefetch" href="/assets/js/20.2c2ea5f8.js"><link rel="prefetch" href="/assets/js/21.1e8ef167.js"><link rel="prefetch" href="/assets/js/22.47a8f5b7.js"><link rel="prefetch" href="/assets/js/23.f507c548.js"><link rel="prefetch" href="/assets/js/24.b19f43b8.js"><link rel="prefetch" href="/assets/js/25.5b1882b0.js"><link rel="prefetch" href="/assets/js/26.16cf6f8a.js"><link rel="prefetch" href="/assets/js/27.6f3498d0.js"><link rel="prefetch" href="/assets/js/28.f56b7e3c.js"><link rel="prefetch" href="/assets/js/3.73d3287d.js"><link rel="prefetch" href="/assets/js/30.108b25a0.js"><link rel="prefetch" href="/assets/js/31.68af7d35.js"><link rel="prefetch" href="/assets/js/32.c9f05837.js"><link rel="prefetch" href="/assets/js/33.13bd6f64.js"><link rel="prefetch" href="/assets/js/34.59041fd7.js"><link rel="prefetch" href="/assets/js/35.4382a261.js"><link rel="prefetch" href="/assets/js/36.01d6324a.js"><link rel="prefetch" href="/assets/js/37.22e4179e.js"><link rel="prefetch" href="/assets/js/38.f553994e.js"><link rel="prefetch" href="/assets/js/39.a72bb5df.js"><link rel="prefetch" href="/assets/js/4.9a52aae5.js"><link rel="prefetch" href="/assets/js/40.3751cd34.js"><link rel="prefetch" href="/assets/js/41.d351ec5d.js"><link rel="prefetch" href="/assets/js/42.b87a3eae.js"><link rel="prefetch" href="/assets/js/43.7035de8a.js"><link rel="prefetch" href="/assets/js/44.2c18f0bc.js"><link rel="prefetch" href="/assets/js/45.52905280.js"><link rel="prefetch" href="/assets/js/46.abb047a4.js"><link rel="prefetch" href="/assets/js/47.2ac230d3.js"><link rel="prefetch" href="/assets/js/48.b63bb42b.js"><link rel="prefetch" href="/assets/js/49.35752ae9.js"><link rel="prefetch" href="/assets/js/5.36029518.js"><link rel="prefetch" href="/assets/js/50.b6bd912f.js"><link rel="prefetch" href="/assets/js/51.0e0db65f.js"><link rel="prefetch" href="/assets/js/52.d15fb17a.js"><link rel="prefetch" href="/assets/js/53.844345be.js"><link rel="prefetch" href="/assets/js/54.52685e8c.js"><link rel="prefetch" href="/assets/js/55.83a99fe0.js"><link rel="prefetch" href="/assets/js/56.fe26d3a3.js"><link rel="prefetch" href="/assets/js/57.dae36566.js"><link rel="prefetch" href="/assets/js/58.1bfd28b1.js"><link rel="prefetch" href="/assets/js/59.88f55364.js"><link rel="prefetch" href="/assets/js/6.d3b55a54.js"><link rel="prefetch" href="/assets/js/7.af0443ed.js"><link rel="prefetch" href="/assets/js/8.2c9a7ea2.js"><link rel="prefetch" href="/assets/js/9.c08dcf83.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74c45c5d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">wch的个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java虚拟机</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java并发编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis 源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring Security 源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>微信小程序</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/mp/使用云开发构建多媒体小程序.html" class="active sidebar-link">使用云开发构建多媒体小程序</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/mp/使用云开发构建多媒体小程序.html#小程序·云开发" class="sidebar-link">小程序·云开发</a></li><li class="sidebar-sub-header"><a href="/posts/mp/使用云开发构建多媒体小程序.html#初始化小程序·云开发" class="sidebar-link">初始化小程序·云开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/mp/使用云开发构建多媒体小程序.html#注册小程序" class="sidebar-link">注册小程序</a></li><li class="sidebar-sub-header"><a href="/posts/mp/使用云开发构建多媒体小程序.html#创建小程序项目" class="sidebar-link">创建小程序项目</a></li><li class="sidebar-sub-header"><a href="/posts/mp/使用云开发构建多媒体小程序.html#建立云开发环境" class="sidebar-link">建立云开发环境</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/mp/使用云开发构建多媒体小程序.html#云开发环境" class="sidebar-link">云开发环境</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/mp/使用云开发构建多媒体小程序.html#云开发控制台" class="sidebar-link">云开发控制台</a></li><li class="sidebar-sub-header"><a href="/posts/mp/使用云开发构建多媒体小程序.html#数据库" class="sidebar-link">数据库</a></li><li class="sidebar-sub-header"><a href="/posts/mp/使用云开发构建多媒体小程序.html#存储" class="sidebar-link">存储</a></li><li class="sidebar-sub-header"><a href="/posts/mp/使用云开发构建多媒体小程序.html#云函数" class="sidebar-link">云函数</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/mp/使用云开发构建多媒体小程序.html#开发多媒体服务" class="sidebar-link">开发多媒体服务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/mp/使用云开发构建多媒体小程序.html#引入-iview-webapp" class="sidebar-link">引入 iView Webapp</a></li><li class="sidebar-sub-header"><a href="/posts/mp/使用云开发构建多媒体小程序.html#封装媒体-api" class="sidebar-link">封装媒体 API</a></li><li class="sidebar-sub-header"><a href="/posts/mp/使用云开发构建多媒体小程序.html#页面布局" class="sidebar-link">页面布局</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Elasticsearch</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="使用云开发构建多媒体小程序"><a href="#使用云开发构建多媒体小程序" class="header-anchor">#</a> 使用云开发构建多媒体小程序</h1> <h2 id="小程序·云开发"><a href="#小程序·云开发" class="header-anchor">#</a> 小程序·云开发</h2> <p>什么是小程序的云开发？一句话就是能够使开发者省去搭建服务器、申请域名的成本，从开发到运维提供整套解决方案的小程序开发方式。
官方定义是，<a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html" target="_blank" rel="noopener noreferrer">小程序·云开发<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>为开发者提供完整的云端支持，弱化后端和运维概念，无需搭建服务器，使用平台提供的 API 进行核心业务开发，即可实现快速上线和迭代。
相对于传统小程序开发，云开发新提供了三大基础支持：</p> <ul><li>云函数：在云端运行的代码，微信私有协议天然鉴权，开发者只需编写自身业务逻辑代码</li> <li>数据库：一个既可在小程序前端操作，也能在云函数中读写的 JSON 数据库</li> <li>存储：在小程序前端直接上传/下载云端文件，在云开发控制台可视化管理</li></ul> <p>由此开发者只需在小程序端调用 API 即可搭建简单的后端服务，无需考虑搭建服务器、申请合法域名带来的成本。云开发环境免费版对资源有一定限制，但在用户量不大的情况下可以提供稳定的服务，相对于真正的后端服务，云开发环境还集成了控制台，提供了运维的有效手段。</p> <h2 id="初始化小程序·云开发"><a href="#初始化小程序·云开发" class="header-anchor">#</a> 初始化小程序·云开发</h2> <h3 id="注册小程序"><a href="#注册小程序" class="header-anchor">#</a> 注册小程序</h3> <p>登录<a href="https://mp.weixin.qq.com/" target="_blank" rel="noopener noreferrer">微信公众平台<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，使用邮箱注册并激活小程序。进入小程序管理后台首页填写小程序信息，并添加开发者，详情见<a href="https://developers.weixin.qq.com/miniprogram/introduction/#%E6%B3%A8%E5%86%8C%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%B8%90%E5%8F%B7" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="创建小程序项目"><a href="#创建小程序项目" class="header-anchor">#</a> 创建小程序项目</h3> <ul><li>进入<a href="https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html" target="_blank" rel="noopener noreferrer">微信 web 开发者工具<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>下载页，下载开发工具并安装。</li> <li>进入小程序管理后台-设置-开发设置，获取小程序的 AppID，新建小程序项目，选择 <code>建立云开发快速启动模板</code>，详情见<a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html" target="_blank" rel="noopener noreferrer">小程序·云开发<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>文档。</li></ul> <h3 id="建立云开发环境"><a href="#建立云开发环境" class="header-anchor">#</a> 建立云开发环境</h3> <ul><li>在开发者工具工具栏左侧，点击 <code>云开发</code> 开通云开发功能。每个小程序免费提供两个环境，首先创建名为 <code>test</code> 的云环境。复制自动生成的环境 ID，编辑 <code>miniprogram</code> 文件夹下的 <code>app.js</code>，添加 <code>env</code> 参数。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  traceUser<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  env<span class="token punctuation">:</span> <span class="token string">&quot;test-xxx&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>选择 <code>cloudfunctions</code> 文件夹，设置当前环境为 <code>test</code>。</li> <li>编译小程序，如控制台无报错，则环境连接正常。</li></ul> <h2 id="云开发环境"><a href="#云开发环境" class="header-anchor">#</a> 云开发环境</h2> <p>云开发提供了一整套云服务及简单、易用的 API 和管理界面，以尽可能降低后端开发成本，让开发者能够专注于核心业务逻辑的开发、尽可能轻松的完成后端的操作和管理。这套云环境包括数据库、存储和云函数。</p> <h3 id="云开发控制台"><a href="#云开发控制台" class="header-anchor">#</a> 云开发控制台</h3> <p>云开发控制台提供了云开发的管理界面和运维工具，开发者可以通过操作控制台来查看环境使用情况、操作数据库、存储、管理云函数等。
<img src="/img/mp/%E4%BA%91%E5%BC%80%E5%8F%91%E6%8E%A7%E5%88%B6%E5%8F%B0.jpg" alt="云开发控制台"></p> <h3 id="数据库"><a href="#数据库" class="header-anchor">#</a> 数据库</h3> <p>云开发环境提供一个文档<a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-client-api/database/" target="_blank" rel="noopener noreferrer">数据库<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，其 API 和功能类似于 MongoDB。进入控制台的数据库选项，新建一个集合。集合中每条数据都是 JSON 格式的。
<img src="/img/mp/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86.jpg" alt="数据库管理"></p> <ul><li>权限控制：小程序端操作数据库时，读写数据受权限控制限制。写入的记录会默认增加写入用户的 <code>_openid</code>，如果需要所有用户对数据有读权限，需要更改权限为 <code>所有用户可读，仅创建者及管理员可写</code></li> <li>对数据库 API 进行封装</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 云db对象</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 新增记录
   *
   * @param data 数据
   * @param collection 集合
   * @return {&quot;_id&quot;: String, &quot;errMsg&quot;: String}
   */</span>
  <span class="token function-variable function">add</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> collection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      data<span class="token punctuation">:</span> data
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 查询记录
   *
   * @param collection 集合
   * @param where 查询条件
   * @param skip 查询起始位置
   * @param limit 查询数量
   * @return {&quot;data&quot;: Array, &quot;errMsg&quot;: String}
   */</span>
  <span class="token function-variable function">query</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">collection<span class="token punctuation">,</span> where<span class="token punctuation">,</span> skip<span class="token punctuation">,</span> limit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    where <span class="token operator">=</span> where <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    skip <span class="token operator">=</span> skip <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
    limit <span class="token operator">=</span> limit <span class="token operator">||</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> db
      <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>where<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;desc&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>skip<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 查询记录数量
   *
   * @param collection 集合
   * @param where 查询条件
   * @return {&quot;total&quot;: Number, &quot;errMsg&quot;: String}
   */</span>
  <span class="token function-variable function">count</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">collection<span class="token punctuation">,</span> where</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    where <span class="token operator">=</span> where <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> db
      <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>where<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 新增/全部更新文档
   *
   * @param collection 集合
   * @param doc 文档_id
   * @param data 数据
   * @return {&quot;_id&quot;: String, &quot;errMsg&quot;: String}
   */</span>
  <span class="token function-variable function">addDoc</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">collection<span class="token punctuation">,</span> doc<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    collection <span class="token operator">=</span> collection <span class="token operator">||</span> lovc<span class="token punctuation">;</span>
    <span class="token keyword">return</span> db
      <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        data<span class="token punctuation">:</span> data
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 查询文档
   *
   * @param collection 集合
   * @param doc 文档_id
   * @return {&quot;data&quot;: Object, &quot;errMsg&quot;: String}
   */</span>
  <span class="token function-variable function">getDoc</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">collection<span class="token punctuation">,</span> doc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    collection <span class="token operator">=</span> collection <span class="token operator">||</span> lovc<span class="token punctuation">;</span>
    <span class="token keyword">return</span> db
      <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 部分更新文档
   *
   * @param collection 集合
   * @param doc 文档_id
   * @param data 数据
   * @return {&quot;stats&quot;: Object, &quot;errMsg&quot;: String}
   */</span>
  <span class="token function-variable function">update</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">collection<span class="token punctuation">,</span> doc<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    collection <span class="token operator">=</span> collection <span class="token operator">||</span> lovc<span class="token punctuation">;</span>
    <span class="token keyword">return</span> db
      <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        data<span class="token punctuation">:</span> data
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 删除文档
   *
   * @param collection 集合
   * @param doc 文档_id
   * @return {&quot;stats&quot;: Object, &quot;errMsg&quot;: String}
   */</span>
  <span class="token function-variable function">remove</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">collection<span class="token punctuation">,</span> doc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    collection <span class="token operator">=</span> collection <span class="token operator">||</span> lovc<span class="token punctuation">;</span>
    <span class="token keyword">return</span> db
      <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="存储"><a href="#存储" class="header-anchor">#</a> 存储</h3> <p>云环境提供了免费的 5G 云<a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-client-api/storage/" target="_blank" rel="noopener noreferrer">存储<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>空间，文件上传后每个文件会生成一个 <code>fileID</code> 和一个 <code>https</code> 下载地址，在小程序中，<code>src</code> 、 <code>poster</code> 等属性中都可以直接使用。
<img src="/img/mp/%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86.png" alt="存储管理"></p> <ul><li>对存储 API 进行封装</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 上传文件
   *
   * @param fileName 文件名
   * @param filePath 文件路径
   * @return {&quot;errMsg&quot;: String, &quot;fileID&quot;: String, &quot;statusCode&quot;: Number}
   */</span>
  <span class="token function-variable function">upload</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fileName<span class="token punctuation">,</span> filePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      cloudPath<span class="token punctuation">:</span> fileName<span class="token punctuation">,</span>
      filePath<span class="token punctuation">:</span> filePath
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 下载文件
   *
   * @param fileID 文件名
   * @return {&quot;tempFilePath&quot;: String, &quot;statusCode&quot;: Number}
   */</span>
  <span class="token function-variable function">download</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fileID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">downloadFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      fileID<span class="token punctuation">:</span> fileID
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="云函数"><a href="#云函数" class="header-anchor">#</a> 云函数</h3> <p><a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions.html" target="_blank" rel="noopener noreferrer">云函数<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>即在云端（服务器端）运行的函数。通过使用云函数，开发者无需购买、搭建服务器，只需编写函数代码并部署到云端即可在小程序端调用，同时云函数之间也可互相调用。云函数本身是一个本地定义的 JS 方法，上传并部署到指定云环境中，运行在云端的 <code>NodeJS</code> 中。云函数调用时用户的 <code>openid</code> 会作为请求参数进行调用，从而能够与微信鉴权无缝结合。</p> <h4 id="创建云函数"><a href="#创建云函数" class="header-anchor">#</a> 创建云函数</h4> <ul><li>本地环境： 云函数依赖本地 <code>NodeJS</code> 环境，可以通过 <code>npm</code> 对服务进行扩展</li> <li>REST 调用：传统小程序开发的后端服务需要合法域名，这就为小程序开发带来了额外成本，而云函数通过 <code>http</code> 调用服务是无需鉴别域名的，因此可以通过小程序端调用云函数，云端调用远程服务的方式拓展低成本的 <code>REST服务</code></li> <li>tcb-router：<a href="https://www.npmjs.com/package/tcb-router" target="_blank" rel="noopener noreferrer">tcb-router<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是由腾讯官方提供的基于 <code>koa</code> 风格的云函数轻量级类路由库，主要用于优化服务端函数处理逻辑。云函数允许创建的数量是有限的，通过 <code>tcb-router</code> 可以对服务数量进行拓展</li> <li>选择小程序中的 <code>cloudfunctions</code> 文件夹，<code>新建Node.js云函数</code>，本地会自动生成云函数模板文件和 <code>package.json</code>，并安装 <code>wx-server-sdk</code> 依赖
<img src="/img/mp/%E5%88%9B%E5%BB%BA%E4%BA%91%E5%87%BD%E6%95%B0.png" alt="创建云函数"></li> <li>选择云函数所在文件夹，进入终端，通过 <code>npm</code> 安装所需依赖</li> <li>编辑云函数（REST 服务）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 云函数入口文件</span>
<span class="token keyword">const</span> cloud <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;wx-server-sdk&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;request-promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cloud<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 云函数入口函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">get</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>url<span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">post</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>url<span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * GET请求
 *
 * @param url REST服务地址
 * @param data 请求参数
 */</span>
<span class="token keyword">function</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">undefined</span> <span class="token operator">!==</span> data <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;&quot;</span> <span class="token operator">!==</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> queryString <span class="token operator">=</span> <span class="token string">&quot;?&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queryString<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        queryString <span class="token operator">=</span> queryString<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      queryString <span class="token operator">=</span> queryString
        <span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot;=&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>queryString<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">rp</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * POST请求
 *
 * @param url REST服务地址
 * @param data 请求参数
 */</span>
<span class="token keyword">function</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">rp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    uri<span class="token punctuation">:</span> url<span class="token punctuation">,</span>
    method<span class="token punctuation">:</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span>
    body<span class="token punctuation">:</span> data<span class="token punctuation">,</span>
    json<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>编辑云函数（tcb-router）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 云函数入口文件</span>
<span class="token keyword">const</span> cloud <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;wx-server-sdk&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> TcbRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tcb-router&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cloud<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 云函数入口函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TcbRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    event
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// app.use 表示该中间件会适用于所有的路由</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建返回data对象</span>
    ctx<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行下一中间件</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 路由为数组表示，该中间件适用于多个路由</span>
  <span class="token comment">// app.router(['x', 'y'], async (ctx, next) =&gt; {</span>
  <span class="token comment">//   ctx.data.from = 'cloud';</span>
  <span class="token comment">//   await next();</span>
  <span class="token comment">// });</span>

  app<span class="token punctuation">.</span><span class="token function">router</span><span class="token punctuation">(</span>
    <span class="token string">&quot;router&quot;</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>data<span class="token punctuation">.</span>openId <span class="token operator">=</span> event<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>openId<span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>data<span class="token punctuation">.</span>other <span class="token operator">=</span> event<span class="token punctuation">.</span>other<span class="token punctuation">;</span>
      <span class="token comment">// ctx.body 返回数据到小程序端</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        code<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>data
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> app<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>选择云函数所在文件夹，<code>上传并部署</code> 云函数，在小程序端可以通过<a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-client-api/functions/callFunction.html" target="_blank" rel="noopener noreferrer">云函数调用<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>访问服务</li> <li>对云函数 API 进行封装</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 通过云函数访问服务
   *
   * @param name 云函数名
   * @param params 参数
   * @return {&quot;errMsg&quot;: String, &quot;result&quot;: Object, &quot;requestID&quot;: String}
   */</span>
  <span class="token function-variable function">call</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> name<span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> params
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 通过tcb-router访问服务
   *
   * @param url router路径
   * @param params 参数
   * @return {&quot;errMsg&quot;: String, &quot;result&quot;: String, &quot;requestID&quot;: String}
   */</span>
  <span class="token function-variable function">tcbRouter</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    params<span class="token punctuation">.</span>$url <span class="token operator">=</span> url<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;router&quot;</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 云函数-REST访问服务
   *
   * @param url REST服务地址
   * @param 请求方法
   * @param params 请求参数
   * @return {&quot;errMsg&quot;: String, &quot;result&quot;: String, &quot;requestID&quot;: String}
   */</span>
  <span class="token function-variable function">rest</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> method<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;rest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      url<span class="token punctuation">:</span> url<span class="token punctuation">,</span>
      method<span class="token punctuation">:</span> method<span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> params
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="开发多媒体服务"><a href="#开发多媒体服务" class="header-anchor">#</a> 开发多媒体服务</h2> <h3 id="引入-iview-webapp"><a href="#引入-iview-webapp" class="header-anchor">#</a> 引入 iView Webapp</h3> <p>引入<a href="https://weapp.iviewui.com/docs/guide/start" target="_blank" rel="noopener noreferrer">iView Webapp<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>作为小程序的前端框架。</p> <ul><li>进入的 <code>iView Webapp</code> 的<a href="https://github.com/TalkingData/iview-weapp" target="_blank" rel="noopener noreferrer">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，下载项目</li></ul> <div class="language- extra-class"><pre class="language-text"><code># clone iView Weapp
git clone https://github.com/TalkingData/iview-weapp.git
cd iview-weapp
# 安装依赖
npm install
# 编译组件，便于打开到模拟器查看
npm run dev
</code></pre></div><ul><li>将 <code>dist</code> 文件夹拷贝到小程序项目的 <code>miniprogram</code> 文件夹下</li> <li>通过开发工具打开 <code>iView Webapp</code> 项目下的 <code>examples</code> 目录，预览 <code>iView Webapp</code> 提供的组件。</li></ul> <h3 id="封装媒体-api"><a href="#封装媒体-api" class="header-anchor">#</a> 封装媒体 API</h3> <p>与云开发原生支持 <code>Promise</code> 不同，原生小程序 API 只能通过回调获取返回值，对于项目中使用的相关小程序的媒体 API 进行封装，避免多层回调。</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 选择照片
   *
   * @return {&quot;errMsg&quot;: String, &quot;tempFilePaths&quot;: Array(String), &quot;tempFiles&quot;: Array(Obejct)}
   */</span>
  <span class="token function-variable function">chooseImage</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      wx<span class="token punctuation">.</span><span class="token function">chooseImage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        count<span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
        sizeType<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;original&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;compressed&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        sourceType<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;album&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 全屏预览照片
   *
   * @param current 当前显示图片的链接
   * @param urls 需要预览的图片链接列表（云文件ID @since 2.2.3）
   */</span>
  <span class="token function-variable function">previewImage</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> urls</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      wx<span class="token punctuation">.</span><span class="token function">previewImage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        current<span class="token punctuation">:</span> current<span class="token punctuation">,</span>
        urls<span class="token punctuation">:</span> urls<span class="token punctuation">,</span>
        <span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">fail</span><span class="token punctuation">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 选择视频
   *
   * @return {&quot;errMsg&quot;: String, &quot;tempFilePath&quot;: String, &quot;thumbTempFilePath&quot;: String, &quot;duration&quot;: Number, &quot;width&quot;: Number, &quot;height&quot;: Number, &quot;size&quot;: Number}
   */</span>
  <span class="token function-variable function">chooseVideo</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      wx<span class="token punctuation">.</span><span class="token function">chooseVideo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        sourceType<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;album&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        compressed<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        maxDuration<span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">,</span>
        <span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">fail</span><span class="token punctuation">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 保存video到本地
   *
   * @param filePath 文件路径
   * @return {&quot;errMsg&quot;: String}
   */</span>
  <span class="token function-variable function">saveVideo</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      wx<span class="token punctuation">.</span><span class="token function">saveVideoToPhotosAlbum</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        filePath<span class="token punctuation">:</span> filePath<span class="token punctuation">,</span>
        <span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">fail</span><span class="token punctuation">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 构造媒体存储标记
   *
   * @param index 文件类型 0:视频，1:声音，2:照片
   * @param fileID 云文件ID
   * @param author 上传者
   * @return Object
   */</span>
  <span class="token function-variable function">mark</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> fileID<span class="token punctuation">,</span> author</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      index<span class="token punctuation">:</span> index<span class="token punctuation">,</span>
      fileID<span class="token punctuation">:</span> fileID<span class="token punctuation">,</span>
      author<span class="token punctuation">:</span> author
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="页面布局"><a href="#页面布局" class="header-anchor">#</a> 页面布局</h3> <h4 id="底部标签栏"><a href="#底部标签栏" class="header-anchor">#</a> 底部标签栏</h4> <p>新建一个 <code>Page</code>，在 json 配置文件中引入<a href="https://weapp.iviewui.com/components/tab-bar" target="_blank" rel="noopener noreferrer">TabBar<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>组件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;usingComponents&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;i-tab-bar&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;../../dist/tab-bar/index&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;i-tab-bar-item&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;../../dist/tab-bar-item/index&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>新建 4 个 <code>tab</code> 页和一个增加按钮区域，指定每个 <code>tab-item</code> 的 <code>key</code>，绑定 <code>TabBar</code> 的 <code>bindchange</code> 事件来监听点击标签页切换事件，指定<code>current</code> 属性可以切换各标签的 <code>icon</code>。这 4 个标签实际是写在同一个 <code>Page</code> 中的，当切换标签时，通过 <code>wx:if</code> 控制各个区域是否显示。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i-tab-bar</span>
  <span class="token attr-name">i-class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>bar-high<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">fixed</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">current</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{ bar }}<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">bindchange</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>clickTabBar<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i-tab-bar-item</span>
    <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>video<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">icon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>live<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">current-icon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>live_fill<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>视频<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i-tab-bar-item</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i-tab-bar-item</span>
    <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>audio<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">icon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>play<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">current-icon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>play_fill<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>声音<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i-tab-bar-item</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i-tab-bar-item</span>
    <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>add<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">icon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>add<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">current-icon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>add<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>#ffff00<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i-tab-bar-item</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i-tab-bar-item</span>
    <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>notice<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">icon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>remind<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">current-icon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>remind_fill<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>通知<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i-tab-bar-item</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i-tab-bar-item</span>
    <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mine<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">icon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mine<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">current-icon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mine_fill<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>我的<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i-tab-bar-item</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i-tab-bar</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="/img/mp/TabBar.png" alt="底部标签栏"> <code>TabBar</code> 组件的高度为 <code>50px</code>，内容区域可以设置 <code>padding-bottom: 50px;</code> 来避免底部标签页遮挡内容。</p> <h4 id="用户登录"><a href="#用户登录" class="header-anchor">#</a> 用户登录</h4> <p><code>button</code> 组件的 <code>open-type</code> (微信开放能力)提供了用户主动登录的方式。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span>
  <span class="token attr-name">open-type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>getUserInfo<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">bindgetuserinfo</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>onGetUserInfo<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>user-avatar<span class="token punctuation">&quot;</span></span><span class="token style-attr language-css"><span class="token attr-name">
  <span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value"><span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>{{avatarUrl}}<span class="token punctuation">)</span></span></span><span class="token punctuation">&quot;</span></span>
<span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>处理用户登录事件，获取用户 openid 用于判断是否登录，查询时作为条件等：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**
   * 用户登录获取用户信息
   */</span>
  <span class="token function-variable function">onGetUserInfo</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> userInfo <span class="token operator">=</span> e<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>userInfo
    <span class="token comment">// 项目模板中默认提供的云函数，可用于获取用户openid</span>
    <span class="token function">cloud</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> openid <span class="token operator">=</span> res<span class="token punctuation">.</span>result<span class="token punctuation">.</span>openid
      userInfo<span class="token punctuation">.</span>openid <span class="token operator">=</span> openid
      <span class="token comment">// 将用户信息写入本地缓存</span>
      wx<span class="token punctuation">.</span><span class="token function">setStorage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        key<span class="token punctuation">:</span> <span class="token string">'userInfo'</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> userInfo<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 设置openid</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        openid<span class="token punctuation">:</span> openid
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 设置登录头像</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      avatarUrl<span class="token punctuation">:</span> userInfo<span class="token punctuation">.</span>avatarUrl
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="遮罩层组件"><a href="#遮罩层组件" class="header-anchor">#</a> 遮罩层组件</h4> <p>上传文件等场景中，如果不希望用户在当前操作完成前有其它动作，可以弹出遮罩层保护用户界面。</p> <ul><li>新增小程序组件：在 <code>miniprogram</code> 目录下新建 <code>components/mask</code> 文件夹，选择 <code>新增Component</code>，默认生成类似 <code>Page</code> 的 4 个文件。</li> <li>编辑遮罩层组件
mask.wxml</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mask<span class="token punctuation">&quot;</span></span> <span class="token attr-name">hidden</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{mask}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>mask.wxss</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.mask</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  <span class="token property">position</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #999<span class="token punctuation">;</span>
  <span class="token property">z-index</span><span class="token punctuation">:</span> 999<span class="token punctuation">;</span>
  <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">opacity</span><span class="token punctuation">:</span> 0.1<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>mask.js</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**
   * 组件的属性列表
   */</span>
  properties<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    hidden<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> Boolean<span class="token punctuation">,</span>
      value<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>引入组件
编辑 <code>Page</code> 的 json 配置文件：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token string">&quot;usingComponents&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;mask&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;../../components/mask/mask&quot;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>编辑 <code>Page</code> 的 wxml 文件：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 遮罩对象 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mask</span> <span class="token attr-name">hidden</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{!mask}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mask</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在 js 文件中通过指定 mask 属性来打开/关闭遮罩层。</p> <h4 id="消息提示"><a href="#消息提示" class="header-anchor">#</a> 消息提示</h4> <p>在 json 配置文件中引入<a href="https://weapp.iviewui.com/components/toast" target="_blank" rel="noopener noreferrer">Toast<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>组件。
引入 <code>$Toast</code> 对象：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> $Toast <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../../dist/base/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**
   * 弹出toast提示
   *
   * @param content loading显示内容
   * @param type toast类型 default、success、warning、error、loading
   * @param modal 遮罩层是否打开
   * @param duration 持续时间，单位s，0为不自动关闭，需调用 $Toast.hide() 方法手动关闭
   * @param mask toast是否可关闭
   */</span>
  <span class="token function-variable function">popToast</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> type<span class="token punctuation">,</span> modal<span class="token punctuation">,</span> duration<span class="token punctuation">,</span> mask</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    duration <span class="token operator">=</span> duration <span class="token operator">||</span> <span class="token number">0</span>
    mask <span class="token operator">=</span> mask <span class="token operator">||</span> <span class="token boolean">false</span>
    modal <span class="token operator">=</span> modal <span class="token operator">||</span> <span class="token boolean">false</span>
    <span class="token function">$Toast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      content<span class="token punctuation">:</span> content<span class="token punctuation">,</span>
      type<span class="token punctuation">:</span> type<span class="token punctuation">,</span>
      duration<span class="token punctuation">:</span> duration<span class="token punctuation">,</span>
      mask<span class="token punctuation">:</span> mask
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 打开遮罩层</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      hidden<span class="token punctuation">:</span> modal
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 关闭toast提示
   */</span>
  <span class="token function-variable function">hideToast</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $Toast<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 关闭遮罩层</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      hidden<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="处理多媒体上传"><a href="#处理多媒体上传" class="header-anchor">#</a> 处理多媒体上传</h4> <p>为了将上传文件与上传用户相关联、便于查找上传的文件，将数据库和存储结合使用。即将文件上传到存储后，获取返回的 <code>fileID</code>，与上传者信息、文件类型、文件描述等一起写入数据库。
在 json 配置文件中引入<a href="https://weapp.iviewui.com/components/action-sheet" target="_blank" rel="noopener noreferrer">ActionSheet<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>组件。</p> <div class="language- extra-class"><pre class="language-text"><code>  &lt;i-action-sheet visible=&quot;{{ showAdd }}&quot; actions=&quot;{{ addActions }}&quot; show-cancel bind:cancel=&quot;cancelAdd&quot; bind:click=&quot;handleChooseMedia&quot; /&gt;
</code></pre></div><p>处理 <code>TabBar</code> 的点击事件，当选择的是新增按钮时，弹出 <code>ActionSheet</code> 选项。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**
   * TabBar点击事件
   */</span>
  <span class="token function">clickTabBar</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
    detail
  <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> key <span class="token operator">=</span> detail<span class="token punctuation">.</span>key
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'add'</span> <span class="token operator">===</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 点击添加按钮弹出上传选项</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        showAdd<span class="token punctuation">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        bar<span class="token punctuation">:</span> key
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><img src="/img/mp/%E5%BC%B9%E5%87%BAActionSheet.png" alt="弹出新增选项"> <code>ActionSheet</code> 点击事件绑定了 <code>handleChooseMedia</code> 函数：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">handleChooseMedia</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
    detail
  <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ActionSheet隐藏</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 登录提示</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>openid <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">popToast</span><span class="token punctuation">(</span><span class="token string">'请先登录~'</span><span class="token punctuation">,</span> <span class="token string">'warning'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// actions选项的索引，从0开始</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> detail<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
    <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">===</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 视频</span>
      media<span class="token punctuation">.</span><span class="token function">chooseVideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        that<span class="token punctuation">.</span><span class="token function">popToast</span><span class="token punctuation">(</span><span class="token string">'上传中...'</span><span class="token punctuation">,</span> <span class="token string">'loading'</span><span class="token punctuation">)</span>
        <span class="token comment">// 文件</span>
        <span class="token keyword">let</span> tempFilePath <span class="token operator">=</span> res<span class="token punctuation">.</span>tempFilePath
        <span class="token keyword">let</span> tempFilename <span class="token operator">=</span> that<span class="token punctuation">.</span><span class="token function">splitFileName</span><span class="token punctuation">(</span>tempFilePath<span class="token punctuation">)</span>
        <span class="token comment">// 缩略图文件（目前微信开发工具有这个字段，真机无）</span>
        <span class="token keyword">let</span> thumbTempFilePath <span class="token operator">=</span> res<span class="token punctuation">.</span>thumbTempFilePath
        <span class="token comment">// 上传视频文件</span>
        cloud<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>tempFilename<span class="token punctuation">,</span> tempFilePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> mark <span class="token operator">=</span> media<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> res<span class="token punctuation">.</span>fileID<span class="token punctuation">,</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>nickName<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>thumbTempFilePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 缩略图文件</span>
            <span class="token keyword">let</span> thumbTempFilename <span class="token operator">=</span> that<span class="token punctuation">.</span><span class="token function">splitFileName</span><span class="token punctuation">(</span>thumbTempFilePath<span class="token punctuation">)</span>
            <span class="token comment">// 上传缩略图文件</span>
            cloud<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>thumbTempFilename<span class="token punctuation">,</span> thumbTempFilePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">let</span> thumb <span class="token operator">=</span> res<span class="token punctuation">.</span>fileID
              mark<span class="token punctuation">.</span>thumb <span class="token operator">=</span> thumb
              <span class="token comment">// 写入数据库</span>
              cloud<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mark<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> id <span class="token operator">=</span> res<span class="token punctuation">.</span>_id
                <span class="token comment">// 跳转到编辑视频详情页面</span>
                wx<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                  url<span class="token punctuation">:</span> <span class="token string">'../editVideo/editVideo'</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">'?thumb='</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>thumb<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">'&amp;id='</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                that<span class="token punctuation">.</span><span class="token function">hideToast</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 未生成缩略图，使用默认图片</span>
            <span class="token keyword">let</span> thumb <span class="token operator">=</span> <span class="token string">'cloud://test-d518bb.7465-test-d518bb/system/default-poster.jpg'</span>
            mark<span class="token punctuation">.</span>thumb <span class="token operator">=</span> thumb
            <span class="token comment">// 写入数据库</span>
            cloud<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mark<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              that<span class="token punctuation">.</span><span class="token function">hideToast</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token keyword">let</span> id <span class="token operator">=</span> res<span class="token punctuation">.</span>_id
              wx<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                url<span class="token punctuation">:</span> <span class="token string">'../editVideo/editVideo'</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">'?thumb='</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>thumb<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">'&amp;id='</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">===</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 照片</span>
      media<span class="token punctuation">.</span><span class="token function">chooseImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span>tempFilePaths<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">filePath<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          that<span class="token punctuation">.</span><span class="token function">popToast</span><span class="token punctuation">(</span><span class="token string">'上传中...'</span><span class="token punctuation">,</span> <span class="token string">'loading'</span><span class="token punctuation">)</span>
          <span class="token keyword">let</span> filename <span class="token operator">=</span> that<span class="token punctuation">.</span><span class="token function">splitFileName</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
          cloud<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> mark <span class="token operator">=</span> media<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> res<span class="token punctuation">.</span>fileID<span class="token punctuation">,</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>nickName<span class="token punctuation">)</span>
            <span class="token comment">// 写入数据库</span>
            cloud<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mark<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              that<span class="token punctuation">.</span><span class="token function">loadAlbum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              that<span class="token punctuation">.</span><span class="token function">hideToast</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="视频列表页"><a href="#视频列表页" class="header-anchor">#</a> 视频列表页</h4> <p>在小程序中，<code>video</code> 是原生组件，层级很高，作为列表元素时会遮挡底部标签栏，因此视频列表以缩略图列表的形式呈现，列表区域设置 <code>padding-bottom: 50px;</code> 来保证能够完全呈现。
点击缩略图，可以跳转到新页面观看视频和具体信息。</p> <ul><li>视频列表区域</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name"><span class="token namespace">wx:</span>for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{videoFiles}}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">wx:</span>key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{item.id}}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>video-image-warpper<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>video-image<span class="token punctuation">'</span></span> <span class="token attr-name">mode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>aspectFill<span class="token punctuation">'</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>{{item.thumb}}<span class="token punctuation">'</span></span> <span class="token attr-name">bindtap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>playVideo<span class="token punctuation">'</span></span> <span class="token attr-name">data-index</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{item.id}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>video-like-icon<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i-icon</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>like_fill<span class="token punctuation">&quot;</span></span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>28<span class="token punctuation">&quot;</span></span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>#ff5050<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>99k+<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i-icon</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>play-icon<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>play<span class="token punctuation">&quot;</span></span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>28<span class="token punctuation">&quot;</span></span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>#fff<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>加载视频列表</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**
   * 加载视频
   */</span>
  <span class="token function-variable function">loadVideo</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
    cloud<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 查询该用户上传的文件</span>
      <span class="token comment">// _openid: that.data.openid,</span>
      index<span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      res<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        files<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          id<span class="token punctuation">:</span> e<span class="token punctuation">.</span>_id<span class="token punctuation">,</span>
          fileID<span class="token punctuation">:</span> e<span class="token punctuation">.</span>fileID<span class="token punctuation">,</span>
          thumb<span class="token punctuation">:</span> e<span class="token punctuation">.</span>thumb<span class="token punctuation">,</span>
          author<span class="token punctuation">:</span> e<span class="token punctuation">.</span>author<span class="token punctuation">,</span>
          desc<span class="token punctuation">:</span> e<span class="token punctuation">.</span>desc
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        videoFiles<span class="token punctuation">:</span> files
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>视频列表页效果图
<img src="/img/mp/%E8%A7%86%E9%A2%91%E5%88%97%E8%A1%A8%E9%A1%B5.png" alt="视频列表页"></li></ul> <h4 id="视频详情页"><a href="#视频详情页" class="header-anchor">#</a> 视频详情页</h4> <ul><li>点击缩略图，跳转到视频详情页
跳转页面传递参数，包括视频和缩略图的 <code>fileID</code>、视频信息等。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">playVideo</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> video
    files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>currentTarget<span class="token punctuation">.</span>dataset<span class="token punctuation">[</span><span class="token string">'index'</span><span class="token punctuation">]</span> <span class="token operator">===</span> element<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        video <span class="token operator">=</span> element
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">undefined</span> <span class="token operator">!==</span> video<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      wx<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        url<span class="token punctuation">:</span> <span class="token string">'../video/video?fileID='</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>fileID<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">'&amp;thumb='</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>thumb<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">'&amp;author='</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>author<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">'&amp;desc='</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>desc <span class="token operator">==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token punctuation">:</span> video<span class="token punctuation">.</span>desc<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>编辑详情页
视频参数详见<a href="https://developers.weixin.qq.com/miniprogram/dev/component/video.html" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span>
  <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>video<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{fileID}}<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">poster</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{thumb}}<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">object-fit</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cover<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">direction</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">bindended</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>onVideoEnd<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>保存视频</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**
   * 保存视频
   */</span>
  <span class="token function-variable function">saveVideo</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
    cloud<span class="token punctuation">.</span><span class="token function">download</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fileID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 临时文件路径</span>
      <span class="token keyword">let</span> tempFilePath <span class="token operator">=</span> res<span class="token punctuation">.</span>tempFilePath
      media<span class="token punctuation">.</span><span class="token function">saveVideo</span><span class="token punctuation">(</span>tempFilePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>视频详情页效果图</li></ul> <p><img src="/img/mp/%E8%A7%86%E9%A2%91%E8%AF%A6%E6%83%85%E9%A1%B5.png" alt="视频详情页"></p> <h4 id="相册"><a href="#相册" class="header-anchor">#</a> 相册</h4> <ul><li>编辑相册展示区域
图片参数详见<a href="https://developers.weixin.qq.com/miniprogram/dev/component/image.html" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。
图片裁剪、缩放模式选择 <code>mode='aspectFill'</code>，从而保持纵横比缩放图片，只保证图片的短边能完全显示出来。</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span>
  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>album-image<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">mode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>aspectFill<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name"><span class="token namespace">wx:</span>for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{albumFiles}}<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name"><span class="token namespace">wx:</span>key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{item.id}}<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{item.fileID}}<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">bindtap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>imageToPreview<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">data-current</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{item.fileID}}<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">/&gt;</span></span>
</code></pre></div><ul><li>加载相册</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**
   * 初始化album
   *
   * TODO 分页加载
   */</span>
  <span class="token function-variable function">loadAlbum</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
    cloud<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      index<span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      res<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        files<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          id<span class="token punctuation">:</span> e<span class="token punctuation">.</span>_id<span class="token punctuation">,</span>
          fileID<span class="token punctuation">:</span> e<span class="token punctuation">.</span>fileID
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        albumFiles<span class="token punctuation">:</span> files
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>相册效果图</li></ul> <p><img src="/img/mp/%E7%9B%B8%E5%86%8C.png" alt="相册"></p> <ul><li>预览图片
图片绑定点击事件，生成预览图片：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**
   * 相册图片点击全屏预览
   */</span>
  <span class="token function-variable function">imageToPreview</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 被点击图片云文件ID</span>
    <span class="token keyword">let</span> current <span class="token operator">=</span> e<span class="token punctuation">.</span>currentTarget<span class="token punctuation">.</span>dataset<span class="token punctuation">[</span><span class="token string">'current'</span><span class="token punctuation">]</span>
    <span class="token comment">// 所有图片云文件ID</span>
    <span class="token keyword">let</span> fileIDs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>albumFiles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fileIDs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>fileID<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    media<span class="token punctuation">.</span><span class="token function">previewImage</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> fileIDs<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>预览效果图</li></ul> <p><img src="/img/mp/%E7%85%A7%E7%89%87%E9%A2%84%E8%A7%88.png" alt="照片预览"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/posts/microservice/微服务实践（二）：微服务与容器化.html" class="prev">微服务实践（二）：微服务与容器化</a></span> <span class="next"><a href="/posts/elasticsearch/Elasticsearch（一）：概念与基本API.html">Elasticsearch（一）：概念与基本API</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.15a66b26.js" defer></script><script src="/assets/js/2.92cd0f37.js" defer></script><script src="/assets/js/29.de1da78b.js" defer></script>
  </body>
</html>

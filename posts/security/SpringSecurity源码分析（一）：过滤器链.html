<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Security 源码分析（一）：过滤器链 | wch的个人主页</title>
    <meta name="description" content="用于分享wch的学习笔记和项目~">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.74c45c5d.css" as="style"><link rel="preload" href="/assets/js/app.15a66b26.js" as="script"><link rel="preload" href="/assets/js/2.92cd0f37.js" as="script"><link rel="preload" href="/assets/js/39.a72bb5df.js" as="script"><link rel="prefetch" href="/assets/js/10.1166f652.js"><link rel="prefetch" href="/assets/js/11.b6ae0b14.js"><link rel="prefetch" href="/assets/js/12.7802c7ba.js"><link rel="prefetch" href="/assets/js/13.63066938.js"><link rel="prefetch" href="/assets/js/14.1f9fa0d5.js"><link rel="prefetch" href="/assets/js/15.6c758eca.js"><link rel="prefetch" href="/assets/js/16.58440a84.js"><link rel="prefetch" href="/assets/js/17.1e1f5c53.js"><link rel="prefetch" href="/assets/js/18.28115609.js"><link rel="prefetch" href="/assets/js/19.7e395424.js"><link rel="prefetch" href="/assets/js/20.2c2ea5f8.js"><link rel="prefetch" href="/assets/js/21.1e8ef167.js"><link rel="prefetch" href="/assets/js/22.47a8f5b7.js"><link rel="prefetch" href="/assets/js/23.f507c548.js"><link rel="prefetch" href="/assets/js/24.b19f43b8.js"><link rel="prefetch" href="/assets/js/25.5b1882b0.js"><link rel="prefetch" href="/assets/js/26.16cf6f8a.js"><link rel="prefetch" href="/assets/js/27.6f3498d0.js"><link rel="prefetch" href="/assets/js/28.f56b7e3c.js"><link rel="prefetch" href="/assets/js/29.de1da78b.js"><link rel="prefetch" href="/assets/js/3.73d3287d.js"><link rel="prefetch" href="/assets/js/30.108b25a0.js"><link rel="prefetch" href="/assets/js/31.68af7d35.js"><link rel="prefetch" href="/assets/js/32.c9f05837.js"><link rel="prefetch" href="/assets/js/33.13bd6f64.js"><link rel="prefetch" href="/assets/js/34.59041fd7.js"><link rel="prefetch" href="/assets/js/35.4382a261.js"><link rel="prefetch" href="/assets/js/36.01d6324a.js"><link rel="prefetch" href="/assets/js/37.22e4179e.js"><link rel="prefetch" href="/assets/js/38.f553994e.js"><link rel="prefetch" href="/assets/js/4.9a52aae5.js"><link rel="prefetch" href="/assets/js/40.3751cd34.js"><link rel="prefetch" href="/assets/js/41.d351ec5d.js"><link rel="prefetch" href="/assets/js/42.b87a3eae.js"><link rel="prefetch" href="/assets/js/43.7035de8a.js"><link rel="prefetch" href="/assets/js/44.2c18f0bc.js"><link rel="prefetch" href="/assets/js/45.52905280.js"><link rel="prefetch" href="/assets/js/46.abb047a4.js"><link rel="prefetch" href="/assets/js/47.2ac230d3.js"><link rel="prefetch" href="/assets/js/48.b63bb42b.js"><link rel="prefetch" href="/assets/js/49.35752ae9.js"><link rel="prefetch" href="/assets/js/5.36029518.js"><link rel="prefetch" href="/assets/js/50.b6bd912f.js"><link rel="prefetch" href="/assets/js/51.0e0db65f.js"><link rel="prefetch" href="/assets/js/52.d15fb17a.js"><link rel="prefetch" href="/assets/js/53.844345be.js"><link rel="prefetch" href="/assets/js/54.52685e8c.js"><link rel="prefetch" href="/assets/js/55.83a99fe0.js"><link rel="prefetch" href="/assets/js/56.fe26d3a3.js"><link rel="prefetch" href="/assets/js/57.dae36566.js"><link rel="prefetch" href="/assets/js/58.1bfd28b1.js"><link rel="prefetch" href="/assets/js/59.88f55364.js"><link rel="prefetch" href="/assets/js/6.d3b55a54.js"><link rel="prefetch" href="/assets/js/7.af0443ed.js"><link rel="prefetch" href="/assets/js/8.2c9a7ea2.js"><link rel="prefetch" href="/assets/js/9.c08dcf83.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74c45c5d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">wch的个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java虚拟机</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java并发编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis 源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Spring Security 源码分析</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/security/SpringSecurity源码分析（一）：过滤器链.html" class="active sidebar-link">Spring Security 源码分析（一）：过滤器链</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（一）：过滤器链.html#注册过滤器链" class="sidebar-link">注册过滤器链</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（一）：过滤器链.html#websecurityconfigureradapter-实现" class="sidebar-link">WebSecurityConfigurerAdapter 实现</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（一）：过滤器链.html#abstractsecuritybuilder-build" class="sidebar-link">AbstractSecurityBuilder#build</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（一）：过滤器链.html#websecurityconfigureradapter-配置" class="sidebar-link">WebSecurityConfigurerAdapter 配置</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（一）：过滤器链.html#过滤器管理器-httpsecurity-配置" class="sidebar-link">过滤器管理器 HttpSecurity 配置</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（一）：过滤器链.html#websecurityconfigureradapter-configure" class="sidebar-link">WebSecurityConfigurerAdapter#configure</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（一）：过滤器链.html#filterchainproxy-执行各过滤器" class="sidebar-link">FilterChainProxy 执行各过滤器</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（一）：过滤器链.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/posts/security/SpringSecurity源码分析（二）：表单登录.html" class="sidebar-link">Spring Security 源码分析（二）：表单登录</a></li><li><a href="/posts/security/SpringSecurity源码分析（三）：授权管理.html" class="sidebar-link">Spring Security 源码分析（三）：授权管理</a></li><li><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html" class="sidebar-link">Spring Security 源码分析（四）：OAth2实现</a></li><li><a href="/posts/security/SpringSecurity源码分析（五）：JWT实现.html" class="sidebar-link">Spring Security 源码分析（五）：JWT实现</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微信小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Elasticsearch</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="spring-security-源码分析（一）：过滤器链"><a href="#spring-security-源码分析（一）：过滤器链" class="header-anchor">#</a> Spring Security 源码分析（一）：过滤器链</h1> <p><code>Spring Security</code> 是一个能够为企业应用系统提供声明式的安全访问控制解决方案的安全框架，减少了为企业系统安全控制编写大量重复代码的工作，能够与 <code>Spring</code> 无缝集成。本文旨在从实际应用角度出发，阅读 <code>Spring Security</code> 源码，分析其实现原理。</p> <h2 id="注册过滤器链"><a href="#注册过滤器链" class="header-anchor">#</a> 注册过滤器链</h2> <p>引入 <code>spring-security</code> 包：</p> <div class="language-xml extra-class"><pre class="language-xml"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.3.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>对 <code>Web</code> 资源的控制通过 <code>WebSecurityConfiguration</code> 配置，其在启动时装配名为 <code>springSecurityFilterChain</code> 的 <code>bean</code>：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token class-name">AbstractSecurityWebApplicationInitializer</span><span class="token punctuation">.</span>DEFAULT_FILTER_NAME<span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">Filter</span> <span class="token function">springSecurityFilterChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> hasConfigurers <span class="token operator">=</span> webSecurityConfigurers <span class="token operator">!=</span> <span class="token keyword">null</span>
        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>webSecurityConfigurers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasConfigurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">WebSecurityConfigurerAdapter</span> adapter <span class="token operator">=</span> objectObjectPostProcessor
          <span class="token punctuation">.</span><span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebSecurityConfigurerAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 应用 WebSecurityConfigurerAdapter 中的各项配置</span>
      webSecurity<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>adapter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 生成 Spring Security 过滤器链</span>
    <span class="token keyword">return</span> webSecurity<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="websecurityconfigureradapter-实现"><a href="#websecurityconfigureradapter-实现" class="header-anchor">#</a> WebSecurityConfigurerAdapter 实现</h3> <p><code>spring-boot-autoconfigure</code> 在 <code>spring.factories</code> 中标识 <code>SecurityAutoConfiguration</code> 需要自动装配，在装配过程中又将 <code>SpringBootWebSecurityConfiguration</code> 引入，在此类中声明了一个继承自 <code>WebSecurityConfigurerAdapter</code> 的 <code>DefaultConfigurerAdapter</code>，由此装配了对 <code>WebSecurityConfigurerAdapter</code> 的默认实现，此类对 <code>spring security</code> 做了许多默认配置。
如果需要干预 <code>spring security</code> 配置，则需要继承 <code>WebSecurityConfigurerAdapter</code> 并装配到 <code>Spring</code> 容器中。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">WebSecurityConfigurerAdapter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">WebSecurityConfigurerAdapter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnWebApplication</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">Type</span><span class="token punctuation">.</span>SERVLET<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringBootWebSecurityConfiguration</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Configuration</span>
  <span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token class-name">SecurityProperties</span><span class="token punctuation">.</span>BASIC_AUTH_ORDER<span class="token punctuation">)</span>
  <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DefaultConfigurerAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="abstractsecuritybuilder-build"><a href="#abstractsecuritybuilder-build" class="header-anchor">#</a> AbstractSecurityBuilder#build</h3> <p><code>WebSecurity</code> 实例 调用 <code>apply</code> 方法获取 <code>WebSecurityConfigurerAdapter</code> 中的配置，并调用 <code>build</code> 方法构造过滤器链，其实现为：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">O</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>building<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>object <span class="token operator">=</span> <span class="token function">doBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>object<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AlreadyBuiltException</span><span class="token punctuation">(</span><span class="token string">&quot;This object has already been built&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">O</span> <span class="token function">doBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      buildState <span class="token operator">=</span> <span class="token class-name">BuildState</span><span class="token punctuation">.</span>INITIALIZING<span class="token punctuation">;</span>

      <span class="token function">beforeInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      buildState <span class="token operator">=</span> <span class="token class-name">BuildState</span><span class="token punctuation">.</span>CONFIGURING<span class="token punctuation">;</span>

      <span class="token function">beforeConfigure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      buildState <span class="token operator">=</span> <span class="token class-name">BuildState</span><span class="token punctuation">.</span>BUILDING<span class="token punctuation">;</span>

      <span class="token class-name">O</span> result <span class="token operator">=</span> <span class="token function">performBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      buildState <span class="token operator">=</span> <span class="token class-name">BuildState</span><span class="token punctuation">.</span>BUILT<span class="token punctuation">;</span>

      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 内部配置初始化
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configurers <span class="token operator">=</span> <span class="token function">getConfigurers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span></span> configurer <span class="token operator">:</span> configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      configurer<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span></span> configurer <span class="token operator">:</span> configurersAddedInInitializing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      configurer<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
    * 配置逻辑
    */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configurers <span class="token operator">=</span> <span class="token function">getConfigurers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span></span> configurer <span class="token operator">:</span> configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      configurer<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>可以看到构建操作为将通过 <code>apply</code> 方法应用进来的配置分别初始化和构建，链条为 <code>beforeInit -&gt; init -&gt; beforeConfigure -&gt; configure -&gt; performBuild</code>。<code>Spring Security</code> 中的 <code>AuthenticationManagerBuilder</code> （认证管理器生成配置）、<code>HttpSecurity</code> （过滤器管理器生成配置）、<code>WebSecurity</code> （过滤器生成配置） 都是继承 <code>AbstractConfiguredSecurityBuilder</code> 通过这个链条生成目标对象，这 3 个配置也是 <code>Spring Security</code> 的配置核心。</p> <p><img src="/img/security/SecurityBuilder.png" alt="SecuirtyBuilder"></p> <h3 id="websecurityconfigureradapter-配置"><a href="#websecurityconfigureradapter-配置" class="header-anchor">#</a> WebSecurityConfigurerAdapter 配置</h3> <p>由上文可知，过滤器链生成过程中调用了 <code>WebSecurityConfigurerAdapter</code> 的 <code>init</code> 和 <code>configure</code> 方法。</p> <p><code>init</code> 方法首先调用了 <code>getHttp</code> 方法，用于生成 <code>AuthenticationManager</code> 和 <code>HttpSecurity</code> 实例。</p> <h4 id="认证管理器-authenticationmanager-的配置"><a href="#认证管理器-authenticationmanager-的配置" class="header-anchor">#</a> 认证管理器 AuthenticationManager 的配置</h4> <p>来看看 <code>WebSecurityConfigurerAdapter</code> 关于认证管理器的组成：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">/**
    * 认证管理器，管理多种认证方式（AuthenticationProvider），进行实际的认证调用
    */</span>
  <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>

  <span class="token comment">/**
    * 认证配置，装配认证方式，通过 @Autowired 自动注入
    */</span>
  <span class="token keyword">private</span> <span class="token class-name">AuthenticationConfiguration</span> authenticationConfiguration<span class="token punctuation">;</span>

  <span class="token comment">/**
    * 同于生成系统配置的认证管理器
    */</span>
  <span class="token keyword">private</span> <span class="token class-name">AuthenticationManagerBuilder</span> authenticationBuilder<span class="token punctuation">;</span>

  <span class="token comment">/**
    * 用于生成开发者可干预的认证管理器
    */</span>
  <span class="token keyword">private</span> <span class="token class-name">AuthenticationManagerBuilder</span> localConfigureAuthenticationBldr<span class="token punctuation">;</span>

  <span class="token comment">/**
    * true - 不使用可干预的认证管理器生成方式
    */</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> disableLocalConfigureAuthenticationBldr<span class="token punctuation">;</span>
</code></pre></div><p><code>WebSecurityConfigurerAdapter</code> 在初始化过程中会调用 <code>authenticationManager</code> 方法配置认证管理器，当 <code>disableLocalConfigureAuthenticationBldr</code> 为 <code>true</code> 时会调用 <code>AuthenticationConfiguration#getAuthenticationManager</code> 生成认证管理器，当为 <code>false</code> 时会使用开发者干预过的 <code>localConfigureAuthenticationBldr</code> 生成认证管理器。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">protected</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">authenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>authenticationManagerInitialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// void configure(AuthenticationManagerBuilder auth); 开发者可以重载此方法干预认证管理器的成逻辑</span>
      <span class="token function">configure</span><span class="token punctuation">(</span>localConfigureAuthenticationBldr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>disableLocalConfigureAuthenticationBldr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 不需要干预，使用系统配置逻辑</span>
        authenticationManager <span class="token operator">=</span> authenticationConfiguration<span class="token punctuation">.</span><span class="token function">getAuthenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        authenticationManager <span class="token operator">=</span> localConfigureAuthenticationBldr<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      authenticationManagerInitialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> authenticationManager<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="认证管理器的系统配置逻辑"><a href="#认证管理器的系统配置逻辑" class="header-anchor">#</a> 认证管理器的系统配置逻辑</h5> <p><code>WebSecurityConfigurerAdapter</code> 中通过 <code>@Autowired</code> 注入了 <code>AuthenticationConfiguration</code>，此类的主要功能是为 <code>AuthenticationManagerBuilder</code> 装配 <code>AuthenticationProvider</code>，可以装配的认证配置逻辑分为两类：</p> <ul><li>（1）在 <code>spring context</code> 中查找 <code>UserDetailsService</code> 等类的相关实现，包装成 <code>DaoAuthenticationProvider</code> 配置到 <code>AuthenticationManagerBuilder</code> 中。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token class-name">UserDetailsService</span> userDetailsService <span class="token operator">=</span> <span class="token function">getBeanOrNull</span><span class="token punctuation">(</span><span class="token class-name">UserDetailsService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...</span>

    <span class="token class-name">DaoAuthenticationProvider</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DaoAuthenticationProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    provider<span class="token punctuation">.</span><span class="token function">setUserDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...</span>

    auth<span class="token punctuation">.</span><span class="token function">authenticationProvider</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>UserDetailsService</code> 的作用是通过用户名查找用户信息：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span>
  <span class="token comment">// 根据用户名查找用户信息</span>
	<span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Spring Security</code> 关于 <code>UserDetails</code> 的默认实现为 <code>org.springframework.security.core.userdetails.User</code>，它有一个构造方法，可以构造用户名、密码、是否激活、是否过期、是否凭证过期、是否锁定：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token keyword">boolean</span> enabled<span class="token punctuation">,</span> <span class="token keyword">boolean</span> accountNonExpired<span class="token punctuation">,</span> <span class="token keyword">boolean</span> credentialsNonExpired<span class="token punctuation">,</span> <span class="token keyword">boolean</span> accountNonLocked<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>DaoAuthenticationProvider</code> 继承自 <code>AbstractUserDetailsAuthenticationProvider</code>，这个抽象类实现了 <code>AuthenticationProvider</code> 接口的 <code>authenticate</code> 方法，此方法会调用子类实现的 <code>retrieveUser</code> 方法。<code>DaoAuthenticationProvider</code> 的实现是调用注入进来的 <code>UserDetailsService</code> 的 <code>loadUserByUsername</code> 方法。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">UserDetails</span> <span class="token function">retrieveUser</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token class-name">UserDetails</span> loadedUser <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUserDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>取出账户信息后，<code>AbstractUserDetailsAuthenticationProvider#authenticate</code> 方法进行 <code>check</code>，如果密码错误，或者未激活、过期等都会抛出 <code>AuthenticationException</code> 异常。</p> <p><img src="/img/security/DaoAuthenticationProvider.png" alt="DaoAuthenticationProvider"></p> <p>在不自定义任何配置的情况下启动引入 <code>spring-boot-starter-security</code> 包的项目，会发现控制台输出了这样的日志：</p> <div class="language-text extra-class"><pre class="language-text"><code>2049-04-09 00:00:00.000  INFO 8504 --- [  restartedMain] .s.s.UserDetailsServiceAutoConfiguration : Using generated security password: 1a1890f2-97d5-421d-a775-953f7641b579
</code></pre></div><p>打开 <code>UserDetailsServiceAutoConfiguration</code> 类，此类在没有 <code>UserDetailsService</code> 的自定义实现时，会装配一个实现了 <code>UserDetailsService</code> 接口的 <code>InMemoryUserDetailsManager</code>，默认生成一个登录名为 <code>user</code> 的用户，密码通过 <code>UUID</code> 随机生成，并在控制台输出。默认的用户配置取自 <code>SecurityProperties</code>，开发者可以在配置文件中加以覆盖。
到此为止，用户在不做任何额外配置的情况下，拥有了一个可以认证通过的账号。</p> <ul><li>（2）在 <code>spring context</code> 中查找 <code>AuthenticationProvider</code> 的实现，直接配置到 <code>AuthenticationManagerBuilder</code> 中，但是 <code>spring</code> 没有装配 <code>AuthenticationProvider</code> 的默认实现。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token class-name">AuthenticationProvider</span> authenticationProvider <span class="token operator">=</span> <span class="token function">getBeanOrNull</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationProvider</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...</span>

    auth<span class="token punctuation">.</span><span class="token function">authenticationProvider</span><span class="token punctuation">(</span>authenticationProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h5 id="开发者可干预的认证管理器"><a href="#开发者可干预的认证管理器" class="header-anchor">#</a> 开发者可干预的认证管理器</h5> <p>上文说到，系统会默认装配两类 <code>AuthenticationProvider</code>，如果开发者需要干预认证管理器的生成，同样可以提供这两类认证逻辑。
先看如何干预：<code>disableLocalConfigureAuthenticationBldr</code> 在 <code>WebSecurityConfigurerAdapter</code> 中默认为 <code>false</code>，<code>void configure(AuthenticationManagerBuilder auth)</code> 方法将此属性修改为 <code>true</code>，如果开发者需要干预，则需要覆盖此方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Resource</span>
  <span class="token keyword">private</span> <span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    auth
      <span class="token comment">// 自定义 AuthenticationProvider 实现</span>
      <span class="token comment">// .authenticationProvider(...)</span>
      <span class="token comment">// 自定义 UserDetailsService 实现</span>
      <span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>开发者可以实现 <code>AuthenticationProvider</code> 或 <code>UserDetailsService</code> 接口，填充自定义用户逻辑。在注入自定义用户认证逻辑时，实际还是包装为
<code>AuthenticationProvider</code>，因此往后的认证逻辑就与系统的默认配置相符了。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">UserDetailsService</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">DaoAuthenticationConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthenticationManagerBuilder</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">userDetailsService</span><span class="token punctuation">(</span><span class="token class-name">T</span> userDetailsService<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultUserDetailsService <span class="token operator">=</span> userDetailsService<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DaoAuthenticationConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>在 <code>AuthenticationManagerBuilder</code> 配置完成后，<code>build</code> 方法会将所有的 <code>AuthenticationProvider</code> 交给 <code>ProviderManager</code> 管理。在进行认证时，<code>ProviderManager</code> 会逐个调用认证逻辑进行认证，有一个通过即认证成功。</p> <h5 id="密码加密管理"><a href="#密码加密管理" class="header-anchor">#</a> 密码加密管理</h5> <p><code>Spring Security</code> 默认要求用户密码加密。以上文中提到的 <code>UserDetailsServiceAutoConfiguration</code> 为例，生成的密码需要配置 <code>{noop}</code> 前缀：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">/**
   * 随机密码配置
   */</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getOrDeducePassword</span><span class="token punctuation">(</span><span class="token class-name">SecurityProperties</span><span class="token punctuation">.</span><span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">PasswordEncoder</span> encoder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">String</span> password <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// ...</span>

		<span class="token keyword">return</span> <span class="token string">&quot;{noop}&quot;</span> <span class="token operator">+</span> password<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>这是因为如果不配置系统默认加密方式 <code>PasswordEncoder</code>，认证流程的校验密码环节会读取密码的前缀来判断密码使用的是哪种加密方式：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span> rawPassword<span class="token punctuation">,</span> <span class="token class-name">String</span> prefixEncodedPassword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// 获取密码前缀（加密方式）</span>
    <span class="token class-name">String</span> id <span class="token operator">=</span> <span class="token function">extractId</span><span class="token punctuation">(</span>prefixEncodedPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PasswordEncoder</span> delegate <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>idToPasswordEncoder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token comment">// 查不到前缀或者找不到前缀对应的加密方式，会抛出异常，因此是强制加密的</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> encodedPassword <span class="token operator">=</span> <span class="token function">extractEncodedPassword</span><span class="token punctuation">(</span>prefixEncodedPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> delegate<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>rawPassword<span class="token punctuation">,</span> encodedPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>在项目开发中，为每个密码密文加一个前缀是不明智的，因此开发者如果需要自定义用户加载方式，可以在配置的同时手动指定加密方式：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 自定义认证服务</span>
    auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span>
            <span class="token comment">// 配置 bCrypt 作为密码加密方式</span>
            <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>BCryptPasswordEncoder</code> 在加密时会随机生成盐值，在与密码明文进行匹配时，可以从密文中读取到使用的盐值，对明文加密后匹配。随机生成盐值的方式大大增强了密码的安全性。</p> <h3 id="过滤器管理器-httpsecurity-配置"><a href="#过滤器管理器-httpsecurity-配置" class="header-anchor">#</a> 过滤器管理器 HttpSecurity 配置</h3> <p>当认证管理器初始化完成，<code>WebSecurityConfigurerAdapter</code> 会继续配置 <code>HttpSecurity</code>，它用于配置 <code>web</code> 请求的安全配置，默认会应用到所有请求，开发者也可通过 <code>RequestMatcher</code> 配置例外。
来看看 <code>HttpSecurity</code> 的默认配置：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">/**
    * 创建 HttpSecurity 实例
    */</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">HttpSecurity</span> <span class="token function">getHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    http <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpSecurity</span><span class="token punctuation">(</span>objectPostProcessor<span class="token punctuation">,</span> authenticationBuilder<span class="token punctuation">,</span> sharedObjects<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>disableDefaults<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      http
        <span class="token comment">// csrf 跨站请求伪造保护</span>
        <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 配置异步支持</span>
        <span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebAsyncManagerIntegrationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// security 异常处理</span>
        <span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 将请求的 header 写入响应的 header</span>
        <span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// session 管理器，可以配置一个用户仅有一个会话有效</span>
        <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 保存认证信息（session维度）</span>
        <span class="token punctuation">.</span><span class="token function">securityContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 保存 request cache</span>
        <span class="token punctuation">.</span><span class="token function">requestCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 匿名认证配置</span>
        <span class="token punctuation">.</span><span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 配置重载 servlet 相关安全方法</span>
        <span class="token punctuation">.</span><span class="token function">servletApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 表单登录页配置</span>
        <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultLoginPageConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 匹配 /logout 做登出逻辑，成功后跳转登录页</span>
        <span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// HttpSecurity 扩展配置</span>
    <span class="token function">configure</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> http<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * HttpSecurity 扩展配置
   */</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    http
      <span class="token comment">// 约束基于 HttpServletRequest 的请求</span>
      <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 任何请求 需要认证</span>
        <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 表单登录</span>
      <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// http basic 认证</span>
      <span class="token punctuation">.</span><span class="token function">httpBasic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>与配置认证管理器相同的是，在配置 <code>HttpSecurity</code> 的过程中，留有一个名为 <code>configure</code> 的方法供开发者配置。默认的配置方法拦截了所有请求，要求必须经过身份认证才能正确访问 <code>web</code> 资源，默认有表单登录和 <code>http basic</code> 两种认证方式可以选择。<code>HttpSecurity</code> 提供的大多数配置方法，都是通过过滤器实现的。</p> <h4 id="form-login-表单登录"><a href="#form-login-表单登录" class="header-anchor">#</a> form login 表单登录</h4> <p><code>formLogin</code> 方法引入了 <code>FormLoginConfigurer</code>，此类中配置了两个过滤器：</p> <ul><li><code>UsernamePasswordAuthenticationFilter</code>：在创建过滤器时默认使用 <code>/login POST</code> 作为表单登录请求，这个过滤器的过滤逻辑就是调用上文中配置的 <code>AuthenticationManager</code> 进行认证。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>如果认证成功，默认会保存认证信息，并重定向到相应的请求地址；如果认证失败，默认会重定向到登录页面。</p> <ul><li><code>DefaultLoginPageGeneratingFilter</code>：用于配置登录页面，登录页面默认的登录、登出、登录错误地址分别为 <code>/login /login?logout /login?error</code>，其初始化配置在 <code>HttpSecurity</code> 的默认配置中。过滤逻辑为当请求为这 3 个地址时，会生成一个表单登录的 <code>HTML</code> 并立即返回。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">;</span>
    <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> res<span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> loginError <span class="token operator">=</span> <span class="token function">isErrorPage</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> logoutSuccess <span class="token operator">=</span> <span class="token function">isLogoutSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 登录、登出或登录失败时跳转到登录页。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLoginUrlRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token operator">||</span> loginError <span class="token operator">||</span> logoutSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 生成 HTML 表单</span>
      <span class="token class-name">String</span> loginPageHtml <span class="token operator">=</span> <span class="token function">generateLoginPageHtml</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> loginError<span class="token punctuation">,</span> logoutSuccess<span class="token punctuation">)</span><span class="token punctuation">;</span>
      response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;text/html;charset=UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      response<span class="token punctuation">.</span><span class="token function">setContentLength</span><span class="token punctuation">(</span>loginPageHtml<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>loginPageHtml<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="http-basic-认证"><a href="#http-basic-认证" class="header-anchor">#</a> http basic 认证</h4> <p><code>httpBasic</code> 方法配置了 <code>BasicAuthenticationFilter</code> 过滤器，其过滤逻辑是从取出 <code>Authorization</code> 头，请求头内容为 <code>username:password</code> 的 <code>Base64</code> 编码形式。在获取用户名、密码后，同样调用 <code>AuthenticationManager</code> 进行认证。</p> <h4 id="csrf-跨站请求伪造保护"><a href="#csrf-跨站请求伪造保护" class="header-anchor">#</a> csrf 跨站请求伪造保护</h4> <p><code>csrf</code> 方法配置了 <code>CsrfFilter</code>，其过滤逻辑为默认放行 <code>GET</code> 等请求，其它请求需要进行 <code>CsrfToken</code> 校验。访问请求走到这个过滤器时，如果没有携带 <code>CsrfToken</code>，会新生成并放入请求中。过滤器链继续走到 <code>DefaultLoginPageGeneratingFilter</code>，由于在 <code>DefaultLoginPageConfigurer</code> 配置时，从请求中会取出 <code>CsrfToken</code> 交给 <code>DefaultLoginPageGeneratingFilter</code>，所以 <code>CsrfToken</code> 会一并生成 <code>HTML</code> 表单，我们使用默认的登录页面就能正确提交表单。</p> <h4 id="securitycontext-认证上下文"><a href="#securitycontext-认证上下文" class="header-anchor">#</a> securityContext 认证上下文</h4> <p><code>securityContext</code> 方法配置了 <code>SecurityContextPersistenceFilter</code>，其过滤逻辑为为每个会话创建一个 <code>SecurityContext</code>。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token class-name">HttpRequestResponseHolder</span> holder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpRequestResponseHolder</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 从 session 中取出或在 session中设置 SecurityContext</span>
  <span class="token class-name">SecurityContext</span> contextBeforeChainExecution <span class="token operator">=</span> repo<span class="token punctuation">.</span><span class="token function">loadContext</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>contextBeforeChainExecution<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在 <code>UsernamePasswordAuthenticationFilter</code> 中，如果认证成功，则会调用 <code>successfulAuthentication</code> 方法，将认证成功的 <code>Authentication</code> 信息放入 <code>SecurityContextHolder</code> 中。开发者由此可以使用 <code>SecurityContextHolder.getContext().getAuthentication();</code> 获取当前会话的认证用户信息。由于认证信息存放在 <code>session</code> 中，一旦用户认证成功，当访问其它请求时，经由此过滤器时，就可以直接取得认证信息，安全通过过滤器链。</p> <h4 id="authorizerequests-最后的守门员"><a href="#authorizerequests-最后的守门员" class="header-anchor">#</a> authorizeRequests 最后的守门员</h4> <p>在经历一系列过滤逻辑之后，请求来到 <code>spring security</code> 最后的过滤器 <code>FilterSecurityInterceptor</code>，此过滤器通过调用 <code>authorizeRequests</code> 方法加载 <code>ExpressionUrlAuthorizationConfigurer</code> 配置：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token class-name">FilterSecurityInterceptor</span> securityInterceptor <span class="token operator">=</span> <span class="token function">createFilterSecurityInterceptor</span><span class="token punctuation">(</span>
        http<span class="token punctuation">,</span> metadataSource<span class="token punctuation">,</span> http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...</span>

    http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>securityInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    http<span class="token punctuation">.</span><span class="token function">setSharedObject</span><span class="token punctuation">(</span><span class="token class-name">FilterSecurityInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> securityInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token class-name">FilterSecurityInterceptor</span> <span class="token function">createFilterSecurityInterceptor</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">,</span>
      <span class="token class-name">FilterInvocationSecurityMetadataSource</span> metadataSource<span class="token punctuation">,</span>
      <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">FilterSecurityInterceptor</span> securityInterceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterSecurityInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    securityInterceptor<span class="token punctuation">.</span><span class="token function">setSecurityMetadataSource</span><span class="token punctuation">(</span>metadataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建权限验证配置，默认为 AffirmativeBased，即满足一项则鉴权成功</span>
    securityInterceptor<span class="token punctuation">.</span><span class="token function">setAccessDecisionManager</span><span class="token punctuation">(</span><span class="token function">getAccessDecisionManager</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 配置认证管理器</span>
    securityInterceptor<span class="token punctuation">.</span><span class="token function">setAuthenticationManager</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    securityInterceptor<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> securityInterceptor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>在此过滤器的逻辑中，视图对此次访问进行权限验证，如果无权限，则会抛出 <code>AccessDeniedException</code>：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">// Attempt authorization</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>accessDecisionManager<span class="token punctuation">.</span><span class="token function">decide</span><span class="token punctuation">(</span>authenticated<span class="token punctuation">,</span> object<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span> accessDeniedException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AuthorizationFailureEvent</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> authenticated<span class="token punctuation">,</span> accessDeniedException<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> accessDeniedException<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>一旦抛出了异常，顺序排在 <code>FilterSecurityInterceptor</code> 前一位的过滤器 <code>ExceptionTranslationFilter</code> 正好就能捕捉到此异常。此过滤器在 <code>HttpSecurity</code> 通过调用<code>exceptionHandling</code> 方法配置 <code>ExceptionHandlingConfigurer</code> 声明。过滤逻辑如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">;</span>
    <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> res<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

      logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Chain processed normally&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 捕捉 FilterSecurityInterceptor 过滤逻辑抛出的异常</span>
      <span class="token comment">// ...</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>ase <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ase <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span><span class="token punctuation">)</span> throwableAnalyzer<span class="token punctuation">.</span><span class="token function">getFirstThrowableOfType</span><span class="token punctuation">(</span>
            <span class="token class-name">AccessDeniedException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> causeChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>ase <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// 捕捉到 AccessDeniedException</span>
        <span class="token function">handleSpringSecurityException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> ase<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleSpringSecurityException</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
      <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span> <span class="token class-name">RuntimeException</span> exception<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token comment">// 认证异常</span>
      <span class="token function">sendStartAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span><span class="token punctuation">)</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 权限异常</span>
      <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>authenticationTrustResolver<span class="token punctuation">.</span><span class="token function">isAnonymous</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span> <span class="token operator">||</span> authenticationTrustResolver<span class="token punctuation">.</span><span class="token function">isRememberMe</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token function">sendStartAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">InsufficientAuthenticationException</span><span class="token punctuation">(</span>
              messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span>
                <span class="token string">&quot;ExceptionTranslationFilter.insufficientAuthentication&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Full authentication is required to access this resource&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// 其它异常</span>
        accessDeniedHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span><span class="token punctuation">)</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">sendStartAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
      <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span>
      <span class="token class-name">AuthenticationException</span> reason<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 缓存被中断的请求</span>
    requestCache<span class="token punctuation">.</span><span class="token function">saveRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 错误处理</span>
    authenticationEntryPoint<span class="token punctuation">.</span><span class="token function">commence</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>ExceptionTranslationFilter</code> 对 <code>AuthenticationException</code> 、 <code>AccessDeniedException</code> 和其它异常分别处理。<code>FormLoginConfigurer</code> 在初始化调用 <code>init</code> 方法时，对 <code>ExceptionTranslationFilter</code> 配置了 <code>LoginUrlAuthenticationEntryPoint</code>，因此对于认证和授权异常，会将请求重定向到登录页面。而对于其它异常，使用 <code>AccessDeniedHandlerImpl</code>，如果有错误页面，跳转到错误页面；否则发送 <code>403</code> 错误给客户端。</p> <h3 id="websecurityconfigureradapter-configure"><a href="#websecurityconfigureradapter-configure" class="header-anchor">#</a> WebSecurityConfigurerAdapter#configure</h3> <p>在 <code>WebSecurityConfigurerAdapter</code> 中 <code>void configure(WebSecurity web)</code> 方法默认为空实现，通过覆盖此方法，开发者可以配置不需要经过 <code>Spring Security</code> 认证的请求。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token comment">// 忽略指定url的请求（不走过滤器链）</span>
      web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mvcMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="websecurity-performbuild"><a href="#websecurity-performbuild" class="header-anchor">#</a> WebSecurity#performBuild</h4> <p>完成加载 <code>WebSecurityConfigurerAdapter</code> 中的配置后，进入 <code>WebSecurity#performBuild</code>，生成真正的安全过滤器链：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">protected</span> <span class="token class-name">Filter</span> <span class="token function">performBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">int</span> chainSize <span class="token operator">=</span> ignoredRequests<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> securityFilterChainBuilders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityFilterChain</span><span class="token punctuation">&gt;</span></span> securityFilterChains <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>chainSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 上文配置的需要忽略的请求</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> ignoredRequest <span class="token operator">:</span> ignoredRequests<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      securityFilterChains<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">(</span>ignoredRequest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 上文配置的 HttpSecurity 实例</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityFilterChain</span><span class="token punctuation">&gt;</span></span> securityFilterChainBuilder <span class="token operator">:</span> securityFilterChainBuilders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用 build 方法生成 DefaultSecurityFilterChain</span>
      securityFilterChains<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>securityFilterChainBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 过滤器链代理</span>
    <span class="token class-name">FilterChainProxy</span> filterChainProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterChainProxy</span><span class="token punctuation">(</span>securityFilterChains<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="filterchainproxy-执行各过滤器"><a href="#filterchainproxy-执行各过滤器" class="header-anchor">#</a> FilterChainProxy 执行各过滤器</h3> <p>生成 <code>FilterChainProxy</code> 的过程中，先是加载开发者配置的需要忽略的请求，包装到 <code>DefaultSecurityFilterChain</code> 中，生成一个没有过滤器的过滤器链。随之又调用 <code>HttpSecurity#build</code> 方法生成真正有过滤逻辑的过滤器链：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token class-name">FilterComparator</span> comparator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">protected</span> <span class="token class-name">DefaultSecurityFilterChain</span> <span class="token function">performBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先对配置的各过滤器进行排序，再加到过滤器链中</span>
    <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>filters<span class="token punctuation">,</span> comparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">(</span>requestMatcher<span class="token punctuation">,</span> filters<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>过滤器过滤顺序排序依赖 <code>FilterComparator</code>。自此，<code>springSecurityFilterChain</code> 配置完成并被加入全局请求过滤器列表。</p> <p>当请求经由 <code>FilterChainProxy</code> 过滤时，先根据 <code>request</code> 匹配过滤器：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFilters</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityFilterChain</span> chain <span class="token operator">:</span> filterChains<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">getFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>当请求配置为忽略，会匹配到无过滤器的 <code>DefaultSecurityFilterChain</code>，因此无需经历 <code>Spring Security</code> 各过滤器；否则走正常过滤逻辑。
拿到请求匹配的过滤器列表后，<code>FilterChainProxy</code> 生成一个 <code>VirtualFilterChain</code>，<code>Spring Security</code> 相关过滤器的过滤逻辑均在此执行，当相关过滤器执行完毕，再回到 <code>Spring MVC</code> 的过滤器链上来继续执行。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token class-name">VirtualFilterChain</span><span class="token punctuation">(</span><span class="token class-name">FirewalledRequest</span> firewalledRequest<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> additionalFilters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Spring MVC 过滤器链</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>originalChain <span class="token operator">=</span> chain<span class="token punctuation">;</span>
    <span class="token comment">// 请求匹配到的过滤器列表</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>additionalFilters <span class="token operator">=</span> additionalFilters<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> additionalFilters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>firewalledRequest <span class="token operator">=</span> firewalledRequest<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPosition <span class="token operator">==</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>

      <span class="token comment">// Spring Security 相关过滤器执行完毕，回到 Spring MVC 的过滤器链上来继续执行</span>
      originalChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      currentPosition<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token class-name">Filter</span> nextFilter <span class="token operator">=</span> additionalFilters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentPosition <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 按顺序来执行 Spring Security 相关过滤器</span>
      nextFilter<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>（1） <code>Spring Security</code> 开箱即用，拥有完善的默认配置机制，基于过滤器对 <code>web</code> 应用进行保护。
（2） 如果开发者需要对 <code>Spring Security</code> 自动配置进行干预，可以继承 <code>WebSecurityConfigurerAdapter</code> 并实现它的 3 个 <code>configure</code> 方法：</p> <ul><li><code>void configure(AuthenticationManagerBuilder auth)</code>：配置认证管理器，开发者需要实现 <code>UserDetailsService</code> 接口，编写自定义认证逻辑，并将接口实现注册到 <code>Spring</code> 容器，在此方法中指定认证逻辑实现。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li><code>void configure(HttpSecurity http)</code>：配置过滤器管理器，开发者在此方法中对默认的 <code>HttpSecurity</code> 进行修改：</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      http
              <span class="token comment">// 表单登录</span>
              <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token comment">// 关闭 csrf 保护</span>
              <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token comment">// 任何请求都需要认证</span>
              <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li><code>void configure(WebSecurity web)</code>：请求忽略配置，开发者在此可以配置不需要进行安全认证的请求：</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token comment">// 忽略指定url的请求（不走过滤器链）</span>
      web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mvcMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>（3）重要的定义</p> <ul><li><code>springSecurityFilterChain</code>：<code>Spring Security</code> 过滤器链。</li> <li><code>AuthenticationManager</code>：认证管理器，负责对用户身份进行认证。</li> <li><code>AuthenticationProvider</code>：认证逻辑具体实现，由认证管理器调用。</li> <li><code>UserDetailsService</code>：通过 <code>username</code> 认证，包装成 <code>AuthenticationProvider</code> 使用。</li> <li><code>SecurityContextPersistenceFilter</code>：从会话中加载有效认证信息或创建默认认证信息上下文。</li> <li><code>FilterSecurityInterceptor</code>：最终决定是否放行请求，如果需要认证而未认证，或没有相应的权限，都会判断请求失败。</li> <li><code>FilterChainProxy</code>：<code>Spring Security</code> 过滤器代理，关于安全的过滤逻辑均在此过滤器中执行，执行完成后才回到 <code>Spring MVC</code> 过滤器链中继续执行。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/posts/mybatis/MyBatis源码分析（九）：集成Spring.html" class="prev">MyBatis 源码分析（九）：集成 Spring</a></span> <span class="next"><a href="/posts/security/SpringSecurity源码分析（二）：表单登录.html">Spring Security 源码分析（二）：表单登录</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.15a66b26.js" defer></script><script src="/assets/js/2.92cd0f37.js" defer></script><script src="/assets/js/39.a72bb5df.js" defer></script>
  </body>
</html>

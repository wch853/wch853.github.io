<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Security 源码分析（二）：表单登录 | wch的个人主页</title>
    <meta name="description" content="用于分享wch的学习笔记和项目~">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.74c45c5d.css" as="style"><link rel="preload" href="/assets/js/app.15a66b26.js" as="script"><link rel="preload" href="/assets/js/2.92cd0f37.js" as="script"><link rel="preload" href="/assets/js/41.d351ec5d.js" as="script"><link rel="prefetch" href="/assets/js/10.1166f652.js"><link rel="prefetch" href="/assets/js/11.b6ae0b14.js"><link rel="prefetch" href="/assets/js/12.7802c7ba.js"><link rel="prefetch" href="/assets/js/13.63066938.js"><link rel="prefetch" href="/assets/js/14.1f9fa0d5.js"><link rel="prefetch" href="/assets/js/15.6c758eca.js"><link rel="prefetch" href="/assets/js/16.58440a84.js"><link rel="prefetch" href="/assets/js/17.1e1f5c53.js"><link rel="prefetch" href="/assets/js/18.28115609.js"><link rel="prefetch" href="/assets/js/19.7e395424.js"><link rel="prefetch" href="/assets/js/20.2c2ea5f8.js"><link rel="prefetch" href="/assets/js/21.1e8ef167.js"><link rel="prefetch" href="/assets/js/22.47a8f5b7.js"><link rel="prefetch" href="/assets/js/23.f507c548.js"><link rel="prefetch" href="/assets/js/24.b19f43b8.js"><link rel="prefetch" href="/assets/js/25.5b1882b0.js"><link rel="prefetch" href="/assets/js/26.16cf6f8a.js"><link rel="prefetch" href="/assets/js/27.6f3498d0.js"><link rel="prefetch" href="/assets/js/28.f56b7e3c.js"><link rel="prefetch" href="/assets/js/29.de1da78b.js"><link rel="prefetch" href="/assets/js/3.73d3287d.js"><link rel="prefetch" href="/assets/js/30.108b25a0.js"><link rel="prefetch" href="/assets/js/31.68af7d35.js"><link rel="prefetch" href="/assets/js/32.c9f05837.js"><link rel="prefetch" href="/assets/js/33.13bd6f64.js"><link rel="prefetch" href="/assets/js/34.59041fd7.js"><link rel="prefetch" href="/assets/js/35.4382a261.js"><link rel="prefetch" href="/assets/js/36.01d6324a.js"><link rel="prefetch" href="/assets/js/37.22e4179e.js"><link rel="prefetch" href="/assets/js/38.f553994e.js"><link rel="prefetch" href="/assets/js/39.a72bb5df.js"><link rel="prefetch" href="/assets/js/4.9a52aae5.js"><link rel="prefetch" href="/assets/js/40.3751cd34.js"><link rel="prefetch" href="/assets/js/42.b87a3eae.js"><link rel="prefetch" href="/assets/js/43.7035de8a.js"><link rel="prefetch" href="/assets/js/44.2c18f0bc.js"><link rel="prefetch" href="/assets/js/45.52905280.js"><link rel="prefetch" href="/assets/js/46.abb047a4.js"><link rel="prefetch" href="/assets/js/47.2ac230d3.js"><link rel="prefetch" href="/assets/js/48.b63bb42b.js"><link rel="prefetch" href="/assets/js/49.35752ae9.js"><link rel="prefetch" href="/assets/js/5.36029518.js"><link rel="prefetch" href="/assets/js/50.b6bd912f.js"><link rel="prefetch" href="/assets/js/51.0e0db65f.js"><link rel="prefetch" href="/assets/js/52.d15fb17a.js"><link rel="prefetch" href="/assets/js/53.844345be.js"><link rel="prefetch" href="/assets/js/54.52685e8c.js"><link rel="prefetch" href="/assets/js/55.83a99fe0.js"><link rel="prefetch" href="/assets/js/56.fe26d3a3.js"><link rel="prefetch" href="/assets/js/57.dae36566.js"><link rel="prefetch" href="/assets/js/58.1bfd28b1.js"><link rel="prefetch" href="/assets/js/59.88f55364.js"><link rel="prefetch" href="/assets/js/6.d3b55a54.js"><link rel="prefetch" href="/assets/js/7.af0443ed.js"><link rel="prefetch" href="/assets/js/8.2c9a7ea2.js"><link rel="prefetch" href="/assets/js/9.c08dcf83.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74c45c5d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">wch的个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java虚拟机</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java并发编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis 源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Spring Security 源码分析</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/security/SpringSecurity源码分析（一）：过滤器链.html" class="sidebar-link">Spring Security 源码分析（一）：过滤器链</a></li><li><a href="/posts/security/SpringSecurity源码分析（二）：表单登录.html" class="active sidebar-link">Spring Security 源码分析（二）：表单登录</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（二）：表单登录.html#自定义表单登录" class="sidebar-link">自定义表单登录</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（二）：表单登录.html#loginpage-自定义登录页面" class="sidebar-link">loginPage 自定义登录页面</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（二）：表单登录.html#loginpage-定义表单提交路径" class="sidebar-link">loginPage 定义表单提交路径</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（二）：表单登录.html#忽略对自定义登录页面的拦截" class="sidebar-link">忽略对自定义登录页面的拦截</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（二）：表单登录.html#登录后处理" class="sidebar-link">登录后处理</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（二）：表单登录.html#自定义过滤器" class="sidebar-link">自定义过滤器</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（二）：表单登录.html#记住我" class="sidebar-link">记住我</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（二）：表单登录.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/posts/security/SpringSecurity源码分析（三）：授权管理.html" class="sidebar-link">Spring Security 源码分析（三）：授权管理</a></li><li><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html" class="sidebar-link">Spring Security 源码分析（四）：OAth2实现</a></li><li><a href="/posts/security/SpringSecurity源码分析（五）：JWT实现.html" class="sidebar-link">Spring Security 源码分析（五）：JWT实现</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微信小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Elasticsearch</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="spring-security-源码分析（二）：表单登录"><a href="#spring-security-源码分析（二）：表单登录" class="header-anchor">#</a> Spring Security 源码分析（二）：表单登录</h1> <h2 id="自定义表单登录"><a href="#自定义表单登录" class="header-anchor">#</a> 自定义表单登录</h2> <p><code>FormLoginConfigurer</code> 提供了 <code>loginPage</code> 和 <code>loginProcessingUrl</code> 方法分别用于配置登录页面和表单提交请求处理路径。继承 <code>WebSecurityConfigurerAdapter</code>，重载关于过滤器和忽略请求的配置方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token comment">// 表单登录，配置表单页面和表单提交URL</span>
      http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">&quot;/login.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 任何请求都需要认证</span>
      <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token comment">// 登录页面请求不走 Spring Security 过滤器链</span>
      web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mvcMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/login.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="loginpage-自定义登录页面"><a href="#loginpage-自定义登录页面" class="header-anchor">#</a> loginPage 自定义登录页面</h3> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">protected</span> <span class="token class-name">T</span> <span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token class-name">String</span> loginPage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 配置自定义登录</span>
    <span class="token function">setLoginPage</span><span class="token punctuation">(</span>loginPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 更新登录错误 / 登出路径（基于 loginPage）</span>
    <span class="token function">updateAuthenticationDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 更新自定义标识</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>customLoginPage <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">getSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>在配置自定义登录页面后，同时会更新认证错误认证策略：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setLoginPage</span><span class="token punctuation">(</span><span class="token class-name">String</span> loginPage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loginPage <span class="token operator">=</span> loginPage<span class="token punctuation">;</span>
    <span class="token comment">// 更新认证异常时跳转页面</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationEntryPoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoginUrlAuthenticationEntryPoint</span><span class="token punctuation">(</span>loginPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>上一节中说到，当 <code>ExceptionTranslationFilter</code> 拦截到认证异常后，会调用 <code>LoginUrlAuthenticationEntryPoint#commence</code> 方法进行处理，其主要逻辑为将用户请求重定向到登录页面。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commence</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
      <span class="token class-name">AuthenticationException</span> authException<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// 获取配置的 loginPage</span>
    <span class="token class-name">String</span> loginForm <span class="token operator">=</span> <span class="token function">determineUrlToUseForThisRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> authException<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 请求重定向</span>
    <span class="token class-name">RequestDispatcher</span> dispatcher <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestDispatcher</span><span class="token punctuation">(</span>loginForm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dispatcher<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>loginPage</code> 方法更新 <code>customLoginPage</code> 标识后，<code>DefaultLoginPageGeneratingFilter</code> 的过滤逻辑也随之改变，其默认配置的需要拦截的相关路径为 <code>/login</code>，当开发者自定义登录页面路径后，经由此过滤器就不会再被拦截。</p> <h3 id="loginpage-定义表单提交路径"><a href="#loginpage-定义表单提交路径" class="header-anchor">#</a> loginPage 定义表单提交路径</h3> <p><code>loginPage</code> 方法中调用了 <code>updateAuthenticationDefaults</code> 方法，可见当不手动配置 <code>loginProcessingUrl</code> 时，会使用 <code>loginPage</code> 作为表单提交路径。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">updateAuthenticationDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loginProcessingUrl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 默认实用 loginPage 作为表单提交路径</span>
      <span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span>loginPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>但是 <code>FormLoginConfigurer</code> 配置的 <code>UsernamePasswordAuthenticationFilter</code> 则在默认构造方法中指定表单提交路径为 <code>/login</code>，也就是说如果开发者配置 <code>loginPage</code> 为其它路径，就无法正常进行认证。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 路径匹配才进行认证
   */</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">requiresAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
    <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> requiresAuthenticationRequestMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>因此为了 <code>UsernamePasswordAuthenticationFilter</code> 能够正常执行，开发者需要手动指定 <code>loginProcessingUrl</code>。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> loginProcessingUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loginProcessingUrl <span class="token operator">=</span> loginProcessingUrl<span class="token punctuation">;</span>
    <span class="token comment">// 设置过滤器处理登录逻辑的请求URL（可以指定其它名称覆盖 /login）</span>
    authFilter<span class="token punctuation">.</span><span class="token function">setRequiresAuthenticationRequestMatcher</span><span class="token punctuation">(</span><span class="token function">createLoginProcessingUrlMatcher</span><span class="token punctuation">(</span>loginProcessingUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">getSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="忽略对自定义登录页面的拦截"><a href="#忽略对自定义登录页面的拦截" class="header-anchor">#</a> 忽略对自定义登录页面的拦截</h3> <p>上文示例中配置的是对所有请求进行拦截，当过滤器链发现没有认证就会跳转到登录页面，但是访问登录页面也需要认证，这就会造成一直重定向，无法完成登录。因此需要配置登录页面请求不走 <code>Spring Security</code> 过滤器链，这样所有人就可以正常访问登录页面。</p> <h3 id="登录后处理"><a href="#登录后处理" class="header-anchor">#</a> 登录后处理</h3> <p>登录成功后是跳转到首页还是用户原先想访问的页面？失败后是仍跳转到登录页面还是自定义的错误页面？<code>Spring Security</code> 提供了若干方法用于开发者自定义登录后处理：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Resource</span>
  <span class="token keyword">private</span> <span class="token class-name">AuthenticationSuccessHandler</span> successHandler<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Resource</span>
  <span class="token keyword">private</span> <span class="token class-name">AuthenticationFailureHandler</span> failureHandler<span class="token punctuation">;</span>

  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 表单登录</span>
    http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// 认证成功后重定向URL</span>
            <span class="token punctuation">.</span><span class="token function">successForwardUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
            <span class="token comment">// 认证失败后重定向URL</span>
            <span class="token punctuation">.</span><span class="token function">failureForwardUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/login.html?error&quot;</span><span class="token punctuation">)</span>
            <span class="token comment">// 如果是从其它页面重定向到登录页面，则成功后跳转到原请求URL，否则跳转到指定URL</span>
            <span class="token punctuation">.</span><span class="token function">defaultSuccessUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
            <span class="token comment">// 认证失败后重定向URL</span>
            <span class="token punctuation">.</span><span class="token function">failureUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/login.html?error&quot;</span><span class="token punctuation">)</span>
            <span class="token comment">// 自定义认证成功后处理器</span>
            <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>successHandler<span class="token punctuation">)</span>
            <span class="token comment">// 自定义认证失败后处理器</span>
            <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>failureHandler<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// 任何请求都需要认证</span>
            <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>同样是重载 <code>void configure(HttpSecurity http)</code> 方法，干预认证过滤器的生成逻辑。可以看到 <code>HttpSecurity</code> 提供了 4 个修改重定向地址的方法，而实际上他们最后都是对 <code>successHandler</code> 和 <code>failureHandler</code> 进行配置。在 <code>UsernamePasswordAuthenticationFilter</code> 的认证逻辑中，当认证成功后会调用 <code>successfulAuthentication</code> 方法，而在此方法中又调用了 <code>AuthenticationSuccessHandler#onAuthenticationSuccess</code> 方法，如下是认证成功后处理器的一类实现：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    request<span class="token punctuation">.</span><span class="token function">getRequestDispatcher</span><span class="token punctuation">(</span>forwardUrl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>但是在前后端分离的项目中，认证系统可能作为一个单独的后端模块单独拆出来，配置登录跳转就无法满足与前端交互的任务，因此开发者需要继承 <code>AuthenticationSuccessHandler</code> 和
<code>AuthenticationFailureHandler</code>，自定义认证后响应，以下为向前端返回认证失败的 <code>Json</code> 数据的一类实现：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonAuthenticationFailureHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationFailureHandler</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 状态码 401</span>
    response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>UNAUTHORIZED<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置返回类型为 json</span>
    response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/json;charset=UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">JSONUtils</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="自定义过滤器"><a href="#自定义过滤器" class="header-anchor">#</a> 自定义过滤器</h2> <p><code>HttpSecurity</code> 提供了若干方法为 <code>web</code> 请求添加过滤器，例如默认表单、认证过期、<code>CSRF</code> ` 保护等。同时开发者可以定义自已的过滤器，并指定在整个过滤器中的位置。如果需要在表单中添加验证码校验逻辑，可以使用如下示例：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">/**
  * 认证失败后处理器
  */</span>
  <span class="token annotation punctuation">@Resource</span>
  <span class="token keyword">private</span> <span class="token class-name">AuthenticationFailureHandler</span> failureHandler<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在认证登录前验证验证码</span>
    http<span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CaptchaFilter</span><span class="token punctuation">(</span>failureHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>；
  <span class="token punctuation">}</span>
</code></pre></div><p>在上文中我们说到，登录表单提交请求无论是成功还是失败，默认都会交由认证处理器进行跳转。因此在整个过滤器链中，关于验证码的过滤逻辑需要排在 <code>UsernamePasswordAuthenticationFilter</code> 之前。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token class-name">HttpSecurity</span> <span class="token function">addFilterBefore</span><span class="token punctuation">(</span><span class="token class-name">Filter</span> filter<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> beforeFilter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 过滤器排序器注册</span>
    comparator<span class="token punctuation">.</span><span class="token function">registerBefore</span><span class="token punctuation">(</span>filter<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beforeFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">addFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>所有 <code>Spring Security</code> 配置的过滤器，其顺序由 <code>FilterComparator</code> 管理：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FilterComparator</span> <span class="token keyword">implements</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

  <span class="token comment">/**
   * 初始化顺序
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> INITIAL_ORDER <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * order 步长
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> ORDER_STEP <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 过滤器名称 - 在过滤器中的顺序（order 越小，排序越靠前）
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> filterToOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">FilterComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Step</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Step</span><span class="token punctuation">(</span>INITIAL_ORDER<span class="token punctuation">,</span> ORDER_STEP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>

    <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextPersistenceFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>

    <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>

    <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">FilterSecurityInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBefore</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> filter<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> beforeFilter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Integer</span> position <span class="token operator">=</span> <span class="token function">getOrder</span><span class="token punctuation">(</span>beforeFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// 注册自定义过滤器</span>
    <span class="token function">put</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> position <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，<code>FilterComparator</code> 对 <code>Spring Security</code> 配置的默认过滤器维护了一个 <code>filterToOrder</code>，用于描述各个过滤器在过滤器链中的顺序，前后两个过滤器的顺序相差 100。<code>registerBefore</code> 方法将开发者自定义的过滤器注册到 <code>FilterComparator</code> 方法中，并指定其顺序与 <code>UsernamePasswordAuthenticationFilter</code> 相差 1。这样在过滤器中就能保证自定义的验证码过滤器 <a href="https://github.com/wch853/snippet/blob/master/security/security-web/src/main/java/com/wch/snippet/security/config/filter/CaptchaFilter.java" target="_blank" rel="noopener noreferrer">CaptchaFilter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 能够在认证过滤器前一位执行。</p> <h2 id="记住我"><a href="#记住我" class="header-anchor">#</a> 记住我</h2> <p>在过滤器配置中，可以通过 <code>remember</code> 方法配置 <code>记住我</code> 功能：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在认证登录前验证验证码</span>
    http<span class="token punctuation">.</span><span class="token function">rememberMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 任何请求都需要认证</span>
        <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>rememberMe</code> 方法通过 <code>RememberMeConfigurer</code> 配置 <code>RememberMeAuthenticationFilter</code>，在 <code>init</code> 方法中先生成了一个 <code>RememberMeServices</code>：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token class-name">RememberMeServices</span> <span class="token function">getRememberMeServices</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token comment">//</span>
    <span class="token class-name">AbstractRememberMeServices</span> tokenRememberMeServices <span class="token operator">=</span> <span class="token function">createRememberMeServices</span><span class="token punctuation">(</span>
        http<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 表单登录参数名默认为 remember-me</span>
    tokenRememberMeServices<span class="token punctuation">.</span><span class="token function">setParameter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Cookie 名称默认为 remember-me</span>
    tokenRememberMeServices<span class="token punctuation">.</span><span class="token function">setCookieName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeCookieName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// 配置记住我过期时间，默认为两周</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tokenValiditySeconds <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  		tokenRememberMeServices<span class="token punctuation">.</span><span class="token function">setTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tokenValiditySeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// 如果用户主动登出了，需要清除记住我功能做的相关配置</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logoutHandler <span class="token operator">=</span> tokenRememberMeServices<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeServices <span class="token operator">=</span> tokenRememberMeServices<span class="token punctuation">;</span>
    <span class="token keyword">return</span> tokenRememberMeServices<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>对于创建基础的 <code>AbstractRememberMeServices</code>，<code>Spring Security</code> 提供了两种方式，一种是 <code>TokenBasedRememberMeServices</code>：是否能够使用 <code>记住我</code> 功能、校验都只依赖请求中的 <code>Cookie</code>；另一种是配置 <code>PersistentTokenRepository</code>：<code>InMemoryTokenRepositoryImpl</code> 在内存中维护一个 <code>Map</code> 用于对 <code>记住我</code> 进行校验，<code>JdbcTokenRepositoryImpl</code> 会从数据库中查询相关的 <code>token</code> 进行校验。这两种方式都是依赖请求中携带的 <code>Cookie</code>。当用户提交登出请求，应该取消 <code>记住我</code> 功能，<code>AbstractRememberMeServices</code> 对此的实现为清除名为 <code>remember-me</code> 的 <code>Cookie</code>：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">cancelCookie</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span>cookieName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token function">getCookiePath</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>

    response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>RememberMeServices</code> 配置完成后，<code>RememberMeAuthenticationFilter</code> 被加到过滤器链中，其过滤逻辑如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 没有经过认证，SecurityContext 为空，尝试使用 记住我 功能</span>

      <span class="token comment">// 检验 Cookie，如果有效进行自动登录</span>
      <span class="token class-name">Authentication</span> rememberMeAuth <span class="token operator">=</span> rememberMeServices<span class="token punctuation">.</span><span class="token function">autoLogin</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>rememberMeAuth <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// remeber-me Cookie 有效，走用户认证逻辑</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          rememberMeAuth <span class="token operator">=</span> authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> authenticationException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 认证失败了，也会清除 remeber-me Cookie</span>
          rememberMeServices<span class="token punctuation">.</span><span class="token function">loginFail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>

      chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>如果 <code>SecurityContext</code> 没有认证信息，过滤器会尝试使用 <code>记住我</code> 功能，调用 <code>autoLogin</code> 方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Authentication</span> <span class="token function">autoLogin</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 从请求中获取名为 remember-me 的 Cookie</span>
    <span class="token class-name">String</span> rememberMeCookie <span class="token operator">=</span> <span class="token function">extractRememberMeCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>

    <span class="token class-name">UserDetails</span> user <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 原 Cookie 解码</span>
      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookieTokens <span class="token operator">=</span> <span class="token function">decodeCookie</span><span class="token punctuation">(</span>rememberMeCookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
      user <span class="token operator">=</span> <span class="token function">processAutoLoginCookie</span><span class="token punctuation">(</span>cookieTokens<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 校验用户账号是否有效</span>
      userDetailsChecker<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 创建认证信息</span>
      <span class="token keyword">return</span> <span class="token function">createSuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CookieTheftException</span> cte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 清理客户端的 remember-me Cookie</span>
      <span class="token function">cancelCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> cte<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>

    <span class="token function">cancelCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>TokenBasedRememberMeServices</code> 中对于 <code>processAutoLoginCookie</code> 方法的实现为：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">protected</span> <span class="token class-name">UserDetails</span> <span class="token function">processAutoLoginCookie</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookieTokens<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">long</span> tokenExpiryTime<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      tokenExpiryTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>cookieTokens<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> nfe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidCookieException</span><span class="token punctuation">(</span>
          <span class="token string">&quot;Cookie token[1] did not contain a valid number (contained '&quot;</span>
              <span class="token operator">+</span> cookieTokens<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">&quot;')&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>

    <span class="token comment">// 根据用户名加载用户信息</span>
    <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token function">getUserDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>cookieTokens<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据过期时间、用户名、密码生成 MD5 签名</span>
    <span class="token class-name">String</span> expectedTokenSignature <span class="token operator">=</span> <span class="token function">makeTokenSignature</span><span class="token punctuation">(</span>tokenExpiryTime<span class="token punctuation">,</span>
        userDetails<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 校验签名</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">equals</span><span class="token punctuation">(</span>expectedTokenSignature<span class="token punctuation">,</span> cookieTokens<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidCookieException</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie token[2] contained signature '&quot;</span>
          <span class="token operator">+</span> cookieTokens<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">&quot;' but expected '&quot;</span> <span class="token operator">+</span> expectedTokenSignature <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> userDetails<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>对 <code>Cookie</code> 进行解码后，根据登录用户的相关信息做 <code>MD5</code> 校验，如果认定 <code>Cookie</code> 中的 <code>Token</code> 有效，则会查询用户信息，生成认证身份，通过认证流程。那么，<code>记住我</code> 的 <code>Cookie</code> 是在何时放入的呢？在 <code>RememberMeConfigurer</code> 的初始化过程中，默认的 <code>remember-me</code> 表单名被传递给表单生成过滤器：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initDefaultLoginFilter</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">DefaultLoginPageGeneratingFilter</span> loginPageGeneratingFilter <span class="token operator">=</span> http
    <span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">DefaultLoginPageGeneratingFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>loginPageGeneratingFilter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将表单名 remember-me 传递给默认表单生成过滤器，生成 记住我 复选框</span>
    loginPageGeneratingFilter<span class="token punctuation">.</span><span class="token function">setRememberMeParameter</span><span class="token punctuation">(</span><span class="token function">getRememberMeParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>表单中会根据传入的名称生成如下 <code>HTML</code> 代码：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>checkbox<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>remember-me<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span> Remember me on this computer.
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>UsernamePasswordAuthenticationFilter</code> 在用户认证成功后会调用 <code>successfulAuthentication</code> 方法，在此方法中会取出 <code>remember-me</code> 参数，判断是否使用 <code>记住我</code> 功能。而后又调用了 <code>RememberMeServices</code> 的 <code>loginSuccess</code> 方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">loginSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> successfulAuthentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 请求参数中是否要求使用记住我功能</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">rememberMeRequested</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Remember-me login not requested.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 要求使用记住我功能，响应中构造 Cookie</span>
    <span class="token function">onLoginSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> successfulAuthentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>TokenBasedRememberMeServices</code> 中对于 <code>onLoginSuccess</code> 方法的实现为：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLoginSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> successfulAuthentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token function">retrieveUserName</span><span class="token punctuation">(</span>successfulAuthentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token function">retrievePassword</span><span class="token punctuation">(</span>successfulAuthentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>

  <span class="token comment">// Cookie 失效时间</span>
  <span class="token keyword">int</span> tokenLifetime <span class="token operator">=</span> <span class="token function">calculateLoginLifetime</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> successfulAuthentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> expiryTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  expiryTime <span class="token operator">+=</span> <span class="token number">1000L</span> <span class="token operator">*</span> <span class="token punctuation">(</span>tokenLifetime <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> TWO_WEEKS_S <span class="token operator">:</span> tokenLifetime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 构造 MD5 签名，与校验 Cookie 的逻辑一致</span>
  <span class="token class-name">String</span> signatureValue <span class="token operator">=</span> <span class="token function">makeTokenSignature</span><span class="token punctuation">(</span>expiryTime<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 在响应中添加 Cookie</span>
  <span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>expiryTime<span class="token punctuation">)</span><span class="token punctuation">,</span> signatureValue <span class="token punctuation">}</span><span class="token punctuation">,</span>
            tokenLifetime<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果配置了 <code>PersistentTokenRepository</code> 其流程大致相同，区别在于 <code>Cookie</code> 的生成和校验逻辑不同，在此不多做赘述。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <ul><li><p>通过配置 <code>FormLoginConfigurer</code> 的 <code>loginPage</code> 和 <code>loginProcessingUrl</code> 可以切换默认登录页面和表单请求地址。</p></li> <li><p>通过配置 <code>FormLoginConfigurer</code> 的 <code>successHandler</code> 和 <code>failureHandler</code> 可以干预认证成功 / 失败后的服务端控制行为。</p></li> <li><p><code>Spring Security</code> 过滤器链中的过滤器执行顺序由 <code>FilterComparator</code> 管理。如果需要在过滤器链中增加自定义过滤器，可以通过 <code>HttpSecurity</code> 的 <code>addFilterBefore</code> 或者 <code>addFilterAfter</code> 方法将自定义过滤器加在指定过滤器前 / 后。</p></li> <li><p>配置 <code>RememberMe</code> 后，认证成功和失败，响应都会返回 <code>Cookie</code> 给客户端，下一次未经认证即访问 <code>web</code> 资源时，会对请求携带的 <code>Cookie</code> 进行校验，如果有效则会自动登录，执行认证逻辑。</p></li> <li><p>表单登录的相关扩展仍然离不开过滤器的支持，以下是几个较为重要的 <code>Spring Security</code> 过滤器：</p> <p><img src="/img/security/SpringSecuirty%E4%B8%BB%E8%A6%81%E8%BF%87%E6%BB%A4%E5%99%A8.png" alt="SpringSecuirty主要过滤器"></p></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/posts/security/SpringSecurity源码分析（一）：过滤器链.html" class="prev">Spring Security 源码分析（一）：过滤器链</a></span> <span class="next"><a href="/posts/security/SpringSecurity源码分析（三）：授权管理.html">Spring Security 源码分析（三）：授权管理</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.15a66b26.js" defer></script><script src="/assets/js/2.92cd0f37.js" defer></script><script src="/assets/js/41.d351ec5d.js" defer></script>
  </body>
</html>

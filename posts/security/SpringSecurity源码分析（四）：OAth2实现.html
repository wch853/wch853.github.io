<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Security 源码分析（四）：OAuth2 实现 | wch的个人主页</title>
    <meta name="description" content="用于分享wch的学习笔记和项目~">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.74c45c5d.css" as="style"><link rel="preload" href="/assets/js/app.15a66b26.js" as="script"><link rel="preload" href="/assets/js/2.92cd0f37.js" as="script"><link rel="preload" href="/assets/js/43.7035de8a.js" as="script"><link rel="prefetch" href="/assets/js/10.1166f652.js"><link rel="prefetch" href="/assets/js/11.b6ae0b14.js"><link rel="prefetch" href="/assets/js/12.7802c7ba.js"><link rel="prefetch" href="/assets/js/13.63066938.js"><link rel="prefetch" href="/assets/js/14.1f9fa0d5.js"><link rel="prefetch" href="/assets/js/15.6c758eca.js"><link rel="prefetch" href="/assets/js/16.58440a84.js"><link rel="prefetch" href="/assets/js/17.1e1f5c53.js"><link rel="prefetch" href="/assets/js/18.28115609.js"><link rel="prefetch" href="/assets/js/19.7e395424.js"><link rel="prefetch" href="/assets/js/20.2c2ea5f8.js"><link rel="prefetch" href="/assets/js/21.1e8ef167.js"><link rel="prefetch" href="/assets/js/22.47a8f5b7.js"><link rel="prefetch" href="/assets/js/23.f507c548.js"><link rel="prefetch" href="/assets/js/24.b19f43b8.js"><link rel="prefetch" href="/assets/js/25.5b1882b0.js"><link rel="prefetch" href="/assets/js/26.16cf6f8a.js"><link rel="prefetch" href="/assets/js/27.6f3498d0.js"><link rel="prefetch" href="/assets/js/28.f56b7e3c.js"><link rel="prefetch" href="/assets/js/29.de1da78b.js"><link rel="prefetch" href="/assets/js/3.73d3287d.js"><link rel="prefetch" href="/assets/js/30.108b25a0.js"><link rel="prefetch" href="/assets/js/31.68af7d35.js"><link rel="prefetch" href="/assets/js/32.c9f05837.js"><link rel="prefetch" href="/assets/js/33.13bd6f64.js"><link rel="prefetch" href="/assets/js/34.59041fd7.js"><link rel="prefetch" href="/assets/js/35.4382a261.js"><link rel="prefetch" href="/assets/js/36.01d6324a.js"><link rel="prefetch" href="/assets/js/37.22e4179e.js"><link rel="prefetch" href="/assets/js/38.f553994e.js"><link rel="prefetch" href="/assets/js/39.a72bb5df.js"><link rel="prefetch" href="/assets/js/4.9a52aae5.js"><link rel="prefetch" href="/assets/js/40.3751cd34.js"><link rel="prefetch" href="/assets/js/41.d351ec5d.js"><link rel="prefetch" href="/assets/js/42.b87a3eae.js"><link rel="prefetch" href="/assets/js/44.2c18f0bc.js"><link rel="prefetch" href="/assets/js/45.52905280.js"><link rel="prefetch" href="/assets/js/46.abb047a4.js"><link rel="prefetch" href="/assets/js/47.2ac230d3.js"><link rel="prefetch" href="/assets/js/48.b63bb42b.js"><link rel="prefetch" href="/assets/js/49.35752ae9.js"><link rel="prefetch" href="/assets/js/5.36029518.js"><link rel="prefetch" href="/assets/js/50.b6bd912f.js"><link rel="prefetch" href="/assets/js/51.0e0db65f.js"><link rel="prefetch" href="/assets/js/52.d15fb17a.js"><link rel="prefetch" href="/assets/js/53.844345be.js"><link rel="prefetch" href="/assets/js/54.52685e8c.js"><link rel="prefetch" href="/assets/js/55.83a99fe0.js"><link rel="prefetch" href="/assets/js/56.fe26d3a3.js"><link rel="prefetch" href="/assets/js/57.dae36566.js"><link rel="prefetch" href="/assets/js/58.1bfd28b1.js"><link rel="prefetch" href="/assets/js/59.88f55364.js"><link rel="prefetch" href="/assets/js/6.d3b55a54.js"><link rel="prefetch" href="/assets/js/7.af0443ed.js"><link rel="prefetch" href="/assets/js/8.2c9a7ea2.js"><link rel="prefetch" href="/assets/js/9.c08dcf83.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74c45c5d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">wch的个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java虚拟机</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java并发编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis 源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Spring Security 源码分析</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/security/SpringSecurity源码分析（一）：过滤器链.html" class="sidebar-link">Spring Security 源码分析（一）：过滤器链</a></li><li><a href="/posts/security/SpringSecurity源码分析（二）：表单登录.html" class="sidebar-link">Spring Security 源码分析（二）：表单登录</a></li><li><a href="/posts/security/SpringSecurity源码分析（三）：授权管理.html" class="sidebar-link">Spring Security 源码分析（三）：授权管理</a></li><li><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html" class="active sidebar-link">Spring Security 源码分析（四）：OAth2实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html#oauth2" class="sidebar-link">OAuth2</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html#角色" class="sidebar-link">角色</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html#申请授权流程" class="sidebar-link">申请授权流程</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html#授权方式" class="sidebar-link">授权方式</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html#spring-oauth2-自动装配" class="sidebar-link">Spring OAuth2 自动装配</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html#授权服务器自动化配置" class="sidebar-link">授权服务器自动化配置</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html#授权服务器配置扩展" class="sidebar-link">授权服务器配置扩展</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html#oauth2-授权" class="sidebar-link">OAuth2 授权</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html#授权码授权" class="sidebar-link">授权码授权</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html#隐式授权" class="sidebar-link">隐式授权</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html#密码授权" class="sidebar-link">密码授权</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html#第三方应用凭证授权" class="sidebar-link">第三方应用凭证授权</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html#刷新令牌" class="sidebar-link">刷新令牌</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html#访问资源服务器" class="sidebar-link">访问资源服务器</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/posts/security/SpringSecurity源码分析（五）：JWT实现.html" class="sidebar-link">Spring Security 源码分析（五）：JWT实现</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微信小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Elasticsearch</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="spring-security-源码分析（四）：oauth2-实现"><a href="#spring-security-源码分析（四）：oauth2-实现" class="header-anchor">#</a> Spring Security 源码分析（四）：OAuth2 实现</h1> <h2 id="oauth2"><a href="#oauth2" class="header-anchor">#</a> OAuth2</h2> <p><code>OAuth2</code>是一个开放<a href="https://tools.ietf.org/html/rfc6749#section-4.1.1" target="_blank" rel="noopener noreferrer">标准<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，允许用户在不将用户名和密码提供给第三方应用的情况下，授权第三方应用访问用户存储在其它服务提供者服务器上的资源。</p> <h3 id="角色"><a href="#角色" class="header-anchor">#</a> 角色</h3> <p><code>OAuth</code> 标准中定义了以下几种角色：</p> <ul><li><code>Resource Owner</code>：资源所有者。拥有访问受保护资源权限的实体，即用户。</li> <li><code>Resource Server</code>：托管受保护资源的服务器，能够接收和响应持有 <code>access token</code> 的对受保护资源的请求。</li> <li><code>Client</code> ：资源所有者许可访问受保护资源的第三方应用。</li> <li><code>Authorization Server</code>：授权服务器，在对资源所有者及其权限认证完成后向第三方应用颁发 <code>access token</code>。</li></ul> <h3 id="申请授权流程"><a href="#申请授权流程" class="header-anchor">#</a> 申请授权流程</h3> <div class="language- extra-class"><pre class="language-text"><code> +--------+                               +---------------+
 |        |--(A)- Authorization Request -&gt;|   Resource    |
 |        |                               |     Owner     |
 |        |&lt;-(B)-- Authorization Grant ---|               |
 |        |                               +---------------+
 |        |
 |        |                               +---------------+
 |        |--(C)-- Authorization Grant --&gt;| Authorization |
 | Client |                               |     Server    |
 |        |&lt;-(D)----- Access Token -------|               |
 |        |                               +---------------+
 |        |
 |        |                               +---------------+
 |        |--(E)----- Access Token ------&gt;|    Resource   |
 |        |                               |     Server    |
 |        |&lt;-(F)--- Protected Resource ---|               |
 +--------+                               +---------------+
</code></pre></div><p>上图描述了 <code>OAuth 2.0</code> 四种角色之间的交互流程，包括以下步骤：</p> <ul><li>（A）第三方应用向资源所有者请求授权。</li> <li>（B）第三方应用收到授权许可。</li> <li>（C）第三方应用向授权服务器出示授权许可。</li> <li>（D）授权服务器验证第三方应用身份和授权许可，颁发访问令牌。</li> <li>（E）第三方应用持有访问令牌向资源服务器请求受保护资源。</li> <li>（F）资源服务器验证访问令牌并响应。</li></ul> <h3 id="授权方式"><a href="#授权方式" class="header-anchor">#</a> 授权方式</h3> <ul><li><code>authorization_code</code>：授权码模式，第三方应用引导资源所有者前往授权服务器进行授权，完成后引导资源所有者携带授权码会回到第三方应用，通过授权码第三方应用可以获取真正的访问令牌。</li> <li><code>implicit</code>：隐式许可，相对于授权码模式，第三方应用不再需要授权码，而是在资源所有者授权后直接被颁发一个访问令牌。</li> <li><code>password</code>：资源所有者密码凭据，将资源所有者的密码凭据直接作为获取访问令牌的授权许可。通常用于资源所有者高度信任第三方应用的情况。</li> <li><code>client_credentials</code>：第三方应用凭证，仅使用 <code>client_id</code> 和 <code>client_secret</code> 进行授权，用来获取第三方应用下控制的资源，或者事先与授权服务器商定好的受保护资源。</li></ul> <h2 id="spring-oauth2-自动装配"><a href="#spring-oauth2-自动装配" class="header-anchor">#</a> Spring OAuth2 自动装配</h2> <p>引入 <code>spring-security-oauth2-autoconfigure</code> 依赖：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.security.oauth.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-oauth2-autoconfigure<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>此依赖中的 <code>spring.factories</code> 文件指定加载 <code>OAuth2AutoConfiguration</code>，此类通过 <code>@Import</code> 注解引入 <code>OAuth2AuthorizationServerConfiguration</code>，这是一个实现了 <code>AuthorizationServerConfigurer</code> 接口的类，接口中的注释说到：此接口中的方法都是用来配置 <code>OAuth2</code> 授权服务器的，如果使用了 <code>@EnableAuthorizationServer</code> 注解，这个接口的实现类都会自动被注入到 <code>Spring</code> 容器中。</p> <h3 id="授权服务器自动化配置"><a href="#授权服务器自动化配置" class="header-anchor">#</a> 授权服务器自动化配置</h3> <p>通过添加 <code>@EnableAuthorizationServer</code> 注解，一系列默认配置就被引入 <code>Spring</code> 容器。</p> <h4 id="第三方应用认证配置"><a href="#第三方应用认证配置" class="header-anchor">#</a> 第三方应用认证配置</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientDetailsServiceConfiguration</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;rawtypes&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">ClientDetailsServiceConfigurer</span> configurer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientDetailsServiceConfigurer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientDetailsServiceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 将第三方应用认证服务配置器注入 Spring 容器，使得认证服务可被干预
   */</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">ClientDetailsServiceConfigurer</span> <span class="token function">clientDetailsServiceConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> configurer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 懒加载第三方应用认证服务，等待认证服务加载干预配置
   */</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token annotation punctuation">@Lazy</span>
  <span class="token annotation punctuation">@Scope</span><span class="token punctuation">(</span>proxyMode<span class="token operator">=</span><span class="token class-name">ScopedProxyMode</span><span class="token punctuation">.</span>INTERFACES<span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">ClientDetailsService</span> <span class="token function">clientDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> configurer<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>可以看到 <code>ClientDetailsServiceConfigurer</code> 的一个实例被注入到 <code>Spring</code> 容器中，此配置生成的 <code>ClientDetailsService</code> 实例标记了 <code>@Lazy</code> 注解，要求被懒加载，此实例加载其它配置后在第一次使用时进行实例化。</p> <h4 id="授权端点配置"><a href="#授权端点配置" class="header-anchor">#</a> 授权端点配置</h4> <p>在 <code>OAuth2</code> 框架标准（<a href="https://tools.ietf.org/html/rfc6749" target="_blank" rel="noopener noreferrer">端点协议<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）中，获取授权需要经由两个授权服务器端点：</p> <ul><li><code>Authorization Endpoint</code>：通过客户端跳转引导资源所有者向第三方应用授权。</li> <li><code>Token Endpoint</code>：第三方应用携带授权许可与授权服务器交换访问令牌。</li></ul> <p><code>AuthorizationServerEndpointsConfiguration</code> 以 <code>Spring MVC</code> 接口的形式注入了两个端点的实现：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">TokenKeyEndpointRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationServerEndpointsConfiguration</span> <span class="token punctuation">{</span>

  <span class="token comment">/**
   * 授权端点配置
   */</span>
  <span class="token keyword">private</span> <span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizationServerEndpointsConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 第三方应用认证服务
   */</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">ClientDetailsService</span> clientDetailsService<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 自定义授权服务器配置
   */</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthorizationServerConfigurer</span><span class="token punctuation">&gt;</span></span> configurers <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token annotation punctuation">@PostConstruct</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AuthorizationServerConfigurer</span> configurer <span class="token operator">:</span> configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将自定义配置应用到授权服务器</span>
        configurer<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot configure enpdoints&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    endpoints<span class="token punctuation">.</span><span class="token function">setClientDetailsService</span><span class="token punctuation">(</span>clientDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 配置 /oauth/authorize 接口
   */</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">AuthorizationEndpoint</span> <span class="token function">authorizationEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 声明 /oauth/authorize GET 和 POST 请求</span>
    <span class="token class-name">AuthorizationEndpoint</span> authorizationEndpoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizationEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取自定义授权端点配置的 URL 映射</span>
    <span class="token class-name">FrameworkEndpointHandlerMapping</span> mapping <span class="token operator">=</span> <span class="token function">getEndpointsConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFrameworkEndpointHandlerMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 默认授权确认页面为 /oauth/confirm_access，允许自定义</span>
    authorizationEndpoint<span class="token punctuation">.</span><span class="token function">setUserApprovalPage</span><span class="token punctuation">(</span><span class="token function">extractPath</span><span class="token punctuation">(</span>mapping<span class="token punctuation">,</span> <span class="token string">&quot;/oauth/confirm_access&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    authorizationEndpoint<span class="token punctuation">.</span><span class="token function">setProviderExceptionHandler</span><span class="token punctuation">(</span><span class="token function">exceptionTranslator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 默认授权失败页面为 /oauth/error，允许自定义</span>
    authorizationEndpoint<span class="token punctuation">.</span><span class="token function">setErrorPage</span><span class="token punctuation">(</span><span class="token function">extractPath</span><span class="token punctuation">(</span>mapping<span class="token punctuation">,</span> <span class="token string">&quot;/oauth/error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 配置访问令牌授权器，访问令牌默认存储在内存中，允许多种授权方式</span>
    authorizationEndpoint<span class="token punctuation">.</span><span class="token function">setTokenGranter</span><span class="token punctuation">(</span><span class="token function">tokenGranter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    authorizationEndpoint<span class="token punctuation">.</span><span class="token function">setClientDetailsService</span><span class="token punctuation">(</span>clientDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    authorizationEndpoint<span class="token punctuation">.</span><span class="token function">setAuthorizationCodeServices</span><span class="token punctuation">(</span><span class="token function">authorizationCodeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    authorizationEndpoint<span class="token punctuation">.</span><span class="token function">setOAuth2RequestFactory</span><span class="token punctuation">(</span><span class="token function">oauth2RequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    authorizationEndpoint<span class="token punctuation">.</span><span class="token function">setOAuth2RequestValidator</span><span class="token punctuation">(</span><span class="token function">oauth2RequestValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 授权确认策略，允许配置为自动确认和跳转确认等多种方式</span>
    authorizationEndpoint<span class="token punctuation">.</span><span class="token function">setUserApprovalHandler</span><span class="token punctuation">(</span><span class="token function">userApprovalHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 跳转处理器，验证允许跳转的授权方式，验证跳转路径是否注册</span>
    authorizationEndpoint<span class="token punctuation">.</span><span class="token function">setRedirectResolver</span><span class="token punctuation">(</span><span class="token function">redirectResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> authorizationEndpoint<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 配置 /oauth/token 接口
   */</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">TokenEndpoint</span> <span class="token function">tokenEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 声明 /oauth/token GET 和 POST 请求</span>
    <span class="token class-name">TokenEndpoint</span> tokenEndpoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tokenEndpoint<span class="token punctuation">.</span><span class="token function">setClientDetailsService</span><span class="token punctuation">(</span>clientDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tokenEndpoint<span class="token punctuation">.</span><span class="token function">setProviderExceptionHandler</span><span class="token punctuation">(</span><span class="token function">exceptionTranslator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 配置访问令牌授权器</span>
    tokenEndpoint<span class="token punctuation">.</span><span class="token function">setTokenGranter</span><span class="token punctuation">(</span><span class="token function">tokenGranter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tokenEndpoint<span class="token punctuation">.</span><span class="token function">setOAuth2RequestFactory</span><span class="token punctuation">(</span><span class="token function">oauth2RequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tokenEndpoint<span class="token punctuation">.</span><span class="token function">setOAuth2RequestValidator</span><span class="token punctuation">(</span><span class="token function">oauth2RequestValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 配置 /oauth/token 接口允许的请求方法，默认只允许 POST 方法</span>
    tokenEndpoint<span class="token punctuation">.</span><span class="token function">setAllowedRequestMethods</span><span class="token punctuation">(</span><span class="token function">allowedTokenEndpointRequestMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> tokenEndpoint<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 配置 /oauth/check_token 接口
   */</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">CheckTokenEndpoint</span> <span class="token function">checkTokenEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 校验 token 是否有效并返回相关信息</span>
    <span class="token class-name">CheckTokenEndpoint</span> endpoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CheckTokenEndpoint</span><span class="token punctuation">(</span><span class="token function">getEndpointsConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceServerTokenServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    endpoint<span class="token punctuation">.</span><span class="token function">setAccessTokenConverter</span><span class="token punctuation">(</span><span class="token function">getEndpointsConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    endpoint<span class="token punctuation">.</span><span class="token function">setExceptionTranslator</span><span class="token punctuation">(</span><span class="token function">exceptionTranslator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> endpoint<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 配置授权确认页面，可以自定义覆盖
   */</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">WhitelabelApprovalEndpoint</span> <span class="token function">whitelabelApprovalEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WhitelabelApprovalEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 配置授权错误页面，可以自定义覆盖
   */</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">WhitelabelErrorEndpoint</span> <span class="token function">whitelabelErrorEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WhitelabelErrorEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>

<span class="token punctuation">}</span>
</code></pre></div><p><code>Spring OAuth2</code> 为这些端点配置了 <code>@FrameworkEndpoint</code> 注解，通过此注解，端点的 <code>URL</code> 即其映射方法会被 <code>Spring MVC</code> 读取到，使得各个端点可以像其它 <code>REST</code> 接口一样提供服务。</p> <h4 id="授权服务器安全配置"><a href="#授权服务器安全配置" class="header-anchor">#</a> 授权服务器安全配置</h4> <p><code>AuthorizationServerSecurityConfiguration</code> 继承了 <code>WebSecurityConfigurerAdapter</code>，<code>Spring Security</code> 允许在容器中配置多个 <code>WebSecurityConfigurerAdapter</code> 实例，不同实例分别构造成为 <code>SecurityFilterChain</code>，多个过滤器链交由 <code>FilterChainProxy</code> 进行代理，当接受到请求后，<code>Proxy</code> 会根据请求路径匹配相应的过滤器链：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFilters</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据请求路径匹配过滤器链</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityFilterChain</span> chain <span class="token operator">:</span> filterChains<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">getFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>来看看 <code>AuthorizationServerSecurityConfiguration</code> 的实现：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token comment">// 优先级高</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">ClientDetailsServiceConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">AuthorizationServerEndpointsConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationServerSecurityConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

  <span class="token comment">/**
   * 自定义授权服务器配置
   */</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthorizationServerConfigurer</span><span class="token punctuation">&gt;</span></span> configurers <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 第三方客户端认证配置
   */</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">ClientDetailsService</span> clientDetailsService<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 授权端点配置
   */</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">AuthorizationServerEndpointsConfiguration</span> endpoints<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clientDetails<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AuthorizationServerConfigurer</span> configurer <span class="token operator">:</span> configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 干预第三方客户端认证配置</span>
      configurer<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>clientDetails<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// Over-riding to make sure this.disableLocalConfigureAuthenticationBldr = false</span>
    <span class="token comment">// 默认使用 UserDetailsService 的实现类生成认证过滤器，而本套过滤器链是面向第三方应用认证而不是用户认证，所以不需要初始化 AuthenticationManager</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 过滤器配置
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 授权服务器安全配置扩展</span>
    <span class="token class-name">AuthorizationServerSecurityConfigurer</span> configurer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizationServerSecurityConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 自定义授权确认、授权失败页面路径映射</span>
    <span class="token class-name">FrameworkEndpointHandlerMapping</span> handlerMapping <span class="token operator">=</span> endpoints<span class="token punctuation">.</span><span class="token function">oauth2EndpointHandlerMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    http<span class="token punctuation">.</span><span class="token function">setSharedObject</span><span class="token punctuation">(</span><span class="token class-name">FrameworkEndpointHandlerMapping</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> handlerMapping<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 加载自定义授权服务器安全配置扩展</span>
    <span class="token function">configure</span><span class="token punctuation">(</span>configurer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    http<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>configurer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> tokenEndpointPath <span class="token operator">=</span> handlerMapping<span class="token punctuation">.</span><span class="token function">getServletPath</span><span class="token punctuation">(</span><span class="token string">&quot;/oauth/token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> tokenKeyPath <span class="token operator">=</span> handlerMapping<span class="token punctuation">.</span><span class="token function">getServletPath</span><span class="token punctuation">(</span><span class="token string">&quot;/oauth/token_key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> checkTokenPath <span class="token operator">=</span> handlerMapping<span class="token punctuation">.</span><span class="token function">getServletPath</span><span class="token punctuation">(</span><span class="token string">&quot;/oauth/check_token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>endpoints<span class="token punctuation">.</span><span class="token function">getEndpointsConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isUserDetailsServiceOverride</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 从自定义配置和容器中取得配置的 AuthenticationManager，用于刷新 token</span>
      <span class="token class-name">UserDetailsService</span> userDetailsService <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">UserDetailsService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      endpoints<span class="token punctuation">.</span><span class="token function">getEndpointsConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    http
      <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 访问 /oauth/token 接口需要完全认证</span>
      <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span>tokenEndpointPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fullyAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 配置访问 /oauth/token_key 和 /oauth/check_token 接口的权限</span>
      <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span>tokenKeyPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>configurer<span class="token punctuation">.</span><span class="token function">getTokenKeyAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span>checkTokenPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>configurer<span class="token punctuation">.</span><span class="token function">getCheckTokenAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">requestMatchers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span>tokenEndpointPath<span class="token punctuation">,</span> tokenKeyPath<span class="token punctuation">,</span> checkTokenPath<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span>NEVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    http<span class="token punctuation">.</span><span class="token function">setSharedObject</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> clientDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerSecurityConfigurer</span> oauthServer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AuthorizationServerConfigurer</span> configurer <span class="token operator">:</span> configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 应用自定义授权服务器安全配置扩展</span>
      configurer<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>oauthServer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="授权服务器配置扩展"><a href="#授权服务器配置扩展" class="header-anchor">#</a> 授权服务器配置扩展</h3> <h4 id="默认扩展"><a href="#默认扩展" class="header-anchor">#</a> 默认扩展</h4> <p>在授权端点配置和授权服务器安全配置中，都注入了 <code>AuthorizationServerConfigurer</code> 接口的实现，<code>spring-security-oauth2-autoconfigure</code> 对此接口中的 3 个 <code>configure</code> 方法的实现如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">/**
    * 第三方应用认证配置
    */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据配置初始化第三方认证信息，放入内存</span>
    <span class="token class-name">ClientDetailsServiceBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InMemoryClientDetailsServiceBuilder</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token class-name">ClientBuilder</span> builder <span class="token operator">=</span> clients
      <span class="token punctuation">.</span><span class="token function">inMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withClient</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>details<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">secret</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>details<span class="token punctuation">.</span><span class="token function">getClientSecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// 配置 token 有效时间，默认12小时</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>details<span class="token punctuation">.</span><span class="token function">getAccessTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      builder<span class="token punctuation">.</span><span class="token function">accessTokenValiditySeconds</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>details<span class="token punctuation">.</span><span class="token function">getAccessTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 配置刷新令牌有效时间，默认30天</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>details<span class="token punctuation">.</span><span class="token function">getRefreshTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      builder<span class="token punctuation">.</span><span class="token function">refreshTokenValiditySeconds</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>details<span class="token punctuation">.</span><span class="token function">getRefreshTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 配置运行跳转的 URL</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>details<span class="token punctuation">.</span><span class="token function">getRegisteredRedirectUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      builder<span class="token punctuation">.</span><span class="token function">redirectUris</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>details<span class="token punctuation">.</span><span class="token function">getRegisteredRedirectUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
    * 授权端点自定义配置
    */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tokenConverter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 配置 /oauth/check_token 接口验证验证成功返回 token 信息逻辑</span>
      endpoints<span class="token punctuation">.</span><span class="token function">accessTokenConverter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tokenConverter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tokenStore <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 配置 token 存储策略，默认在内存中</span>
      endpoints<span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tokenStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>details<span class="token punctuation">.</span><span class="token function">getAuthorizedGrantTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 配置用户认证管理器，用于密码模式中对用户身份进行认证</span>
      endpoints<span class="token punctuation">.</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
    * 配置授权安全策略
    */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerSecurityConfigurer</span> security<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    security<span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token class-name">NoOpPasswordEncoder</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getCheckTokenAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 配置 /oauth/check_token 接口访问权限</span>
      security<span class="token punctuation">.</span><span class="token function">checkTokenAccess</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getCheckTokenAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getTokenKeyAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 配置 /oauth/token_key 接口访问权限</span>
      security<span class="token punctuation">.</span><span class="token function">tokenKeyAccess</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getTokenKeyAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 配置 realm 名称，默认为 realm</span>
      security<span class="token punctuation">.</span><span class="token function">realm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="oauth2-授权"><a href="#oauth2-授权" class="header-anchor">#</a> OAuth2 授权</h2> <h3 id="授权码授权"><a href="#授权码授权" class="header-anchor">#</a> 授权码授权</h3> <h4 id="获取授权码"><a href="#获取授权码" class="header-anchor">#</a> 获取授权码</h4> <p><code>Spring OAuth2</code> 装配了 <code>AuthorizationEndpoint</code> 用于实现授权码模式中的 <code>/authroize</code> 接口。在启动项目分析这个接口的实现之前，我们需要增加一个默认的 <code>WebSecurityConfigurerAdapter</code> 实现：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAuthorizationServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuth2SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在第一章的分析中，我们说到如果 <code>Spring</code> 容器中有 <code>WebSecurityConfigurerAdapter</code> 的实例，那么默认的实例将不会被装配。引入 <code>OAuth2</code> 相关依赖后，自动配置的 <code>AuthorizationServerSecurityConfiguration</code> 就是一个 <code>WebSecurityConfigurerAdapter</code> 实例，而其中并没有对 <code>/authorize</code> 接口做保护（匹配不到过滤器链，会直接访问），而此接口中需要用户的认证信息，所以我们需要另外添加 <code>WebSecurityConfigurerAdapter</code> 实现，用于配置 <code>/authorize</code> 接口需要认证后才能访问。</p> <p>添加此配置后启动应用，在浏览器中访问：</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:8080/oauth/authorize?response_type=code&amp;client_id=wch&amp;state=xyz&amp;scope=all&amp;redirect_uri=http://localhost:8080
</code></pre></div><p>传参为 <code>OAuth2</code> 标准获取授权码的标准参数：</p> <ul><li><code>response_type</code> ：传固定值 <code>code</code> 表示使用授权码模式申请授权。</li> <li><code>client_id</code>：第三方应用认证账号。</li> <li><code>state</code>：用于保持请求和回调的状态，会照原样回传此参数。</li> <li><code>scope</code>：申请 <code>scope</code> 权限。</li> <li><code>redirect_uri</code>：授权回调地址。</li></ul> <p>来看看 <code>GET /authorize</code> 接口：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/oauth/authorize&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">authorize</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> model<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> parameters<span class="token punctuation">,</span> <span class="token class-name">SessionStatus</span> sessionStatus<span class="token punctuation">,</span> <span class="token class-name">Principal</span> principal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 提取请求参数，生成 AuthorizationRequest</span>
    <span class="token class-name">AuthorizationRequest</span> authorizationRequest <span class="token operator">=</span> <span class="token function">getOAuth2RequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createAuthorizationRequest</span><span class="token punctuation">(</span>parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 授权类型</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> responseTypes <span class="token operator">=</span> authorizationRequest<span class="token punctuation">.</span><span class="token function">getResponseTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 验证用户是否已认证</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>principal <span class="token keyword">instanceof</span> <span class="token class-name">Authentication</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span><span class="token punctuation">)</span> principal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InsufficientAuthenticationException</span><span class="token punctuation">(</span><span class="token string">&quot;User must be authenticated with Spring Security before authorization can be completed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 查询第三方应用信息</span>
      <span class="token class-name">ClientDetails</span> client <span class="token operator">=</span> <span class="token function">getClientDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadClientByClientId</span><span class="token punctuation">(</span>authorizationRequest<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ...</span>
      <span class="token comment">// 配置回调地址</span>
      authorizationRequest<span class="token punctuation">.</span><span class="token function">setRedirectUri</span><span class="token punctuation">(</span>resolvedRedirect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 验证参数中的 scope 是否有效</span>
      oauth2RequestValidator<span class="token punctuation">.</span><span class="token function">validateScope</span><span class="token punctuation">(</span>authorizationRequest<span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 验证请求授权的 scope 是否默认确认授权。userApprovalHandler 可配置，默认为所有请求的 scope 自动确认授权方可直接授权</span>
      authorizationRequest <span class="token operator">=</span> userApprovalHandler<span class="token punctuation">.</span><span class="token function">checkForPreApproval</span><span class="token punctuation">(</span>authorizationRequest<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Authentication</span><span class="token punctuation">)</span> principal<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ...</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>authorizationRequest<span class="token punctuation">.</span><span class="token function">isApproved</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果默认确认授权</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>responseTypes<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 隐式授权模式直接返回访问令牌</span>
          <span class="token keyword">return</span> <span class="token function">getImplicitGrantResponse</span><span class="token punctuation">(</span>authorizationRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>responseTypes<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 授权码模式直接返回授权码</span>
          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token function">getAuthorizationCodeResponse</span><span class="token punctuation">(</span>authorizationRequest<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Authentication</span><span class="token punctuation">)</span> principal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 如果没有自动授权，跳转到 /oauth/confirm_access 进行确认授权</span>
      model<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;authorizationRequest&quot;</span><span class="token punctuation">,</span> authorizationRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">getUserApprovalPageResponse</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> authorizationRequest<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Authentication</span><span class="token punctuation">)</span> principal<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>

  <span class="token punctuation">}</span>
</code></pre></div><p>如果没用配置自动确认， <code>GET /authorize</code> 接口并不会直接返回授权码，而是会跳转到 <code>/oauth/confirm_access</code> 页面进行二次授权确认。端点配置中配置了 <code>WhitelabelApprovalEndpoint</code> 用于生成默认的二次确认页面，此页面中有一个表单，将用户的确认结果发往 <code>POST /oauth/authorize</code> 接口，在此接口中的验证逻辑中，如果用户进行了确认授权，则会在跳转地址中携带授权码。</p> <h4 id="换取访问令牌"><a href="#换取访问令牌" class="header-anchor">#</a> 换取访问令牌</h4> <p>拥有授权码即可访问 <code>OAuth2</code> 标准中获取访问令牌的接口 <code>POST /token</code>：</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:8080/oauth/token?grant_type=authorization_code&amp;code=E2voni&amp;scope=all&amp;redirect_uri=http://localhost:8080
</code></pre></div><p>传参为 <code>OAuth2</code> 标准获取访问令牌的标准参数：</p> <ul><li><code>grant_type</code>：为固定值 <code>authorization_code</code>。</li> <li><code>code</code>：获取的授权码。</li> <li><code>scope</code>：申请的 <code>scope</code> 。</li> <li><code>redirect_uri</code> ：需传入获取授权码使用的跳转路径用于验证。</li></ul> <p><code>AuthorizationServerSecurityConfiguration</code> 在配置过滤器时指定 <code>/oauth/token</code> 需要进行 <code>fullyAuthenticated</code> 认证后才能访问，但是用于认证的并不是注入到 <code>Spring</code> 容器中的 <code>UserDetailsService</code> 实现，而是上文提到的配置懒加载的 <code>ClientDetailsService</code> ，<code>AuthorizationServerSecurityConfigurer#init</code> 配置如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>passwordEncoder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 有密码的配置</span>
      <span class="token comment">// ...</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 无密码的配置</span>
      <span class="token comment">// 配置认证服务为第三方认证服务</span>
      http<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientDetailsUserDetailsService</span><span class="token punctuation">(</span><span class="token function">clientDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 配置不对 SecurityContext 进行存储和读取</span>
    http<span class="token punctuation">.</span><span class="token function">securityContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">securityContextRepository</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NullSecurityContextRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 配置 http basic 认证</span>
      <span class="token punctuation">.</span><span class="token function">httpBasic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">realmName</span><span class="token punctuation">(</span>realm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>因此，访问 <code>/token</code> 请求还需要加上用于第三方认证的 <code>header</code>：</p> <div class="language-htm extra-class"><pre class="language-text"><code>Authorization: Basic d2NoOndjaA==
</code></pre></div><p><code>Basic</code> 后的编码为配置的 <code>clien_id:client_secret</code> 的 <code>Base64</code> 编码。</p> <p><code>DefaultTokenServices#createAccessToken</code> 方法为生成访问令牌的逻辑，其传入参数为不同授权方式生成的 <code>OAuth2Authentication</code> 认证对象。授权码模式获是根据授权码获取存储在 <code>authorizationCodeStore</code> 中的认证对象的。随后在 <code>DefaultTokenServices#createAccessToken</code> 方法中创建真正的访问令牌，并以 <code>Json</code> 的形式返回：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;access_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;9d77b23b-b397-4e73-bf01-291ef474862f&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;token_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bearer&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;refresh_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;c38cea17-28c8-43af-ab11-fcacc90c6ef7&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;expires_in&quot;</span><span class="token operator">:</span> <span class="token number">43199</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token string">&quot;all&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="隐式授权"><a href="#隐式授权" class="header-anchor">#</a> 隐式授权</h3> <p>隐式授权相对于授权码模式省略了使用授权码换取访问令牌的过程，直接通过浏览器访问 <code>/authroize</code> 即可获得访问令牌：</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:8080/oauth/authorize?response_type=token&amp;client_id=wch&amp;state=xyz&amp;scope=all&amp;redirect_uri=http://localhost:8080
</code></pre></div><p>传参为 <code>OAuth2</code> 标准获取访问令牌的标准参数：</p> <ul><li><code>response_type</code>：为固定值 <code>token</code>。</li> <li><code>client_id</code>：第三方应用认证账号。</li> <li><code>state</code>：用于保持请求和回调的状态，会照原样回传此参数。</li> <li><code>scope</code>：申请 <code>scope</code> 权限。</li> <li><code>redirect_uri</code> ：需传入获取授权码使用的跳转路径用于验证。</li></ul> <p>在用户认证成功后，路径参数中会包含访问令牌：</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:8080/#access_token=9d77b23b-b397-4e73-bf01-291ef474862f&amp;token_type=bearer&amp;state=xyz&amp;expires_in=40375
</code></pre></div><h3 id="密码授权"><a href="#密码授权" class="header-anchor">#</a> 密码授权</h3> <p>密码授权要求将资源所有者的认证信息提交给 <code>/token</code> 接口，访问令牌在认证成功后以 <code>Json</code> 的形式颁发给第三方客户端，请求参数如下：</p> <div class="language- extra-class"><pre class="language-text"><code>POST http://localhost:8080/oauth/token?grant_type=password&amp;username=user&amp;password=123&amp;scope=all
</code></pre></div><p>密码模式同样需要加上第三方应用认证信息的 <code>header</code>。</p> <p>传参为 <code>OAuth2</code> 标准获取访问令牌的标准参数：</p> <ul><li><code>grant_type</code>：为固定值 <code>password</code>。</li> <li><code>username</code>：资源所有者认证账号。</li> <li><code>password</code>：资源所有者认证密码。</li> <li><code>scope</code>：申请 <code>scope</code> 权限。</li></ul> <p>密码授权模式获取 <code>OAuth2</code> 认证信息的逻辑在 <code>ResourceOwnerPasswordTokenGranter#getOAuth2Authentication</code> 方法中：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">// 从请求参数中读取账户密码</span>
  <span class="token class-name">String</span> username <span class="token operator">=</span> parameters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> password <span class="token operator">=</span> parameters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>

  <span class="token class-name">Authentication</span> userAuth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对用户信息进行认证</span>
    userAuth <span class="token operator">=</span> authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>userAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
</code></pre></div><p>可以看到用于认证用户信息的是一个 <code>AuthenticationManager</code> 实例。在第一章中曾说道，<code>Spring Security</code> 会配置 <code>AuthenticationConfiguration</code> 到 <code>Spring</code> 容器中，此配置会加载 <code>UserDetailsService</code> ，并最终组装成为 <code>AuthenticationManager</code>。而 <code>OAuth2AuthorizationServerConfiguration</code> 在构造函数中将 <code>AuthenticationConfiguration</code> 注入，并将生成的认证管理器加载到授权端点配置中。在配置默认的 <code>tokenGranter</code> 时，传入认证管理器。比较特殊的是之前介绍的认证过程都是在过滤器链中完成的，而密码模式则在生成访问令牌的过程中对用户身份进行认证。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TokenGranter</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDefaultTokenGranters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>authenticationManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 传入用户认证管理器，密码模式有了校验用户身份的能力</span>
      tokenGranters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceOwnerPasswordTokenGranter</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">,</span> tokenServices<span class="token punctuation">,</span> clientDetails<span class="token punctuation">,</span> requestFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> tokenGranters<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="第三方应用凭证授权"><a href="#第三方应用凭证授权" class="header-anchor">#</a> 第三方应用凭证授权</h3> <p>第三方应用凭证授权仅需要验证第三方应用自身的信息，访问 <code>/token</code> 接口的参数如下：</p> <div class="language- extra-class"><pre class="language-text"><code>POST http://localhost:8080/oauth/token?grant_type=client_credentials&amp;scope=all
</code></pre></div><p>传参为 <code>OAuth2</code> 标准获取访问令牌的标准参数：</p> <ul><li><code>grant_type</code>：为固定值 <code>client_credentials</code>。</li> <li><code>scope</code>：申请 <code>scope</code> 权限。</li></ul> <p>第三方应用凭证授权同样需要加上第三方应用认证信息的 <code>header</code>。此种授权方式是无法区分不同用户权限的。</p> <h3 id="刷新令牌"><a href="#刷新令牌" class="header-anchor">#</a> 刷新令牌</h3> <p>出于安全方面的考虑，用于获取资源的访问令牌设置的失效时间比较短，在授权服务器颁发访问令牌的同时，还会携带一个 <code>refresh_token</code>。当用户使用过期的访问令牌访问资源服务器，会收到一个 <code>401</code> 响应，随后第三方应用可以携带被颁发的刷新令牌重新向授权服务器申请访问令牌，其流程如下：</p> <div class="language- extra-class"><pre class="language-text"><code>+--------+                                           +---------------+
|        |--(A)------- Authorization Grant ---------&gt;|               |
|        |                                           |               |
|        |&lt;-(B)----------- Access Token -------------|               |
|        |               &amp; Refresh Token             |               |
|        |                                           |               |
|        |                            +----------+   |               |
|        |--(C)---- Access Token ----&gt;|          |   |               |
|        |                            |          |   |               |
|        |&lt;-(D)- Protected Resource --| Resource |   | Authorization |
| Client |                            |  Server  |   |     Server    |
|        |--(E)---- Access Token ----&gt;|          |   |               |
|        |                            |          |   |               |
|        |&lt;-(F)- Invalid Token Error -|          |   |               |
|        |                            +----------+   |               |
|        |                                           |               |
|        |--(G)----------- Refresh Token -----------&gt;|               |
|        |                                           |               |
|        |&lt;-(H)----------- Access Token -------------|               |
+--------+           &amp; Optional Refresh Token        +---------------+
</code></pre></div><p>上图所示流程包含以下步骤：</p> <ul><li>（A）第三方应用向授权服务器出示授权许可。</li> <li>（B）授权服务器验证第三方应用身份和授权许可，颁发访问令牌和刷新令牌。</li> <li>（C）第三方应用持有访问令牌向资源服务器请求受保护资源。</li> <li>（D）资源服务器验证访问令牌并返回受保护资源。</li> <li>（E）第三方应用重复（C）请求，直到访问令牌过期。</li> <li>（F）由于访问令牌已经过期，资源服务器返回无效令牌错误。</li> <li>（G）第三方应用向授权服务器出示刷新令牌。</li> <li>（H）授权服务器验证用户身份后颁发一个新的访问令牌。</li></ul> <p>在 <code>Spring Security</code> 的实现中，<code>TokenStore</code> 中维护了 <code>refresh_token</code> 与用户认证信息的映射，当授权服务器收到类型为 <code>refresh_token</code> 的授权请求时，会取出对应的用户认证信息，重新使用用户认证管理器进行认证。如果认证成功则会颁发新的访问令牌和刷新令牌。如果刷新令牌也是过期的，同样会刷新失败，<code>DefaultTokenServices#refreshAccessToken</code> 方法对刷新令牌的实现逻辑如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>noRollbackFor<span class="token operator">=</span><span class="token punctuation">{</span><span class="token class-name">InvalidTokenException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">InvalidGrantException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">OAuth2AccessToken</span> <span class="token function">refreshAccessToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> refreshTokenValue<span class="token punctuation">,</span> <span class="token class-name">TokenRequest</span> tokenRequest<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// 查询存储的 refresh_token</span>
    <span class="token class-name">OAuth2RefreshToken</span> refreshToken <span class="token operator">=</span> tokenStore<span class="token punctuation">.</span><span class="token function">readRefreshToken</span><span class="token punctuation">(</span>refreshTokenValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ..</span>
    <span class="token comment">// 获取刷新令牌对应的用户认证信息</span>
    <span class="token class-name">OAuth2Authentication</span> authentication <span class="token operator">=</span> tokenStore<span class="token punctuation">.</span><span class="token function">readAuthenticationForRefreshToken</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>authentication<span class="token punctuation">.</span><span class="token function">isClientOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 进行用户认证</span>
      <span class="token class-name">Authentication</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PreAuthenticatedAuthenticationToken</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getUserAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> authentication<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      user <span class="token operator">=</span> authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Object</span> details <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      authentication <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OAuth2Authentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getOAuth2Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
      authentication<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span>details<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExpired</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果刷新令牌过期，授权失败</span>
      tokenStore<span class="token punctuation">.</span><span class="token function">removeRefreshToken</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidTokenException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid refresh token (expired): &quot;</span> <span class="token operator">+</span> refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 重新创建用户认证信息</span>
    authentication <span class="token operator">=</span> <span class="token function">createRefreshedAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span> tokenRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reuseRefreshToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 是否重用 refresh_token</span>
      tokenStore<span class="token punctuation">.</span><span class="token function">removeRefreshToken</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
      refreshToken <span class="token operator">=</span> <span class="token function">createRefreshToken</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 重新创建访问令牌</span>
    <span class="token class-name">OAuth2AccessToken</span> accessToken <span class="token operator">=</span> <span class="token function">createAccessToken</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span> refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tokenStore<span class="token punctuation">.</span><span class="token function">storeAccessToken</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reuseRefreshToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tokenStore<span class="token punctuation">.</span><span class="token function">storeRefreshToken</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">.</span><span class="token function">getRefreshToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> accessToken<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>对用户重新认证的逻辑需要传入用户认证管理器 <code>authenticationManager</code>，通过自定义授权端点时，通过 <code>AuthorizationServerEndpointsConfiguration#userDetailsService</code> 方法配置用户认证服务。</p> <p>刷新令牌访问 <code>/token</code> 接口的参数如下：</p> <div class="language- extra-class"><pre class="language-text"><code>POST http://localhost:8080/oauth/token?grant_type=refresh_token&amp;refresh_token=95ba5fd8-1b9e-4142-81fa-b41cdc27a769&amp;scope=all
</code></pre></div><p>传参为 <code>OAuth2</code> 标准获取访问令牌的标准参数：</p> <ul><li><code>grant_type</code>：为固定值 <code>refresh_token</code>。</li> <li><code>refresh_token</code>：刷新令牌值。</li> <li><code>refresh_token</code>：申请的 <code>scope</code> 权限。</li></ul> <h2 id="访问资源服务器"><a href="#访问资源服务器" class="header-anchor">#</a> 访问资源服务器</h2> <p>启动资源服务器需要配置 <code>@EnableResourceServer</code> 注解，此注解引入了 <code>ResourceServerConfiguration</code>，这是一个 <code>WebSecurityConfigurerAdapter</code> 实例，其重载了配置过滤器的配置方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 资源服务器保护配置</span>
    <span class="token class-name">ResourceServerSecurityConfigurer</span> resources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceServerSecurityConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ResourceServerTokenServices</span> services <span class="token operator">=</span> <span class="token function">resolveTokenServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>services <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resources<span class="token punctuation">.</span><span class="token function">tokenServices</span><span class="token punctuation">(</span>services<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tokenStore <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resources<span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span>tokenStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>endpoints <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Spring 容器中有授权端点实例，说明资源服务器和授权服务器在同一实例中，则使用相同的 TokenStore</span>
        resources<span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">.</span><span class="token function">getEndpointsConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventPublisher <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resources<span class="token punctuation">.</span><span class="token function">eventPublisher</span><span class="token punctuation">(</span>eventPublisher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ResourceServerConfigurer</span> configurer <span class="token operator">:</span> configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 自定义资源保护配置</span>
      configurer<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    http<span class="token punctuation">.</span><span class="token function">authenticationProvider</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnonymousAuthenticationProvider</span><span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">accessDeniedHandler</span><span class="token punctuation">(</span>resources<span class="token punctuation">.</span><span class="token function">getAccessDeniedHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span>STATELESS<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    http<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>endpoints <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 授权端点中的路径排除在外，不受资源服务器保护</span>
      http<span class="token punctuation">.</span><span class="token function">requestMatcher</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NotOAuthRequestMatcher</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">.</span><span class="token function">oauth2EndpointHandlerMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ResourceServerConfigurer</span> configurer <span class="token operator">:</span> configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 自定义过滤器配置</span>
      configurer<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>configurers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 默认在没有自定义配置的情况下访问所有路径都需要权限</span>
      http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>此配置中引人了 <code>ResourceServerSecurityConfigurer</code> 用于配置 <code>OAuth2</code> 资源服务器认证过滤器 <code>OAuth2AuthenticationProcessingFilter</code>，其过滤逻辑如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 读取 Authorization 头，取出 Bearer 的值，即访问令牌</span>
      <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> tokenExtractor<span class="token punctuation">.</span><span class="token function">extract</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>authentication <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>

        <span class="token comment">// 认证逻辑为验证 TokenStore 中的访问令牌</span>
        <span class="token class-name">Authentication</span> authResult <span class="token operator">=</span> authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>

        <span class="token comment">// 认证信息存入 SecurityContext</span>
        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>

    chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>通过实现 <code>ResourceServerConfigurer</code> 接口并注入 <code>Spring</code> 容器，可以实现对资源服务器保护服务的干预。 <code>OAuth2AutoConfiguration</code> 中引入了 <code>OAuth2ResourceServerConfiguration</code> 配置，是对 <code>ResourceServerConfigurer</code> 的默认实现，其配置了所有请求都需要经过认证。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <ul><li><code>OAuth2</code> 是一个通用的 <code>web</code> 安全标准，<code>Spring Security</code> 对 <code>OAuth2</code> 有一系列开箱即用的实现。</li> <li><code>OAuth2</code> 标准提供了 4 种授权（颁发访问令牌）和 1 种刷新令牌的方式。</li> <li>资源服务器通过解析 <code>Authorization</code> 头获取访问令牌，对访问令牌进行验证判断是否运行访问受保护资源。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/posts/security/SpringSecurity源码分析（三）：授权管理.html" class="prev">Spring Security 源码分析（三）：授权管理</a></span> <span class="next"><a href="/posts/security/SpringSecurity源码分析（五）：JWT实现.html">Spring Security 源码分析（五）：JWT实现</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.15a66b26.js" defer></script><script src="/assets/js/2.92cd0f37.js" defer></script><script src="/assets/js/43.7035de8a.js" defer></script>
  </body>
</html>

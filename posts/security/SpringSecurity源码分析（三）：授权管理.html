<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Security 源码分析（三）：授权管理 | wch的个人主页</title>
    <meta name="description" content="用于分享wch的学习笔记和项目~">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.74c45c5d.css" as="style"><link rel="preload" href="/assets/js/app.15a66b26.js" as="script"><link rel="preload" href="/assets/js/2.92cd0f37.js" as="script"><link rel="preload" href="/assets/js/40.3751cd34.js" as="script"><link rel="prefetch" href="/assets/js/10.1166f652.js"><link rel="prefetch" href="/assets/js/11.b6ae0b14.js"><link rel="prefetch" href="/assets/js/12.7802c7ba.js"><link rel="prefetch" href="/assets/js/13.63066938.js"><link rel="prefetch" href="/assets/js/14.1f9fa0d5.js"><link rel="prefetch" href="/assets/js/15.6c758eca.js"><link rel="prefetch" href="/assets/js/16.58440a84.js"><link rel="prefetch" href="/assets/js/17.1e1f5c53.js"><link rel="prefetch" href="/assets/js/18.28115609.js"><link rel="prefetch" href="/assets/js/19.7e395424.js"><link rel="prefetch" href="/assets/js/20.2c2ea5f8.js"><link rel="prefetch" href="/assets/js/21.1e8ef167.js"><link rel="prefetch" href="/assets/js/22.47a8f5b7.js"><link rel="prefetch" href="/assets/js/23.f507c548.js"><link rel="prefetch" href="/assets/js/24.b19f43b8.js"><link rel="prefetch" href="/assets/js/25.5b1882b0.js"><link rel="prefetch" href="/assets/js/26.16cf6f8a.js"><link rel="prefetch" href="/assets/js/27.6f3498d0.js"><link rel="prefetch" href="/assets/js/28.f56b7e3c.js"><link rel="prefetch" href="/assets/js/29.de1da78b.js"><link rel="prefetch" href="/assets/js/3.73d3287d.js"><link rel="prefetch" href="/assets/js/30.108b25a0.js"><link rel="prefetch" href="/assets/js/31.68af7d35.js"><link rel="prefetch" href="/assets/js/32.c9f05837.js"><link rel="prefetch" href="/assets/js/33.13bd6f64.js"><link rel="prefetch" href="/assets/js/34.59041fd7.js"><link rel="prefetch" href="/assets/js/35.4382a261.js"><link rel="prefetch" href="/assets/js/36.01d6324a.js"><link rel="prefetch" href="/assets/js/37.22e4179e.js"><link rel="prefetch" href="/assets/js/38.f553994e.js"><link rel="prefetch" href="/assets/js/39.a72bb5df.js"><link rel="prefetch" href="/assets/js/4.9a52aae5.js"><link rel="prefetch" href="/assets/js/41.d351ec5d.js"><link rel="prefetch" href="/assets/js/42.b87a3eae.js"><link rel="prefetch" href="/assets/js/43.7035de8a.js"><link rel="prefetch" href="/assets/js/44.2c18f0bc.js"><link rel="prefetch" href="/assets/js/45.52905280.js"><link rel="prefetch" href="/assets/js/46.abb047a4.js"><link rel="prefetch" href="/assets/js/47.2ac230d3.js"><link rel="prefetch" href="/assets/js/48.b63bb42b.js"><link rel="prefetch" href="/assets/js/49.35752ae9.js"><link rel="prefetch" href="/assets/js/5.36029518.js"><link rel="prefetch" href="/assets/js/50.b6bd912f.js"><link rel="prefetch" href="/assets/js/51.0e0db65f.js"><link rel="prefetch" href="/assets/js/52.d15fb17a.js"><link rel="prefetch" href="/assets/js/53.844345be.js"><link rel="prefetch" href="/assets/js/54.52685e8c.js"><link rel="prefetch" href="/assets/js/55.83a99fe0.js"><link rel="prefetch" href="/assets/js/56.fe26d3a3.js"><link rel="prefetch" href="/assets/js/57.dae36566.js"><link rel="prefetch" href="/assets/js/58.1bfd28b1.js"><link rel="prefetch" href="/assets/js/59.88f55364.js"><link rel="prefetch" href="/assets/js/6.d3b55a54.js"><link rel="prefetch" href="/assets/js/7.af0443ed.js"><link rel="prefetch" href="/assets/js/8.2c9a7ea2.js"><link rel="prefetch" href="/assets/js/9.c08dcf83.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74c45c5d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">wch的个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java虚拟机</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java并发编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis 源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Spring Security 源码分析</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/security/SpringSecurity源码分析（一）：过滤器链.html" class="sidebar-link">Spring Security 源码分析（一）：过滤器链</a></li><li><a href="/posts/security/SpringSecurity源码分析（二）：表单登录.html" class="sidebar-link">Spring Security 源码分析（二）：表单登录</a></li><li><a href="/posts/security/SpringSecurity源码分析（三）：授权管理.html" class="active sidebar-link">Spring Security 源码分析（三）：授权管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（三）：授权管理.html#url-访问权限配置" class="sidebar-link">URL 访问权限配置</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（三）：授权管理.html#载入权限配置" class="sidebar-link">载入权限配置</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（三）：授权管理.html#鉴权流程" class="sidebar-link">鉴权流程</a></li><li class="sidebar-sub-header"><a href="/posts/security/SpringSecurity源码分析（三）：授权管理.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html" class="sidebar-link">Spring Security 源码分析（四）：OAth2实现</a></li><li><a href="/posts/security/SpringSecurity源码分析（五）：JWT实现.html" class="sidebar-link">Spring Security 源码分析（五）：JWT实现</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微信小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Elasticsearch</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="spring-security-源码分析（三）：授权管理"><a href="#spring-security-源码分析（三）：授权管理" class="header-anchor">#</a> Spring Security 源码分析（三）：授权管理</h1> <h2 id="url-访问权限配置"><a href="#url-访问权限配置" class="header-anchor">#</a> URL 访问权限配置</h2> <p><code>Spring Security</code> 允许在过滤器配置中使用如下方式对特定 <code>URL</code> 做权限配置：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// /api1/** 需要 ROLE_ADMIN 角色才能访问</span>
      <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/api1/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">&quot;ADMIN&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">// /api2/** 需要 USER 权限才能访问</span>
      <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/api2/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasAuthority</span><span class="token punctuation">(</span><span class="token string">&quot;USER&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">// /api3/** 允许任何人访问</span>
      <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/api3/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 其它所有接口都需要认证后才能访问</span>
      <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>HttpSecurity#authorizeRequests</code> 方法引入了 <code>ExpressionUrlAuthorizationConfigurer</code> 配置了 <code>ExpressionInterceptUrlRegistry</code>，这是一个包含了多组 <code>RequestMatcher</code> 和不同访问权限的注册对象。<code>antMatchers</code> 方法生成指定路径匹配对象 <code>RequestMatcherConfigurer</code>，<code>hasRole</code> 、<code>hasAuthority</code> 等方法则根据配置的访问权限生成 <code>SpEL</code> 表达式，其最终目的是通过 <code>SpEL expressions</code> 来做权限控制：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token class-name">String</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 根据配置的角色添加了 ROLE_ 前缀</span>
  <span class="token keyword">return</span> <span class="token string">&quot;hasRole('ROLE_&quot;</span> <span class="token operator">+</span> role <span class="token operator">+</span> <span class="token string">&quot;')&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">hasAuthority</span><span class="token punctuation">(</span><span class="token class-name">String</span> authority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">&quot;hasAuthority('&quot;</span> <span class="token operator">+</span> authority <span class="token operator">+</span> <span class="token string">&quot;')&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这些配置的 <code>SpEL</code> 表达式最终通过 <code>interceptUrl</code> 方法与对应的路径匹配对象注册到 <code>REGISTRY</code> 中：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token class-name">ExpressionInterceptUrlRegistry</span> <span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token class-name">String</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token class-name">ExpressionUrlAuthorizationConfigurer</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">ExpressionInterceptUrlRegistry</span> <span class="token function">hasAnyRole</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> roles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token class-name">ExpressionUrlAuthorizationConfigurer</span><span class="token punctuation">.</span><span class="token function">hasAnyRole</span><span class="token punctuation">(</span>roles<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">ExpressionInterceptUrlRegistry</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token class-name">String</span> attribute<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>not<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      attribute <span class="token operator">=</span> <span class="token string">&quot;!&quot;</span> <span class="token operator">+</span> attribute<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">interceptUrl</span><span class="token punctuation">(</span>requestMatchers<span class="token punctuation">,</span> <span class="token class-name">SecurityConfig</span><span class="token punctuation">.</span><span class="token function">createList</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">ExpressionUrlAuthorizationConfigurer</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>REGISTRY<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">interceptUrl</span><span class="token punctuation">(</span><span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> requestMatchers<span class="token punctuation">,</span>
                            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> configAttributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> requestMatcher <span class="token operator">:</span> requestMatchers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 注册 路径匹配对象-访问权限 SpEL 表达式</span>
      REGISTRY<span class="token punctuation">.</span><span class="token function">addMapping</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AbstractConfigAttributeRequestMatcherRegistry</span><span class="token punctuation">.</span><span class="token class-name">UrlMapping</span><span class="token punctuation">(</span>
        requestMatcher<span class="token punctuation">,</span> configAttributes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="载入权限配置"><a href="#载入权限配置" class="header-anchor">#</a> 载入权限配置</h2> <p>在第一章中我们说到，通过调用 <code>HttpSecurity#authorizeRequests</code> 方法可以配置 <code>Spring Security</code> 最后的守门员 <code>FilterSecurityInterceptor</code>，这是过滤器链中的最后一个过滤器。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">// 获取访问权限配置</span>
  <span class="token class-name">FilterInvocationSecurityMetadataSource</span> metadataSource <span class="token operator">=</span> <span class="token function">createMetadataSource</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 使用访问权限配置创建 FilterSecurityInterceptor</span>
  <span class="token class-name">FilterSecurityInterceptor</span> securityInterceptor <span class="token operator">=</span> <span class="token function">createFilterSecurityInterceptor</span><span class="token punctuation">(</span>http<span class="token punctuation">,</span> metadataSource<span class="token punctuation">,</span> http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在创建 <code>FilterSecurityInterceptor</code> 时要求传入 <code>metadataSource</code>，而这就是上文中所说的 <code>REGISTRY</code> 相关配置：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">final</span> <span class="token class-name">ExpressionBasedFilterInvocationSecurityMetadataSource</span> <span class="token function">createMetadataSource</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取配置的 RequestMatcher 与 访问权限关系</span>
    <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> requestMap <span class="token operator">=</span> REGISTRY<span class="token punctuation">.</span><span class="token function">createRequestMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ExpressionBasedFilterInvocationSecurityMetadataSource</span><span class="token punctuation">(</span>requestMap<span class="token punctuation">,</span> <span class="token function">getExpressionHandler</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="鉴权流程"><a href="#鉴权流程" class="header-anchor">#</a> 鉴权流程</h2> <p>进入最后一个过滤器 <code>FilterSecurityInterceptor</code> 后，认证流程会调用 <code>AbstractSecurityInterceptor#beforeInvocation</code> 方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">protected</span> <span class="token class-name">InterceptorStatusToken</span> <span class="token function">beforeInvocation</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 根据当前的 request 对象获取对应的访问权限</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> attributes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">obtainSecurityMetadataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 决定是否允许访问</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>accessDecisionManager<span class="token punctuation">.</span><span class="token function">decide</span><span class="token punctuation">(</span>authenticated<span class="token punctuation">,</span> object<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>根据当前请求匹配到对应的访问权限后，使用 <code>AccessDecisionManager</code> 决定是否对当前请求放行，<code>AccessDecisionManager</code> 有三种实现：</p> <ul><li><code>AffirmativeBased</code>：任一个投票器通过即允许访问。</li> <li><code>ConsensusBased</code>：投票器通过半数即运行访问。</li> <li><code>UnanimousBased</code>：所有投票器通过才允许访问。</li></ul> <p>默认实现为 <code>AffirmativeBased</code>，投票器用来判定当前请求是否允许访问，默认实现为 <code>WebExpressionVoter</code> 这是一种根据 <code>SpEL</code> 表达式匹配来判断访问权限的投票器。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">decide</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> configAttributes<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AccessDeniedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> deny <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token comment">// 遍历所有投票器</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AccessDecisionVoter</span> voter <span class="token operator">:</span> <span class="token function">getDecisionVoters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 根据用户权限列表做 SpEL 比较</span>
      <span class="token keyword">int</span> result <span class="token operator">=</span> voter<span class="token punctuation">.</span><span class="token function">vote</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span> object<span class="token punctuation">,</span> configAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token class-name">AccessDecisionVoter</span><span class="token punctuation">.</span>ACCESS_GRANTED<span class="token operator">:</span>
          <span class="token comment">// 有一个允许通过则结束投票</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">AccessDecisionVoter</span><span class="token punctuation">.</span>ACCESS_DENIED<span class="token operator">:</span>
          <span class="token comment">// 不允许通过次数+1</span>
          deny<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
		<span class="token comment">// 投票不通过，抛出 AccessDeniedException</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>deny <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span>
        <span class="token string">&quot;AbstractAccessDecisionManager.accessDenied&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Access is denied&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>AffirmativeBased</code> 的投票逻辑如上，只要有一个投票器投票通过则投票结束，否则抛出 <code>AccessDeniedException</code> 异常。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <ul><li>在配置过滤器链时，结合使用 <code>antMatchers</code> 和权限配置访问可以对匹配 <code>URL</code> 做权限控制。</li> <li>通过比较用户认证信息的权限与请求的访问权限的 <code>SpEL</code> 表达式来最终确认是否可以访问。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/posts/security/SpringSecurity源码分析（二）：表单登录.html" class="prev">Spring Security 源码分析（二）：表单登录</a></span> <span class="next"><a href="/posts/security/SpringSecurity源码分析（四）：OAth2实现.html">Spring Security 源码分析（四）：OAth2实现</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.15a66b26.js" defer></script><script src="/assets/js/2.92cd0f37.js" defer></script><script src="/assets/js/40.3751cd34.js" defer></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>并发编程（三）：锁的优化 | wch的个人主页</title>
    <meta name="description" content="用于分享wch的学习笔记和项目~">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.74c45c5d.css" as="style"><link rel="preload" href="/assets/js/app.15a66b26.js" as="script"><link rel="preload" href="/assets/js/2.92cd0f37.js" as="script"><link rel="preload" href="/assets/js/9.c08dcf83.js" as="script"><link rel="prefetch" href="/assets/js/10.1166f652.js"><link rel="prefetch" href="/assets/js/11.b6ae0b14.js"><link rel="prefetch" href="/assets/js/12.7802c7ba.js"><link rel="prefetch" href="/assets/js/13.63066938.js"><link rel="prefetch" href="/assets/js/14.1f9fa0d5.js"><link rel="prefetch" href="/assets/js/15.6c758eca.js"><link rel="prefetch" href="/assets/js/16.58440a84.js"><link rel="prefetch" href="/assets/js/17.1e1f5c53.js"><link rel="prefetch" href="/assets/js/18.28115609.js"><link rel="prefetch" href="/assets/js/19.7e395424.js"><link rel="prefetch" href="/assets/js/20.2c2ea5f8.js"><link rel="prefetch" href="/assets/js/21.1e8ef167.js"><link rel="prefetch" href="/assets/js/22.47a8f5b7.js"><link rel="prefetch" href="/assets/js/23.f507c548.js"><link rel="prefetch" href="/assets/js/24.b19f43b8.js"><link rel="prefetch" href="/assets/js/25.5b1882b0.js"><link rel="prefetch" href="/assets/js/26.16cf6f8a.js"><link rel="prefetch" href="/assets/js/27.6f3498d0.js"><link rel="prefetch" href="/assets/js/28.f56b7e3c.js"><link rel="prefetch" href="/assets/js/29.de1da78b.js"><link rel="prefetch" href="/assets/js/3.73d3287d.js"><link rel="prefetch" href="/assets/js/30.108b25a0.js"><link rel="prefetch" href="/assets/js/31.68af7d35.js"><link rel="prefetch" href="/assets/js/32.c9f05837.js"><link rel="prefetch" href="/assets/js/33.13bd6f64.js"><link rel="prefetch" href="/assets/js/34.59041fd7.js"><link rel="prefetch" href="/assets/js/35.4382a261.js"><link rel="prefetch" href="/assets/js/36.01d6324a.js"><link rel="prefetch" href="/assets/js/37.22e4179e.js"><link rel="prefetch" href="/assets/js/38.f553994e.js"><link rel="prefetch" href="/assets/js/39.a72bb5df.js"><link rel="prefetch" href="/assets/js/4.9a52aae5.js"><link rel="prefetch" href="/assets/js/40.3751cd34.js"><link rel="prefetch" href="/assets/js/41.d351ec5d.js"><link rel="prefetch" href="/assets/js/42.b87a3eae.js"><link rel="prefetch" href="/assets/js/43.7035de8a.js"><link rel="prefetch" href="/assets/js/44.2c18f0bc.js"><link rel="prefetch" href="/assets/js/45.52905280.js"><link rel="prefetch" href="/assets/js/46.abb047a4.js"><link rel="prefetch" href="/assets/js/47.2ac230d3.js"><link rel="prefetch" href="/assets/js/48.b63bb42b.js"><link rel="prefetch" href="/assets/js/49.35752ae9.js"><link rel="prefetch" href="/assets/js/5.36029518.js"><link rel="prefetch" href="/assets/js/50.b6bd912f.js"><link rel="prefetch" href="/assets/js/51.0e0db65f.js"><link rel="prefetch" href="/assets/js/52.d15fb17a.js"><link rel="prefetch" href="/assets/js/53.844345be.js"><link rel="prefetch" href="/assets/js/54.52685e8c.js"><link rel="prefetch" href="/assets/js/55.83a99fe0.js"><link rel="prefetch" href="/assets/js/56.fe26d3a3.js"><link rel="prefetch" href="/assets/js/57.dae36566.js"><link rel="prefetch" href="/assets/js/58.1bfd28b1.js"><link rel="prefetch" href="/assets/js/59.88f55364.js"><link rel="prefetch" href="/assets/js/6.d3b55a54.js"><link rel="prefetch" href="/assets/js/7.af0443ed.js"><link rel="prefetch" href="/assets/js/8.2c9a7ea2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74c45c5d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">wch的个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java虚拟机</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java并发编程</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/concurrent/并发编程（一）：并行计算概念.html" class="sidebar-link">并发编程（一）：并行计算概念</a></li><li><a href="/posts/concurrent/并发编程（二）：JDK支持.html" class="sidebar-link">并发编程（二）：JDK支持</a></li><li><a href="/posts/concurrent/并发编程（三）：锁的优化.html" class="active sidebar-link">并发编程（三）：锁的优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#锁优化角度" class="sidebar-link">锁优化角度</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#减小锁持有的时间" class="sidebar-link">减小锁持有的时间</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#减小锁粒度" class="sidebar-link">减小锁粒度</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#使用读写锁代替独占锁" class="sidebar-link">使用读写锁代替独占锁</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#锁分离" class="sidebar-link">锁分离</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#锁粗化" class="sidebar-link">锁粗化</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#jvm-对锁的优化" class="sidebar-link">JVM 对锁的优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#偏向锁" class="sidebar-link">偏向锁</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#轻量级锁" class="sidebar-link">轻量级锁</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#自旋锁" class="sidebar-link">自旋锁</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#锁消除" class="sidebar-link">锁消除</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#threadlocal" class="sidebar-link">ThreadLocal</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#threadlocal-set-t-value" class="sidebar-link">ThreadLocal.set(T value)</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#threadlocal-get" class="sidebar-link">ThreadLocal.get()</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#threadlocal-remove" class="sidebar-link">ThreadLocal.remove()</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#无锁" class="sidebar-link">无锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#cas" class="sidebar-link">CAS</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（三）：锁的优化.html#unsafe-类" class="sidebar-link">Unsafe 类</a></li></ul></li></ul></li><li><a href="/posts/concurrent/并发编程（四）：并行模式与策略.html" class="sidebar-link">并发编程（四）：并行模式与策略</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis 源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring Security 源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微信小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Elasticsearch</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="并发编程（三）：锁的优化"><a href="#并发编程（三）：锁的优化" class="header-anchor">#</a> 并发编程（三）：锁的优化</h1> <h2 id="锁优化角度"><a href="#锁优化角度" class="header-anchor">#</a> 锁优化角度</h2> <h3 id="减小锁持有的时间"><a href="#减小锁持有的时间" class="header-anchor">#</a> 减小锁持有的时间</h3> <p>在真正需要同步的代码块进行加锁，避免在整个任务的处理上加锁，有助于降低锁冲突的可能性，进而提升系统的并发能力。</p> <h3 id="减小锁粒度"><a href="#减小锁粒度" class="header-anchor">#</a> 减小锁粒度</h3> <p>缩小锁定对象的范围，降低锁冲突可能性，进而提升系统并发能力。例如 <code>ConcurrentHashMap</code> 内部细分为若干个小的 <code>HashMap</code>，添加数据时可能只需要对其中的某个 <code>SEGMENT</code> 加锁，这样同时就有多个线程可以操作 <code>ConcurrentHashMap</code>，大大提高了吞吐量。</p> <h3 id="使用读写锁代替独占锁"><a href="#使用读写锁代替独占锁" class="header-anchor">#</a> 使用读写锁代替独占锁</h3> <p>理论上读-读之前是不应该阻塞的，在读多写少的情况下，使用读写锁相对于独占锁能够有效提升系统并发能力。</p> <h3 id="锁分离"><a href="#锁分离" class="header-anchor">#</a> 锁分离</h3> <p>在区别读写锁的基础上进一步延伸，就是锁分离。例如如果需要创建一个线程安全的容器，其加入元素和弹出元素的操作必须要获得容器的锁，那么在运行时，加入和弹出操作就必须等待对方释放资源，如果锁竞争激烈，并发性能就会大大下降。而 <code>LinkedBlockingQueue</code> 的实现中，则使用了读锁和写锁两把锁，其原理是利用 <code>ReentrantLock</code> 和 <code>Condition</code> 分别阻塞和唤醒线程，使得读取和写入之间可以并发。</p> <h3 id="锁粗化"><a href="#锁粗化" class="header-anchor">#</a> 锁粗化</h3> <p>虚拟机在一系列对同一锁不断进行请求和释放的操作时，便会把所有锁操作整合为对锁的一次请求，从而减少对锁的请求同步次数。锁粗化的思想和减少锁的持有时间是相反的。</p> <h2 id="jvm-对锁的优化"><a href="#jvm-对锁的优化" class="header-anchor">#</a> JVM 对锁的优化</h2> <h3 id="偏向锁"><a href="#偏向锁" class="header-anchor">#</a> 偏向锁</h3> <p>如果某个线程获取了锁，到再次请求锁时，没有其他线程再去请求该锁，则省略线程申请锁的同步操作。在几乎没有锁竞争的场合中，偏向锁具有很强的优化效果；但在锁竞争激烈的情况下，可能是多个线程请求相同的锁，偏向模式就会失效。通过虚拟机参数 <code>-XX:+UseBiasedLocking</code> 开启偏向锁。</p> <h3 id="轻量级锁"><a href="#轻量级锁" class="header-anchor">#</a> 轻量级锁</h3> <p>线程在执行同步块之前，JVM 会先在当前线程的栈桢中创建用于存储锁记录的空间，并将对象头中的 <code>Mark Word</code> 复制到锁记录中，然后线程尝试使用 <code>CAS</code> 将对象头中的 <code>Mark Word</code> 替换为指向锁记录的指针。如果成功则线程可以顺利进入临界区，如果失败，锁请求会膨胀为重量级锁。</p> <h3 id="自旋锁"><a href="#自旋锁" class="header-anchor">#</a> 自旋锁</h3> <p>假设在不久的将来，线程就可以获取请求的锁资源，那么直接在操作系统层面将线程挂起是得不偿失的，因此虚拟机会让当前线程做几个空循环，如果若干次循环后能够获得锁，则顺利进入临界区，否则才会将线程真实地在操作系统层面挂起。</p> <h3 id="锁消除"><a href="#锁消除" class="header-anchor">#</a> 锁消除</h3> <p>虚拟机在 <code>JIT</code> 编译时通过对上下文的扫描，能够去除不可能存在共享资源竞争的锁。通过锁消除，可以节省无意义的请求锁的时间。锁消除设计的一项关键技术为逃逸分析，即观察某一个变量是否会逃出某一个作用域。</p> <h2 id="threadlocal"><a href="#threadlocal" class="header-anchor">#</a> ThreadLocal</h2> <p><code>ThreadLocal</code> 表示线程局部变量，只有当前线程才能访问，因此是线程安全的，但是不同线程的 <code>ThreadLocal</code> 如果存放了相同的对象，那么也是线程不安全的，需要在应用层作出保证。如果共享对象对于竞争的处理容易造成性能损失，则应该考虑使用 <code>ThreadLocal</code> 为每个线程分配单独的对象。</p> <h3 id="threadlocal-set-t-value"><a href="#threadlocal-set-t-value" class="header-anchor">#</a> ThreadLocal.set(T value)</h3> <p>在调用 <code>ThreadLocal</code> 的 <code>set()</code> 方法时，先根据当前线程获取 <code>ThreadLocal.ThreadLocalMap</code> 的一个实例（可以理解为一个 Map），写入数据时，以 <code>ThreadLocal</code> 对象作为 <code>key</code>，写入的数据作为 <code>value</code>。</p> <h3 id="threadlocal-get"><a href="#threadlocal-get" class="header-anchor">#</a> ThreadLocal.get()</h3> <p>在调用 <code>ThreadLocal</code> 的 <code>get()</code> 方法时，获取当前线程对应的 <code>ThreadLocal.ThreadLocalMap</code> 实例，再使用 <code>ThreadLocal</code> 对象作为 <code>key</code> 取出数据。</p> <h3 id="threadlocal-remove"><a href="#threadlocal-remove" class="header-anchor">#</a> ThreadLocal.remove()</h3> <p>通过 <code>ThreadLocal</code> 写入的数据是维护在线程内部的，所以只要线程不退出，对象引用就会一直存在。如果使用线程池，在任务结束后不对数据进行清理，则可能会造成内存泄漏，因此在数据使用完成后最好使用 <code>ThreadLocal.remove()</code> 将数据移除。</p> <h2 id="无锁"><a href="#无锁" class="header-anchor">#</a> 无锁</h2> <p>对于并发而言，锁是一种悲观的策略，它总是假设每次临界区操作都会产生冲突，在获取不到锁时，会阻塞线程执行。而无锁是一种乐观的策略，它假设对资源的访问是没有冲突的，所有线程都可以在非阻塞的情况下执行，无锁策略使用 <code>CAS (Compare And Swap)</code> 来鉴别线程冲突，一旦检测到冲突，就重试当前操作至没有冲突为止。</p> <h3 id="cas"><a href="#cas" class="header-anchor">#</a> CAS</h3> <p><code>CAS (Compare And Swap，比较交换)</code> 由于其非阻塞性，对死锁问题天生免疫；线程间的相互影响远比基于锁的方式要小；使用无锁的方式完全没有锁竞争和线程间频繁调度带来的系统开销，因此无锁比基于锁的方式拥有更优越的性能。</p> <h4 id="cas-算法"><a href="#cas-算法" class="header-anchor">#</a> CAS 算法</h4> <p><code>CAS(V, E, N)</code> 包含 3 个参数：</p> <ul><li><code>V</code>：要更新的变量的值。</li> <li><code>E</code>：变量的预期值。</li> <li><code>N</code>：变量需要更新的值。</li></ul> <p><code>CAS</code> 是一个原子操作，仅当 <code>V</code> 和 <code>E</code> 相等时，才会将变量的值更新为 <code>N</code>，否则说明有其它线程对这个变量做了修改操作，当前线程放弃更新，最后返回变量的真实值。</p> <h4 id="cas-核心操作"><a href="#cas-核心操作" class="header-anchor">#</a> CAS 核心操作</h4> <p>以 <code>AtomicInteger</code> 为例，此类中的核心字段为：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 实际取值</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>
</code></pre></div><p><code>incrementAndGet()</code> 方法的作用是自增 1 并获取变量的值，其内部调用的是 <code>Unsafe</code> 类的 <code>getAndAddInt()</code> 方法。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">getAndAddInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> valueOffset<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * @param obj 进行修改的AtomicInteger对象
 * @param valueOffset AtomicInteger的value字段的地址偏移量
 * @param i 要增加的数值
 * @return 被修改的变量修改前的值
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndAddInt</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">long</span> valueOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> pre<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// 需要修改的变量的当前值</span>
        pre <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getIntVolatile</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> valueOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// CAS操作，成功返回true，失败返回false</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> valueOffset<span class="token punctuation">,</span> pre<span class="token punctuation">,</span> pre <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> pre<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>getAndAddInt()</code> 方法被调用后，循环调用 Java Native 方法 <code>compareAndSwapInt()</code>，如果修改成功则退出循环，返回被修改的变量修改前的值，如果修改不成功，则会一直重试直至成功修改。</p> <h4 id="aba-问题"><a href="#aba-问题" class="header-anchor">#</a> ABA 问题</h4> <p>从内存中读取和比较之间，变量的值可能被多次修改，最终回到原来的值，当前线程可能就会误以为此变量未修改。为了解决这类问题，可以引入 <code>AtomicStampedReference</code>，它的内部不仅维护了变量的值，还维护了修改的时间戳（或者可以看作是版本号），当进行 <code>CAS</code> 操作时，对象值和时间戳都满足期望值，修改才会成功。</p> <h4 id="普通字段的原子操作"><a href="#普通字段的原子操作" class="header-anchor">#</a> 普通字段的原子操作</h4> <p>原子包提供 <code>AtomicIntegerFieldUpdater</code>，<code>AtomicReferenceFieldUpdater</code> 等工具用于给普通资源提供原子操作，其使用方式如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">T</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">AtomicIntegerFieldUpdater</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> number <span class="token operator">=</span> <span class="token class-name">AtomicIntegerFieldUpdater</span><span class="token punctuation">.</span><span class="token function">newUpdater</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
number<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用这些工具需要注意：</p> <ul><li>只能增强非 <code>private</code> 字段，即只能修改可见范围内的字段。</li> <li>被增强的字段必须要用 <code>volatile</code> 字段修饰，用于确保变量被正确的读取。</li> <li>由于 <code>CAS</code> 会通过对象实例中的偏移量直接进行赋值，所以增强不支持 <code>static</code> 字段。</li></ul> <h3 id="unsafe-类"><a href="#unsafe-类" class="header-anchor">#</a> Unsafe 类</h3> <p><code>sun.misc.Unsafe</code> 类封装了一些不安全的操作，主要是为了操作指针，例如：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">getInt</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>此方法的作用是获取到对象 <code>obj</code> 头部的偏移量为 <code>offset</code> 的 <code>int</code> 值。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/posts/concurrent/并发编程（二）：JDK支持.html" class="prev">并发编程（二）：JDK支持</a></span> <span class="next"><a href="/posts/concurrent/并发编程（四）：并行模式与策略.html">并发编程（四）：并行模式与策略</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.15a66b26.js" defer></script><script src="/assets/js/2.92cd0f37.js" defer></script><script src="/assets/js/9.c08dcf83.js" defer></script>
  </body>
</html>

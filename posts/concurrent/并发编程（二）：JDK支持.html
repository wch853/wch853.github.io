<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>并发编程（二）：JDK 支持 | wch的个人主页</title>
    <meta name="description" content="用于分享wch的学习笔记和项目~">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.74c45c5d.css" as="style"><link rel="preload" href="/assets/js/app.15a66b26.js" as="script"><link rel="preload" href="/assets/js/2.92cd0f37.js" as="script"><link rel="preload" href="/assets/js/10.1166f652.js" as="script"><link rel="prefetch" href="/assets/js/11.b6ae0b14.js"><link rel="prefetch" href="/assets/js/12.7802c7ba.js"><link rel="prefetch" href="/assets/js/13.63066938.js"><link rel="prefetch" href="/assets/js/14.1f9fa0d5.js"><link rel="prefetch" href="/assets/js/15.6c758eca.js"><link rel="prefetch" href="/assets/js/16.58440a84.js"><link rel="prefetch" href="/assets/js/17.1e1f5c53.js"><link rel="prefetch" href="/assets/js/18.28115609.js"><link rel="prefetch" href="/assets/js/19.7e395424.js"><link rel="prefetch" href="/assets/js/20.2c2ea5f8.js"><link rel="prefetch" href="/assets/js/21.1e8ef167.js"><link rel="prefetch" href="/assets/js/22.47a8f5b7.js"><link rel="prefetch" href="/assets/js/23.f507c548.js"><link rel="prefetch" href="/assets/js/24.b19f43b8.js"><link rel="prefetch" href="/assets/js/25.5b1882b0.js"><link rel="prefetch" href="/assets/js/26.16cf6f8a.js"><link rel="prefetch" href="/assets/js/27.6f3498d0.js"><link rel="prefetch" href="/assets/js/28.f56b7e3c.js"><link rel="prefetch" href="/assets/js/29.de1da78b.js"><link rel="prefetch" href="/assets/js/3.73d3287d.js"><link rel="prefetch" href="/assets/js/30.108b25a0.js"><link rel="prefetch" href="/assets/js/31.68af7d35.js"><link rel="prefetch" href="/assets/js/32.c9f05837.js"><link rel="prefetch" href="/assets/js/33.13bd6f64.js"><link rel="prefetch" href="/assets/js/34.59041fd7.js"><link rel="prefetch" href="/assets/js/35.4382a261.js"><link rel="prefetch" href="/assets/js/36.01d6324a.js"><link rel="prefetch" href="/assets/js/37.22e4179e.js"><link rel="prefetch" href="/assets/js/38.f553994e.js"><link rel="prefetch" href="/assets/js/39.a72bb5df.js"><link rel="prefetch" href="/assets/js/4.9a52aae5.js"><link rel="prefetch" href="/assets/js/40.3751cd34.js"><link rel="prefetch" href="/assets/js/41.d351ec5d.js"><link rel="prefetch" href="/assets/js/42.b87a3eae.js"><link rel="prefetch" href="/assets/js/43.7035de8a.js"><link rel="prefetch" href="/assets/js/44.2c18f0bc.js"><link rel="prefetch" href="/assets/js/45.52905280.js"><link rel="prefetch" href="/assets/js/46.abb047a4.js"><link rel="prefetch" href="/assets/js/47.2ac230d3.js"><link rel="prefetch" href="/assets/js/48.b63bb42b.js"><link rel="prefetch" href="/assets/js/49.35752ae9.js"><link rel="prefetch" href="/assets/js/5.36029518.js"><link rel="prefetch" href="/assets/js/50.b6bd912f.js"><link rel="prefetch" href="/assets/js/51.0e0db65f.js"><link rel="prefetch" href="/assets/js/52.d15fb17a.js"><link rel="prefetch" href="/assets/js/53.844345be.js"><link rel="prefetch" href="/assets/js/54.52685e8c.js"><link rel="prefetch" href="/assets/js/55.83a99fe0.js"><link rel="prefetch" href="/assets/js/56.fe26d3a3.js"><link rel="prefetch" href="/assets/js/57.dae36566.js"><link rel="prefetch" href="/assets/js/58.1bfd28b1.js"><link rel="prefetch" href="/assets/js/59.88f55364.js"><link rel="prefetch" href="/assets/js/6.d3b55a54.js"><link rel="prefetch" href="/assets/js/7.af0443ed.js"><link rel="prefetch" href="/assets/js/8.2c9a7ea2.js"><link rel="prefetch" href="/assets/js/9.c08dcf83.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74c45c5d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">wch的个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/778216ebe79c" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/wch853" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java虚拟机</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java并发编程</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/concurrent/并发编程（一）：并行计算概念.html" class="sidebar-link">并发编程（一）：并行计算概念</a></li><li><a href="/posts/concurrent/并发编程（二）：JDK支持.html" class="active sidebar-link">并发编程（二）：JDK支持</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#jdk-并发包" class="sidebar-link">JDK 并发包</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#线程同步工具" class="sidebar-link">线程同步工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#重入锁（reentrantlock）" class="sidebar-link">重入锁（ReentrantLock）</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#条件（condition）" class="sidebar-link">条件（Condition）</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#信号量（semaphore）" class="sidebar-link">信号量（Semaphore）</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#读写锁（readwritelock）" class="sidebar-link">读写锁（ReadWriteLock）</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#计数器（countdownlatch）" class="sidebar-link">计数器（CountDownLatch）</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#循环栅栏（cyclicbarrier）" class="sidebar-link">循环栅栏（CyClicBarrier）</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#线程阻塞工具-locksupport" class="sidebar-link">线程阻塞工具 LockSupport</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#线程池" class="sidebar-link">线程池</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#threadpoolexecutor" class="sidebar-link">ThreadPoolExecutor</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#线程池扩容策略" class="sidebar-link">线程池扩容策略</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#线程池拒绝策略" class="sidebar-link">线程池拒绝策略</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#threadfactory" class="sidebar-link">ThreadFactory</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#线程池扩展" class="sidebar-link">线程池扩展</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#线程池数量调优" class="sidebar-link">线程池数量调优</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#并发容器" class="sidebar-link">并发容器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#collections-工具类包装" class="sidebar-link">Collections 工具类包装</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#concurrentlinkedqueue" class="sidebar-link">ConcurrentLinkedQueue</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#copyonwritearraylist" class="sidebar-link">CopyOnWriteArrayList</a></li><li class="sidebar-sub-header"><a href="/posts/concurrent/并发编程（二）：JDK支持.html#arrayblockingqueue" class="sidebar-link">ArrayBlockingQueue</a></li></ul></li></ul></li><li><a href="/posts/concurrent/并发编程（三）：锁的优化.html" class="sidebar-link">并发编程（三）：锁的优化</a></li><li><a href="/posts/concurrent/并发编程（四）：并行模式与策略.html" class="sidebar-link">并发编程（四）：并行模式与策略</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis 源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring Security 源码分析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微信小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Elasticsearch</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="并发编程（二）：jdk-支持"><a href="#并发编程（二）：jdk-支持" class="header-anchor">#</a> 并发编程（二）：JDK 支持</h1> <h2 id="jdk-并发包"><a href="#jdk-并发包" class="header-anchor">#</a> JDK 并发包</h2> <p>为了更好地支持并发程序，JDK 提供了大量的 API 和框架，主要包含三部分：</p> <ul><li>线程同步工具</li> <li>线程池支持</li> <li>线程安全的并发容器</li></ul> <h2 id="线程同步工具"><a href="#线程同步工具" class="header-anchor">#</a> 线程同步工具</h2> <h3 id="重入锁（reentrantlock）"><a href="#重入锁（reentrantlock）" class="header-anchor">#</a> 重入锁（ReentrantLock）</h3> <p>重入锁通过 <code>java.util.concurrent.locks.ReentrantLock</code> 类来实现。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>与 <code>synchronized</code> 相比，<code>ReentrantLock</code> 有着显式的操作过程，开发人员需要手动指定何时加锁、何时释放锁，因此具有更好的灵活性。值得注意的是离开临界区时必须要使用 <code>unlock()</code> 释放锁，否则其他线程就没有机会访问临界区了。重入锁得名于这种锁能够在一个线程中反复进入，即一个线程连续多次获得同一把锁是被允许的。如果一个线程多次获得重入锁，在释放锁时也需要释放多次。</p> <h4 id="中断响应"><a href="#中断响应" class="header-anchor">#</a> 中断响应</h4> <p>使用重入锁的线程允许被中断，也就是说在等待锁的过程中，程序可以根据需要取消对锁的请求。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取锁，但是优先响应中断</span>
    lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">isHeldByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="锁申请等待时限"><a href="#锁申请等待时限" class="header-anchor">#</a> 锁申请等待时限</h4> <p>使用 <code>tryLock()</code> 可以对锁进行一次限时请求，如果直接获取不到锁或者在一定时间内获取不到锁，则放弃对锁的申请。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="公平锁"><a href="#公平锁" class="header-anchor">#</a> 公平锁</h4> <p>公平锁要求系统维护一个有序队列，希望获取锁的线程按时间顺序进入队列，按照先来后到的原则分配锁资源。只要排队，线程都能获取锁资源，可以避免产生饥饿。但是公平锁因为需要维护队列所以实现成本较高，性能也相对低下；非公平锁调度时更倾向于已经获得锁的线程，即某个线程已经获得了锁，此后仍有多次对锁的申请，系统调度会更偏向于这个线程，因此是不公平的，但是更为高效。<code>synchronized</code> 是非公平锁，而 <code>ReentrantLock</code> 允许对锁的公平性进行设置：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="条件（condition）"><a href="#条件（condition）" class="header-anchor">#</a> 条件（Condition）</h3> <p>通过重入锁的 <code>newCondition()</code> 方法可以获取一个和当前重入锁绑定的 <code>Condition</code> 实例，利用这个实例就可以让线程在合适的时机等待（释放锁资源），在特定时刻获取唤醒通知线程继续执行。</p> <ul><li><code>wait()</code> ：使得当前线程等待，并释放锁资源。</li> <li><code>awaitUninterruptibly()</code> ：使得当前线程等待，并释放锁资源，但不会在等待过程中响应中断。</li> <li><code>singal()</code> ：唤醒一个等待中的线程，执行后需要释放锁，让给唤醒的线程执行。</li> <li><code>singalAll()</code> ：唤醒所有等待中的线程。</li></ul> <h3 id="信号量（semaphore）"><a href="#信号量（semaphore）" class="header-anchor">#</a> 信号量（Semaphore）</h3> <p><code>Semaphore</code> 是计数信号量，用于限制获取某种资源的线程数量。<code>acquire()</code> 方法希望获取一个许可，如果无法获得，线程会等待，直到有其它线程释放了许可或线程被中断；<code>tryAcquire()</code> 尝试获取许可，如果无法获得会继续执行，不会等待；在线程访问资源结束后，需要通过 <code>release()</code> 释放许可，使其它等待许可的线程有机会访问资源。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token keyword">int</span> permits<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token keyword">int</span> permits<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fair<span class="token punctuation">)</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取许可</span>
    semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 一次获取多个许可</span>
    semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 尝试获取许可</span>
    semaphore<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="读写锁（readwritelock）"><a href="#读写锁（readwritelock）" class="header-anchor">#</a> 读写锁（ReadWriteLock）</h3> <p>读写的访问约束一般为：</p> <ul><li>读-读：读与读之间不阻塞。</li> <li>读-写：读阻塞写，写阻塞读。</li> <li>写-写：写与写之间阻塞。</li></ul> <p>如果在系统中，读操作次数远远大于写操作，此时使用重入锁或内部锁使得所有操作之间都是串行，这显然是不合理的，因此可以使用读写分离锁，允许多个线程同时读，读-写 与 写-写 仍是需要相互等待和持有锁的。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ReentrantReadWriteLock</span> readWriteLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Lock</span> readLock <span class="token operator">=</span> readWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Lock</span> writeLock <span class="token operator">=</span> readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="计数器（countdownlatch）"><a href="#计数器（countdownlatch）" class="header-anchor">#</a> 计数器（CountDownLatch）</h3> <p><code>CountDownLatch</code> 通常用于控制线程等待，他可以使某个线程等待计数器计数完成，再开始执行。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 计数器减1</span>
            latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 调用者线程等待</span>
latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="循环栅栏（cyclicbarrier）"><a href="#循环栅栏（cyclicbarrier）" class="header-anchor">#</a> 循环栅栏（CyClicBarrier）</h3> <p><code>CyClicBarrier</code> 类似 <code>CountDownLatch</code>，也是一种多线程并发控制工具，相对于计数器，循环栅栏能够反复计数。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">CyclicBarrier</span> cyclicBarrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 执行完成回调</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                cyclicBarrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">BrokenBarrierException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="线程阻塞工具-locksupport"><a href="#线程阻塞工具-locksupport" class="header-anchor">#</a> 线程阻塞工具 LockSupport</h3> <p><code>LockSupport</code> 提供一系列静态方法用于阻塞线程：</p> <ul><li><code>park()</code> ：阻塞调用线程。</li> <li><code>parkNanos(long nanos) / parkUntil(long deadline)</code>：限时阻塞。</li> <li><code>unpark(Thread thread)</code>：通知阻塞线程继续执行。
<code>LockSupport</code> 与 <code>Thread.suspend()</code> 相比，弥补了 <code>Thread.resume()</code> 在之前发送导致线程无法继续执行的情况，因为 <code>LockSupport</code> 使用类似信号了的机制，它为每个线程准备了一个许可，如果许可可用，那么 <code>park()</code> 方法会直接返回，如果不可用则线程阻塞。而 <code>unpark()</code> 方法会使得线程的许可变为可用，这样即使 <code>unpark()</code> 发生在 <code>park()</code> 之前，也能使得线程继续执行。同时，如果线程通过 <code>park()</code> 挂起，线程状态会明确给出 <code>WAITING</code>，而不是像 <code>Thread.suspend()</code> 给出一个令人费解的 <code>RUNNABLE</code>。</li></ul> <h2 id="线程池"><a href="#线程池" class="header-anchor">#</a> 线程池</h2> <p>在真实的生产环境中可能会开启多个线程来支撑应用。线程虽然是一种轻量级的工具，但创建和销毁仍需要花费时间，当线程数量过大时，就会耗尽 CPU，造成系统性能下降；其次线程本身也是要占用内存空间的，大量线程抢占宝贵的内存资源，可能会导致内存溢出，即使没有，大量的线程回收也会给 GC 带来很大压力，延长 GC 时间。因此，线程的数量必须被合理控制在一个范围内。
使用线程池后，创建线程变为从线程池中获取空闲线程，关闭线程变为向线程池归还线程，线程的数量因此得到合理控制。</p> <h3 id="threadpoolexecutor"><a href="#threadpoolexecutor" class="header-anchor">#</a> ThreadPoolExecutor</h3> <p>JDK 提供 <code>ThreadPoolExecutor</code> 类用于创建线程池，其构造方法的参数如下：</p> <ul><li><code>corePoolSize</code>：核心线程数。</li> <li><code>maximumPoolSize</code>：最大线程数。</li> <li><code>keepAliveTime</code>：当线程数超过 <code>corePoolSize</code>，多余空闲线程的存活时间。</li> <li><code>unit</code>：<code>keepAliveTime</code> 的时间单位。</li> <li><code>workQueue</code>：任务队列，被提交但未执行的任务。</li> <li><code>threadFactory</code>：线程工厂，用于创建线程。</li> <li><code>rejectHandler</code>：任务来不及处理时，拒绝处理任务的策略。</li></ul> <h3 id="线程池扩容策略"><a href="#线程池扩容策略" class="header-anchor">#</a> 线程池扩容策略</h3> <p><code>workQueue</code> 是一个用于存放 <code>Runnable</code> 的 <code>BlockingQueue</code> 接口的对象，如果是一个有界队列，线程池的扩容策略为：</p> <ol><li>线程数少于 <code>corePoolSize</code>，优先创建新线程。</li> <li>线程数大于 <code>corePoolSize</code> 且 <code>workQueue</code> 未满，将任务加入 <code>workQueue</code>。</li> <li><code>workQueue</code> 已满，线程数少于 <code>maximumPoolSize</code>，创建新的线程。</li> <li><code>workQueue</code> 已满，线程数等于 <code>maximumPoolSize</code>，执行拒绝策略。</li></ol> <h3 id="线程池拒绝策略"><a href="#线程池拒绝策略" class="header-anchor">#</a> 线程池拒绝策略</h3> <ul><li><code>AbortPolicy</code>：直接抛出异常。</li> <li><code>CallerRunsPolicy</code>：在调用者线程中执行被拒绝的任务。</li> <li><code>DiscardOledestPolicy</code>：丢弃一个即将执行的任务，并再次尝试提交任务。</li> <li><code>DiscardPolicy</code>：丢弃无法处理的任务。</li></ul> <h3 id="threadfactory"><a href="#threadfactory" class="header-anchor">#</a> ThreadFactory</h3> <p><code>ThreadFactory</code> 是一个接口，只有一个用于创建线程的方法 <code>Thread newThread(Runnable r);</code>。通过 <code>ThreadFactory</code> 可以自定义创建线程的名称、线程组、线程优先级等。<code>java.util.concurrent.Executors.DefaultThreadFactory</code> 实现的线程工厂如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DefaultThreadFactory</span> <span class="token keyword">implements</span> <span class="token class-name">ThreadFactory</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> poolNumber <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadGroup</span> group<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> threadNumber <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> namePrefix<span class="token punctuation">;</span>

    <span class="token class-name">DefaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SecurityManager</span> s <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        group <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> s<span class="token punctuation">.</span><span class="token function">getThreadGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getThreadGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        namePrefix <span class="token operator">=</span> <span class="token string">&quot;pool-&quot;</span> <span class="token operator">+</span>
                        poolNumber<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                        <span class="token string">&quot;-thread-&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Thread</span> <span class="token function">newThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> r<span class="token punctuation">,</span>
                                namePrefix <span class="token operator">+</span> threadNumber<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isDaemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            t<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span>NORM_PRIORITY<span class="token punctuation">)</span>
            t<span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>NORM_PRIORITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="线程池扩展"><a href="#线程池扩展" class="header-anchor">#</a> 线程池扩展</h3> <p><code>ThreadPoolExecutor</code> 提供 <code>beforeExecute()</code>、<code>afterExecute()</code>、<code>terminated()</code> 3 个方法对线程池进行扩展。这 3 个方法分别用于记录一个任务执行前、执行后和整个线程池的退出。</p> <h4 id="一个阻塞线程池"><a href="#一个阻塞线程池" class="header-anchor">#</a> 一个阻塞线程池</h4> <p>当线程池线程数已扩展至最大线程，且任务队列已满，需要对提交任务的线程进行阻塞，当有任务执行完毕，唤醒阻塞线程继续提交任务，适用于扩展消息队列并发能力等情况。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 阻塞线程池
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BlockedThreadPoolExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Condition</span> condition <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">BlockedThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span> <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">BlockedThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span> <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span> <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">,</span> threadFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">BlockedThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span> <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span> <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">BlockedThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span> <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span> <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span> <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">,</span> threadFactory<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remainingCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 线程池已经创建最大线程数且任务队列已满</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                condition<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">afterExecute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterExecute</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 任务执行完成，存在空闲线程，唤醒提交任务线程</span>
        condition<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="线程池数量调优"><a href="#线程池数量调优" class="header-anchor">#</a> 线程池数量调优</h3> <ul><li><code>NCPU</code>：CPU 数量。</li> <li><code>UCPU</code>：目标 CPU 使用率（0 &lt;= UCPU &lt;= 1）。</li> <li><code>W/C</code>：等待时间与计算时间的比率</li></ul> <p>为保持处理器达到期望的使用率，最优线程池大小为：<code>Nthreads = NCPU * UCPU * (1 + W/C)</code>。</p> <h2 id="并发容器"><a href="#并发容器" class="header-anchor">#</a> 并发容器</h2> <h3 id="collections-工具类包装"><a href="#collections-工具类包装" class="header-anchor">#</a> Collections 工具类包装</h3> <p><code>Collections</code> 工具类提供一系列方法将原本线程不安全的容器转为线程安全容器。如：<code>synchronizedList(List&lt;T&gt; list)</code>、<code>synchronizedMap(Map&lt;K,V&gt; m)</code>、<code>synchronizedSet(Set&lt;T&gt; s)</code> 等。其原理是对原有容器的相关操作使用 <code>synchronized</code> 进行同步。</p> <h3 id="concurrentlinkedqueue"><a href="#concurrentlinkedqueue" class="header-anchor">#</a> ConcurrentLinkedQueue</h3> <p><code>ConcurrentLinkedQueue</code> 是 Queue 的一个安全实现．以链表作为其数据结构。Queue 中元素按 FIFO 原则进行排序．采用 CAS 操作，来保证元素的一致性，基本是高并发环境下性能最好的容器。</p> <h3 id="copyonwritearraylist"><a href="#copyonwritearraylist" class="header-anchor">#</a> CopyOnWriteArrayList</h3> <p>在很多应用场景中，读操作次数可能远大于写操作次数，<code>CopyOnWriteArrayList</code> 就是这种将读取性能发挥到极致的并发容器。<code>CopyOnWriteArrayList</code> 在写入操作时，并不修改原有内容，而是进行一次自我复制，将修改的内容写入副本中，再用副本替换原有的数据。这样就保证写操作不会影响读操作了。</p> <h3 id="arrayblockingqueue"><a href="#arrayblockingqueue" class="header-anchor">#</a> ArrayBlockingQueue</h3> <p><code>ArrayBlockingQueue</code> 是 <code>BlockingQueue</code> 的一个实现，可以用来实现线程间数据共享。<code>Blocking</code> 的关键在于：</p> <ul><li><code>put()</code>：将元素压入队列末尾，如果队列已满则会一直等待，直到队列中有快线位置。</li> <li><code>take()</code>：如果队列为空，则会一直等待，直到有元素入队。
其原理是通过 <code>ReentrantLock</code> 和 <code>Condition</code> 对线程挂起和唤醒。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/posts/concurrent/并发编程（一）：并行计算概念.html" class="prev">并发编程（一）：并行计算概念</a></span> <span class="next"><a href="/posts/concurrent/并发编程（三）：锁的优化.html">并发编程（三）：锁的优化</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.15a66b26.js" defer></script><script src="/assets/js/2.92cd0f37.js" defer></script><script src="/assets/js/10.1166f652.js" defer></script>
  </body>
</html>

(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{234:function(t,s,a){"use strict";a.r(s);var n=a(0),r=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"微服务实践（二）：微服务与容器化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#微服务实践（二）：微服务与容器化"}},[t._v("#")]),t._v(" 微服务实践（二）：微服务与容器化")]),t._v(" "),a("h2",{attrs:{id:"软件架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#软件架构"}},[t._v("#")]),t._v(" 软件架构")]),t._v(" "),a("p",[t._v("软件架构是在软件的内部，经过综合各种因素的考量、权衡，选择特定的技术，将系统划分成不同的部分并使这些部分相互分工，彼此协作，为用户提供需要的价值。")]),t._v(" "),a("h3",{attrs:{id:"软件架构影响因素"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#软件架构影响因素"}},[t._v("#")]),t._v(" 软件架构影响因素")]),t._v(" "),a("ul",[a("li",[t._v("业务需求：需要实现的功能")]),t._v(" "),a("li",[t._v("技术栈：选择用于实现功能的技术")]),t._v(" "),a("li",[t._v("成本：愿意为开发软件付出的价值")]),t._v(" "),a("li",[t._v("组织架构：有哪些部门能为开发提供帮助")]),t._v(" "),a("li",[t._v("可扩展性：面向扩展开放")]),t._v(" "),a("li",[t._v("可维护性：维护成本")])]),t._v(" "),a("h3",{attrs:{id:"软件架构进化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#软件架构进化"}},[t._v("#")]),t._v(" 软件架构进化")]),t._v(" "),a("h4",{attrs:{id:"单体架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#单体架构"}},[t._v("#")]),t._v(" 单体架构")]),t._v(" "),a("p",[t._v("单体架构功能、业务集中在一个发布包里，部署运行在同一个进程中。")]),t._v(" "),a("ul",[a("li",[t._v("优势：易于开发、测试、部署、水平扩展")]),t._v(" "),a("li",[t._v("劣势：代码膨胀而难以维护，构建、部署成本大，上手周期长，升级现有技术栈困难，对资源的不同需求导致扩展性差")])]),t._v(" "),a("h4",{attrs:{id:"微服务架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#微服务架构"}},[t._v("#")]),t._v(" 微服务架构")]),t._v(" "),a("p",[t._v("使用一套小服务来开发单个应用的方式，每个服务运行在独立的进程里，一般采用轻量级的通讯机制互联，并且它们可以通过自动化的方式部署。")]),t._v(" "),a("h2",{attrs:{id:"微服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#微服务"}},[t._v("#")]),t._v(" 微服务")]),t._v(" "),a("h3",{attrs:{id:"诞生背景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#诞生背景"}},[t._v("#")]),t._v(" 诞生背景")]),t._v(" "),a("ul",[a("li",[t._v("互联网行业快速发展")]),t._v(" "),a("li",[t._v("敏捷开发，精益方法深入人心")]),t._v(" "),a("li",[t._v("容器技术的成熟")])]),t._v(" "),a("h3",{attrs:{id:"特征"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#特征"}},[t._v("#")]),t._v(" 特征")]),t._v(" "),a("ul",[a("li",[t._v("单一职责：只把紧密相关的业务放在一起，无关的业务独立出去")]),t._v(" "),a("li",[t._v("轻量级通信：微服务之间的通信应该是轻量级的，平台无关，语言无关")]),t._v(" "),a("li",[t._v("隔离性：每个微服务运行在自己的进程中，不会相互干扰")]),t._v(" "),a("li",[t._v("有自己的数据：有独立的数据存储系统")]),t._v(" "),a("li",[t._v("技术多样性：开发人员选用自己擅长的技术栈")])]),t._v(" "),a("h3",{attrs:{id:"优势"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优势"}},[t._v("#")]),t._v(" 优势")]),t._v(" "),a("ul",[a("li",[t._v("独立性：微服务构建、部署、扩容、缩容、容错甚至数据库都是独立的")]),t._v(" "),a("li",[t._v("敏捷性：微服务功能单一，API 简单，迭代方便")]),t._v(" "),a("li",[t._v("技术栈灵活：在保证提供稳定服务的情况下微服务各个模块可以自由选择技术栈")]),t._v(" "),a("li",[t._v("高效团队：每个团队负责自己的微服务，提高开发效率")])]),t._v(" "),a("h3",{attrs:{id:"不足"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#不足"}},[t._v("#")]),t._v(" 不足")]),t._v(" "),a("ul",[a("li",[t._v("额外工作：微服务需要考虑如何拆分系统，而单体架构不需要")]),t._v(" "),a("li",[t._v("数据一致性：单体架构可能只有一个数据库，通过事务可以保证数据一致性，而微服务有多个数据库")]),t._v(" "),a("li",[t._v("沟通成本：服务的提供方和调用方可能属于多个团队，增加了沟通成本")])]),t._v(" "),a("h3",{attrs:{id:"微服务架构引入的问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#微服务架构引入的问题"}},[t._v("#")]),t._v(" 微服务架构引入的问题")]),t._v(" "),a("h4",{attrs:{id:"通讯"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#通讯"}},[t._v("#")]),t._v(" 通讯")]),t._v(" "),a("h5",{attrs:{id:"从通讯协议角度考虑"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#从通讯协议角度考虑"}},[t._v("#")]),t._v(" 从通讯协议角度考虑")]),t._v(" "),a("ul",[a("li",[t._v("REST API")]),t._v(" "),a("li",[t._v("RPC")]),t._v(" "),a("li",[t._v("MQ")])]),t._v(" "),a("h5",{attrs:{id:"选择-rpc-框架考虑因素"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#选择-rpc-框架考虑因素"}},[t._v("#")]),t._v(" 选择 RPC 框架考虑因素")]),t._v(" "),a("ul",[a("li",[t._v("I/O、线程调度模型")]),t._v(" "),a("li",[t._v("序列化方式")]),t._v(" "),a("li",[t._v("是否需要多语言支持")])]),t._v(" "),a("h3",{attrs:{id:"常见-rpc-框架"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常见-rpc-框架"}},[t._v("#")]),t._v(" 常见 RPC 框架")]),t._v(" "),a("h4",{attrs:{id:"dubbo"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dubbo"}},[t._v("#")]),t._v(" Dubbo")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/microservice/dubbo.png",alt:"Dubbo"}})]),t._v(" "),a("p",[a("a",{attrs:{href:"http://dubbo.apache.org/zh-cn/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Dubbo"),a("OutboundLink")],1),t._v("是一款高性能的 RPC 框架。注册中心提供注册和发现服务，而不提供转发请求。消费者订阅提供者在注册中心注册的服务，通过接口调用提供者对服务的具体实现。监控中心服务统计消费者和提供者的调用次数、调用时间等，并在汇总后发给注册中心。")]),t._v(" "),a("h4",{attrs:{id:"motan"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#motan"}},[t._v("#")]),t._v(" Motan")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/microservice/motan.png",alt:"Motan"}})]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/weibocom/motan",target:"_blank",rel:"noopener noreferrer"}},[t._v("Motan"),a("OutboundLink")],1),t._v("是新浪微博开源的一个 Java RPC 框架，目前在微博平台中已经广泛应用，每天为数百个服务完成近千亿次的调用。")]),t._v(" "),a("h4",{attrs:{id:"thrift"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#thrift"}},[t._v("#")]),t._v(" thrift")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/microservice/thrift.png",alt:"thrift"}})]),t._v(" "),a("p",[a("a",{attrs:{href:"http://thrift.apache.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("thrift"),a("OutboundLink")],1),t._v("是一个跨语言的服务部署框架，通过 IDL（Interface Definition Language，接口定义语言）来定义 RPC 的接口和数据类型，并通过 thrift 编译器生成不同语言的代码，并由生成的代码负责 RPC 协议层和传输层的实现。")]),t._v(" "),a("h4",{attrs:{id:"grpc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#grpc"}},[t._v("#")]),t._v(" gRPC")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/microservice/grpc.png",alt:"gRPC"}})]),t._v(" "),a("p",[t._v("在 gRPC 里客户端应用可以像调用本地对象一样直接调用另一台不同的机器上服务端应用的方法。在服务端实现接口，并运行一个 gRPC 服务器处理客户端调用。在客户端拥有一个存根能够像服务端一样调用方法。gRPC 同样是跨语言的，使用 protobuf 进行序列化。")]),t._v(" "),a("h4",{attrs:{id:"rpc-框架对比"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rpc-框架对比"}},[t._v("#")]),t._v(" RPC 框架对比")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/microservice/rpc%E6%A1%86%E6%9E%B6%E5%AF%B9%E6%AF%94.png",alt:"RPC框架对比"}})]),t._v(" "),a("h3",{attrs:{id:"服务发现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务发现"}},[t._v("#")]),t._v(" 服务发现")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("客户端发现\n"),a("img",{attrs:{src:"/img/microservice/%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E7%8E%B0.png",alt:"客户端发现"}})])]),t._v(" "),a("li",[a("p",[t._v("服务端发现\n"),a("img",{attrs:{src:"/img/microservice/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%8F%91%E7%8E%B0.png",alt:"服务端发现"}})])])]),t._v(" "),a("h3",{attrs:{id:"服务部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务部署"}},[t._v("#")]),t._v(" 服务部署")]),t._v(" "),a("p",[t._v("传统部署可能通过 jenkins 脚本上传代码来部署，微服务随着数量增多，传统部署方式部署困难，需要引入服务编排工具，如 Mesos、Docker Swarm、Kubernetes。")]),t._v(" "),a("h2",{attrs:{id:"分布式微服务实践"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分布式微服务实践"}},[t._v("#")]),t._v(" 分布式微服务实践")]),t._v(" "),a("p",[t._v("以一个简单的课程服务为例，实现用户登录、注册，发送消息验证码，查询课程信息等功能，集成 dubbo、thrift、SpringBoot、SpringCloud 等框架，并在 Docker 上进行容器化部署。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/microservice/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84.png",alt:"服务架构"}})]),t._v(" "),a("ul",[a("li",[t._v("course-thrift-server：基于 thrift(Java)，通过 TSocket 对外提供用户相关服务。")]),t._v(" "),a("li",[t._v("course-dubbo-server：基于 Dubbo，通过注册中心 zookeeper 注册提供的服务。")]),t._v(" "),a("li",[t._v("course-message：基于 thrift(golang)，通过 TSocket 对外提供信息相关服务。")]),t._v(" "),a("li",[t._v("course-web：web 服务入口，根据业务逻辑进行 RPC 调用。")]),t._v(" "),a("li",[t._v("course-api-gateway：基于 SpringCloud zuul 的服务网关，通过 REST 调用 course-web 的服务，面向客户调用。")])]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/microservice/%E6%9C%8D%E5%8A%A1%E4%BE%9D%E8%B5%96.png",alt:"服务依赖"}})]),t._v(" "),a("h3",{attrs:{id:"用户服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#用户服务"}},[t._v("#")]),t._v(" 用户服务")]),t._v(" "),a("p",[t._v("用户服务负责查询和注册用户信息，实现 thrift 文件生成的 java 接口，并通过 TSocket 对外暴露服务。")]),t._v(" "),a("h4",{attrs:{id:"thrift-代码生成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#thrift-代码生成"}},[t._v("#")]),t._v(" thrift 代码生成")]),t._v(" "),a("p",[t._v("编写 thrift 文件（"),a("a",{attrs:{href:"http://thrift.apache.org/docs/idl",target:"_blank",rel:"noopener noreferrer"}},[t._v("thrift 语法"),a("OutboundLink")],1),t._v("），下载 thrift 代码生成工具，使用命令 "),a("code",[t._v("thrift --gen java --out ../course-interface/src/main/java user_model.thrift && thrift --gen java --out ../course-interface/src/main/java user_service.thrift")]),t._v(" 生成 thrift 类和接口文件。")]),t._v(" "),a("div",{staticClass:"language-thrift extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("namespace java com.wch.course.domain.thrift\n\ntypedef i32 INT\ntypedef i64 LONG\n\n/**\n * 用户信息\n */\nstruct UserInfo {\n\n    /**\n     * 用户编号\n     */\n    1: optional INT id,\n\n    /**\n     * 用户名\n     */\n    2: optional string username,\n\n    /**\n     * 密码\n     */\n    3: optional string password,\n\n    /**\n     * 真实姓名\n     */\n    4: optional string realName,\n\n    /**\n     * 手机号\n     */\n    5: optional LONG mobile,\n\n    /**\n     * 电子邮箱\n     */\n    6: optional string email\n}\n")])])]),a("div",{staticClass:"language-thrift extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("namespace java com.wch.course.service.thrift\n\ninclude 'user_model.thrift'\n\ntypedef i32 INT\ntypedef user_model.UserInfo UserInfo\n\n/**\n * 用户信息服务\n */\nservice IUserService {\n\n    /**\n     * 通过用户编号查询用户信息\n     */\n    UserInfo queryUserById(1: INT id);\n\n    /**\n     * 通过用户名查询用户信息\n     */\n    UserInfo queryUserByName(1: string username);\n\n    /**\n     * 新增用户\n     */\n    void addUser(1: UserInfo userInfo);\n}\n")])])]),a("h4",{attrs:{id:"通过-tsocket-暴露-thrift-服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#通过-tsocket-暴露-thrift-服务"}},[t._v("#")]),t._v(" 通过 TSocket 暴露 thrift 服务")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Slf4j")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Component")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ThriftServer")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${thrift.port}"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" thriftServicePort"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Resource")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IUserService")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Iface")]),t._v(" userService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@PostConstruct")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("startThriftServer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TProcessor")]),t._v(" processor "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IUserService")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Processor")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("userService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TNonblockingServerSocket")]),t._v(" socket "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            socket "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TNonblockingServerSocket")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("thriftServicePort"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TTransportException")]),t._v(" e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"start thrift server error"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TNonblockingServer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Args")]),t._v(" args "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TNonblockingServer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Args")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("processor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("processor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("transportFactory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TFramedTransport")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Factory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("protocolFactory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TBinaryProtocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Factory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TServer")]),t._v(" server "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TNonblockingServer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Runnable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("info")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thrift server start on {} ..."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" thriftServicePort"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("serve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("start")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"消息服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#消息服务"}},[t._v("#")]),t._v(" 消息服务")]),t._v(" "),a("p",[t._v("消息服务提供发送短信、邮件功能（模拟），由 Go 语言实现 Thrift 服务端。")]),t._v(" "),a("h4",{attrs:{id:"下载-thrift-的-go-依赖包"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#下载-thrift-的-go-依赖包"}},[t._v("#")]),t._v(" 下载 thrift 的 Go 依赖包")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("go get -v git.apache.org/thrift.git/lib/go/thrift\n")])])]),a("h4",{attrs:{id:"thrift-定义"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#thrift-定义"}},[t._v("#")]),t._v(" thrift 定义")]),t._v(" "),a("div",{staticClass:"language-thrift extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("namespace java com.wch.course.thrift.service\nnamespace go course.rpc.service\n\n/**\n * 消息服务\n */\nservice IMessageService {\n\n    /**\n     * 发送短信\n     */\n    bool sendSMSMessage(1: string mobile, 2: string message);\n\n    /**\n     * 发送邮件\n     */\n    bool sendEmailMessage(1: string email, 2: string message);\n}\n")])])]),a("h4",{attrs:{id:"接口实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#接口实现"}},[t._v("#")]),t._v(" 接口实现")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" MessageServiceImpl "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("MessageServiceImpl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("SendSMSMessage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mobile "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" message "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("r "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Printf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"send to %s, message: %s\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mobile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("MessageServiceImpl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("SendEmailMessage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" email "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" message "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("r "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Printf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"send to %s, message: %s\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" email"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h4",{attrs:{id:"暴露-thrift-服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#暴露-thrift-服务"}},[t._v("#")]),t._v(" 暴露 thrift 服务")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tflag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("StringVar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("Host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"host"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"localhost:8082"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thrift port"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tflag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Parse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Start")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\thandler "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("impl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MessageServiceImpl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tserviceProcessor "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewIMessageServiceProcessor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("handler"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tsocket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" thrift"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewTServerSocket")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("panic")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\ttransportFactory "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" thrift"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewTFramedTransportFactory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("thrift"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewTTransportFactory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tprotocolFactory "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" thrift"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewTBinaryProtocolFactoryDefault")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\tserver "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" thrift"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewTSimpleServer4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serviceProcessor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" transportFactory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" protocolFactory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tlog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Printf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thrift server in %s"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tserver"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Serve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"课程服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#课程服务"}},[t._v("#")]),t._v(" 课程服务")]),t._v(" "),a("p",[t._v("课程服务负责查询课程信息，实现课程服务并将 Dubbo 接口注册到 zookeeper。\n使用 dubbo-spring-boot-starter 作为 dubbo 与 SpringBoot 集成的 jar 包（SpringBoot 1.x 版本只支持 dubbo-spring-boot-starter 0.1.1）。为了后期与 docker 集成，部分参数以占位符的形式存在，而 dubbo-spring-boot-starter 的自动配置很早就从配置文件中取固定格式的 dubbo 配置，此时部分参数还是占位符的形式，导致自动配置失败，因此本项目选择自定义配置参数名称，手动编写部分配置替换自动配置。")]),t._v(" "),a("ul",[a("li",[t._v("服务端")])]),t._v(" "),a("p",[t._v("配置文件：")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("dubbo:\n  scan:\n    basePackages: com.wch.course.service.impl\n  application:\n    name: dubbo-provider\n  provider:\n    port: "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${dubbo.port}")]),t._v("\n  registry: zookeeper://"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${registry.address}")]),t._v("?client"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("curator\n")])])]),a("p",[t._v("配置注册中心和服务项：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Configuration")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DubboConfig")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${dubbo.registry}"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" registry"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${dubbo.provider.port}"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" dubboPort"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Bean")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RegistryConfig")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("registryConfig")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RegistryConfig")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("registry"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Bean")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ProtocolConfig")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dubboProtocolConfig")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ProtocolConfig")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"dubbo"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dubboPort"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"web-服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#web-服务"}},[t._v("#")]),t._v(" web 服务")]),t._v(" "),a("p",[t._v("web 服务负责根据业务逻辑进行 RPC 调用，并向外部暴露 REST 接口。")]),t._v(" "),a("h4",{attrs:{id:"thrift-客户端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#thrift-客户端"}},[t._v("#")]),t._v(" thrift 客户端")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TServiceClient")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getService")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Class")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TServiceClient")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" clazz"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TSocket")]),t._v(" socket "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TSocket")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TFramedTransport")]),t._v(" transport "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TFramedTransport")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    transport"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("open")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TBinaryProtocol")]),t._v(" tBinaryProtocol "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TBinaryProtocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("transport"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Constructor")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TServiceClient")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" constructor "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" clazz"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getConstructor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TProtocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" constructor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("newInstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tBinaryProtocol"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IUserService")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Client")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUserService")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IUserService")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Client")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getService")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("userServiceHost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" userServicePort"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IUserService")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Client")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IMessageService")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Client")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMessageService")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IMessageService")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Client")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getService")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("messageServiceHost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" messageServicePort"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IMessageService")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Client")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h4",{attrs:{id:"dubbo-客户端配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dubbo-客户端配置"}},[t._v("#")]),t._v(" dubbo 客户端配置")]),t._v(" "),a("p",[t._v("配置文件：")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("dubbo:\n  application:\n    name: dubbo-consumer\n  registry: zookeeper://"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${registry.address}")]),t._v("?client"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("curator\n")])])]),a("p",[t._v("配置注册中心：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('@Configuration\npublic class DubboConfig {\n\n    @Value("${dubbo.registry}")\n    private String registry;\n\n    @Bean\n    public RegistryConfig registryConfig() {\n        return new RegistryConfig(registry);\n    }\n}\n')])])]),a("h3",{attrs:{id:"apigateway"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#apigateway"}},[t._v("#")]),t._v(" APIGateway")]),t._v(" "),a("p",[t._v("APIGateway 基于 SpringCloud zuul 向外暴露 REST 接口。\n配置文件：")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("zuul:\n  routes:\n    course:\n      path: /course/**\n      url: http://localhost:8080/course-web/course/\n    user:\n      path: /user/**\n      url: http://localhost:8080/course-web/user/\n    message:\n      path: /message/**\n      url: http://localhost:8080/course-web/message/\n")])])]),a("h3",{attrs:{id:"构建-docker-镜像"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#构建-docker-镜像"}},[t._v("#")]),t._v(" 构建 docker 镜像")]),t._v(" "),a("p",[t._v("对各服务模块进行打包后编写 Dockerfile：")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("FROM openjdk:8-jre-slim\nLABEL "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("maintainer")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wch wch@163.com"')]),t._v("\n\nCOPY target/course-web-1.0-SNAPSHOT.jar /course-web.jar\n\nENTRYPOINT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"java"')]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-jar"')]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/course-web.jar"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("h3",{attrs:{id:"编写-docker-compose-文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编写-docker-compose-文件"}},[t._v("#")]),t._v(" 编写 docker-compose 文件")]),t._v(" "),a("p",[t._v("各镜像构建完成后编写 docker-compose 文件来方便编排 docker 服务。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("version: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3'")]),t._v("\n\nservices:\n  zookeeper:\n    image: zookeeper:3.4.13\n    networks:\n      - rpc-bridge\n\n  redis:\n    image: redis:latest\n    command:\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--appendonly yes"')]),t._v("\n    volumes:\n      - d:/docker/redis:/data\n    networks:\n      - component-bridge\n\n  mysql:\n    image: mysql:5.7\n    environment:\n      MYSQL_ROOT_PASSWORD: admin\n      MYSQL_ROOT_HOST: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%"')]),t._v("\n    volumes:\n      - d:/docker/mysql/data:/var/lib/mysql\n      - d:/docker/mysql/conf/my.cnf:/etc/mysql/my.cnf\n    networks:\n      - data-bridge\n\n  thrift-server:\n    image: course-thrift-server:1.0\n    links:\n      - mysql\n    command:\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--spring.profiles.active=prd"')]),t._v("\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--rpc.thrift.port=8081"')]),t._v("\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--mysql.address=mysql:3306"')]),t._v("\n    networks:\n      - rpc-bridge\n      - data-bridge\n\n  dubbo-server:\n    image: course-dubbo-server:1.0\n    links:\n      - zookeeper\n      - mysql\n    command:\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--spring.profiles.active=prd"')]),t._v("\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--dubbo.port=8083"')]),t._v("\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--registry.address=zookeeper:2181"')]),t._v("\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--mysql.address=mysql:3306"')]),t._v("\n    networks:\n      - rpc-bridge\n      - data-bridge\n\n  web:\n    image: course-web:1.0\n    links:\n      - redis\n      - zookeeper\n      - thrift-server\n    volumes:\n      - d:/docker/app/logs/course-web:/var/app/logs/course-web\n    command:\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--spring.profiles.active=prd"')]),t._v("\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--server.port=8080"')]),t._v("\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--thrift.service.user.host=thrift-server"')]),t._v("\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--thrift.service.user.port=8081"')]),t._v("\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--redis.host=redis"')]),t._v("\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--redis.port=6379"')]),t._v("\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--registry.address=zookeeper:2181"')]),t._v("\n    networks:\n      - rpc-bridge\n      - component-bridge\n      - net-bridge\n\n  api-gateway:\n    image: course-api-gateway:1.0\n    links:\n      - web\n    command:\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--spring.profiles.active=prd"')]),t._v("\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--server.port=80"')]),t._v("\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--web.host=web"')]),t._v("\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--web.port=8080"')]),t._v("\n    ports:\n      - "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(":80\n    networks:\n      - net-bridge\n\nnetworks:\n  net-bridge:\n    driver: bridge\n  component-bridge:\n    driver: bridge\n  data-bridge:\n    driver: bridge\n  rpc-bridge:\n    driver: bridge\n")])])]),a("h3",{attrs:{id:"运行和管理-docker-服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#运行和管理-docker-服务"}},[t._v("#")]),t._v(" 运行和管理 docker 服务")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启动")]),t._v("\ndocker-compose up -d\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 对dubbo-server进行扩容")]),t._v("\ndocker-compose up --scale dubbo-server"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" -d\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 关闭并删除所有容器")]),t._v("\ndocker-compose down\n")])])]),a("h3",{attrs:{id:"故障"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#故障"}},[t._v("#")]),t._v(" 故障")]),t._v(" "),a("h4",{attrs:{id:"docker-for-windows-暴露连接端口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-for-windows-暴露连接端口"}},[t._v("#")]),t._v(" Docker for Windows 暴露连接端口")]),t._v(" "),a("p",[t._v("本地使用 Docker for Windows，运行 docker version 命令，客户端报错，需要勾选 "),a("code",[t._v("Expose daemon on tcp://localhost:2375 without TLS")]),t._v("。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/microservice/DockerforWindows%E6%9A%B4%E9%9C%B2%E8%BF%9E%E6%8E%A5%E7%AB%AF%E5%8F%A3.png",alt:"Docker for Windows暴露连接端口"}})]),t._v(" "),a("h4",{attrs:{id:"docker-for-windows-共享本地硬盘设置不生效"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-for-windows-共享本地硬盘设置不生效"}},[t._v("#")]),t._v(" Docker for Windows 共享本地硬盘设置不生效")]),t._v(" "),a("p",[t._v("修改本地共享安全策略后选择共享给 Docker 的硬盘。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/microservice/Docker%E6%9C%AC%E5%9C%B0%E5%85%B1%E4%BA%AB%E5%AE%89%E5%85%A8%E8%AE%BE%E7%BD%AE.png",alt:"Docker本地共享安全设置.png"}})]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/microservice/Docker%E9%80%89%E6%8B%A9%E5%85%B1%E4%BA%AB%E6%9C%AC%E5%9C%B0%E7%A1%AC%E7%9B%98.png",alt:"Docker选择共享本地硬盘.png"}})]),t._v(" "),a("h4",{attrs:{id:"mysql-默认禁止远程连接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql-默认禁止远程连接"}},[t._v("#")]),t._v(" MySQL 默认禁止远程连接")]),t._v(" "),a("p",[t._v("MySQL 默认禁止远程连接，需要配置 docker 容器连接用户的远程连接权限。")]),t._v(" "),a("ul",[a("li",[t._v("安装的 mysql")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("grant all privileges on *.* to "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'root'")]),t._v("@"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%'")]),t._v(" identified by "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pwd'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nflush privileges"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看指定用户是否改为不限制IP登录")]),t._v("\nSELECT user, "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v(" FROM mysql.user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("ul",[a("li",[t._v("docker 提供的 mysql 镜像\ndocker 启动参数中使用-e MYSQL_ROOT_HOST=%")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("docker run -d -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MYSQL_ROOT_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("pass -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MYSQL_ROOT_HOST")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("% -p "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3307")]),t._v(":3306 -v d:/docker/mysql/conf/my.cnf:/etc/mysql/my.cnf -v d:/docker/mysql/data:/var/lib/mysql --name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("mysql mysql:5.7\n")])])]),a("h4",{attrs:{id:"redis-windows-默认绑定本地"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis-windows-默认绑定本地"}},[t._v("#")]),t._v(" redis-windows 默认绑定本地")]),t._v(" "),a("p",[t._v("在 redis 配置文件中，配置 bind 127.0.0.1 表示 redis 限制本地连接，windows 版本默认是开启的，docker 容器进行连接时需要注释此配置、")]),t._v(" "),a("h4",{attrs:{id:"redis-设置密码错误"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis-设置密码错误"}},[t._v("#")]),t._v(" redis 设置密码错误")]),t._v(" "),a("p",[t._v("拉取的 redis 镜像默认没有配置密码，若配置文件中填写了密码进行连接会保错。在上 docker 版本的配置文件中通过配置默认值，即：")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("spring.redis.password"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n")])])]),a("p",[t._v("来覆盖密码配置。")]),t._v(" "),a("h4",{attrs:{id:"mysql-容器-ssl-连接错误"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql-容器-ssl-连接错误"}},[t._v("#")]),t._v(" mysql 容器 ssl 连接错误")]),t._v(" "),a("p",[t._v("使用 java 客户端连接 mysql 容器出错，useSSL 参数修改为 false。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("jdbc:mysql://"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${mysql.address}")]),t._v("/test?useUnicode"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("characterEncoding")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("utf8"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("useSSL")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("false\n")])])])])}),[],!1,null,null,null);s.default=r.exports}}]);